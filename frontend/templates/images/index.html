{% extends "base.html" %}

{% block title %}镜像管理 - {{ super() }}{% endblock %}

{% block page_header %}
<h1 class="page-title">
    <i class="fas fa-compact-disc"></i>
    镜像管理
</h1>
<div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2">
        <button type="button" class="btn btn-primary" onclick="showCreateImageModal()">
            <i class="fas fa-plus me-1"></i>上传镜像
        </button>
    </div>
    <div class="btn-group me-2">
        <button type="button" class="btn btn-outline-secondary" onclick="refreshImages()">
            <i class="fas fa-sync-alt me-1"></i>刷新
        </button>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-info" onclick="showStatisticsModal()">
            <i class="fas fa-chart-bar me-1"></i>统计
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- 集群选择和统计面板 -->
<div class="row mb-3">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <label class="form-label">选择集群</label>
                <select class="form-select" id="clusterSelect" onchange="onClusterChange()">
                    <option value="">加载中...</option>
                </select>
            </div>
        </div>
    </div>
    <div class="col-md-9">
        <div class="card">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-3">
                        <h6 class="text-primary">总镜像</h6>
                        <h4 id="totalImagesCount">0</h4>
                    </div>
                    <div class="col-3">
                        <h6 class="text-success">激活</h6>
                        <h4 id="activeImagesCount">0</h4>
                    </div>
                    <div class="col-3">
                        <h6 class="text-info">公开</h6>
                        <h4 id="publicImagesCount">0</h4>
                    </div>
                    <div class="col-3">
                        <h6 class="text-warning">总大小</h6>
                        <h6 id="totalSize">0 B</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 过滤器面板 -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-2">
                <label class="form-label">状态</label>
                <select class="form-select" id="statusFilter">
                    <option value="">全部状态</option>
                    <option value="active">激活</option>
                    <option value="queued">排队中</option>
                    <option value="saving">保存中</option>
                    <option value="deleted">已删除</option>
                    <option value="error">错误</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">可见性</label>
                <select class="form-select" id="visibilityFilter">
                    <option value="">全部可见性</option>
                    <option value="private">私有</option>
                    <option value="public">公开</option>
                    <option value="shared">共享</option>
                    <option value="community">社区</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">磁盘格式</label>
                <select class="form-select" id="diskFormatFilter">
                    <option value="">全部格式</option>
                    <option value="qcow2">QCOW2</option>
                    <option value="raw">RAW</option>
                    <option value="vmdk">VMDK</option>
                    <option value="iso">ISO</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">搜索</label>
                <input type="text" class="form-control" id="nameSearch" placeholder="搜索镜像名称或ID...">
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="button" class="btn btn-outline-primary" onclick="applyFilters()">
                        <i class="fas fa-search me-1"></i>搜索
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 镜像列表 -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>状态</th>
                        <th>大小</th>
                        <th>格式</th>
                        <th>可见性</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="imagesTableBody">
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <div class="mt-2">加载镜像列表...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 分页 -->
        <nav aria-label="镜像列表分页" id="paginationNav" style="display: none;">
            <ul class="pagination justify-content-center" id="paginationList">
            </ul>
        </nav>
    </div>
</div>

<!-- 上传镜像模态框 -->
<div class="modal fade" id="createImageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cloud-upload-alt me-2"></i>上传镜像
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createImageForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <!-- 上传方式选择 -->
                    <div class="mb-3">
                        <label class="form-label">上传方式</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="uploadType" id="uploadTypeUrl" value="url" checked>
                            <label class="btn btn-outline-primary" for="uploadTypeUrl">
                                <i class="fas fa-link me-1"></i>URL上传
                            </label>
                            <input type="radio" class="btn-check" name="uploadType" id="uploadTypeFile" value="file">
                            <label class="btn btn-outline-primary" for="uploadTypeFile">
                                <i class="fas fa-file-upload me-1"></i>文件上传
                            </label>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- 基本信息 -->
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">基本信息</h6>
                            <div class="mb-3">
                                <label for="imageName" class="form-label">镜像名称 *</label>
                                <input type="text" class="form-control" id="imageName" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="imageDescription" class="form-label">描述</label>
                                <textarea class="form-control" id="imageDescription" name="description" rows="2"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="imageVisibility" class="form-label">可见性</label>
                                <select class="form-select" id="imageVisibility" name="visibility">
                                    <option value="private">私有</option>
                                    <option value="shared">共享</option>
                                    <option value="public">公开</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- 技术参数 -->
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">技术参数</h6>
                            <div class="mb-3">
                                <label for="diskFormat" class="form-label">磁盘格式</label>
                                <select class="form-select" id="diskFormat" name="disk_format">
                                    <option value="qcow2">QCOW2 (推荐)</option>
                                    <option value="raw">RAW</option>
                                    <option value="vmdk">VMDK</option>
                                    <option value="iso">ISO</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="containerFormat" class="form-label">容器格式</label>
                                <select class="form-select" id="containerFormat" name="container_format">
                                    <option value="bare">Bare (推荐)</option>
                                    <option value="ovf">OVF</option>
                                    <option value="ova">OVA</option>
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <label for="minDisk" class="form-label">最小磁盘 (GB)</label>
                                    <input type="number" class="form-control" id="minDisk" name="min_disk" value="0" min="0">
                                </div>
                                <div class="col-6">
                                    <label for="minRam" class="form-label">最小内存 (MB)</label>
                                    <input type="number" class="form-control" id="minRam" name="min_ram" value="0" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- URL上传 -->
                    <div id="urlUploadSection">
                        <hr>
                        <h6 class="fw-bold mb-3">镜像源</h6>
                        <div class="mb-3">
                            <label for="imageUrl" class="form-label">镜像URL *</label>
                            <input type="url" class="form-control" id="imageUrl" name="image_url" placeholder="https://example.com/image.qcow2">
                            <div class="form-text">支持HTTP/HTTPS协议的镜像文件直链</div>
                        </div>
                    </div>
                    
                    <!-- 文件上传 -->
                    <div id="fileUploadSection" style="display: none;">
                        <hr>
                        <h6 class="fw-bold mb-3">文件选择</h6>
                        <div class="mb-3">
                            <label for="imageFile" class="form-label">镜像文件 *</label>
                            <input type="file" class="form-control" id="imageFile" name="image_file" accept=".qcow2,.raw,.vmdk,.iso,.img" onchange="validateFileSize(this)">
                            <div class="form-text">支持的格式: .qcow2, .raw, .vmdk, .iso, .img</div>
                            <div class="mt-2" id="fileInfo" style="display: none;">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    文件大小: <span id="fileSize"></span> | 
                                    预计上传时间: <span id="estimatedTime"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 高级选项 -->
                    <hr>
                    <h6 class="fw-bold mb-3">高级选项</h6>
                    <div class="mb-3">
                        <label for="imageTags" class="form-label">标签</label>
                        <input type="text" class="form-control" id="imageTags" name="tags" placeholder="tag1,tag2,tag3">
                        <div class="form-text">多个标签用逗号分隔</div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="imageProtected" name="protected">
                        <label class="form-check-label" for="imageProtected">
                            保护镜像（防止意外删除）
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary" id="uploadBtn">
                        <i class="fas fa-upload me-1"></i>开始上传
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 镜像详情模态框 -->
<div class="modal fade" id="imageDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>镜像详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="imageDetailContent">
                <!-- 镜像详情将通过JavaScript填充 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 上传进度模态框 -->
<div class="modal fade" id="uploadProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cloud-upload-alt me-2"></i>镜像上传中
                </h5>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">上传中...</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">上传进度</label>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             id="uploadProgressBar"
                             style="width: 0%" 
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100">0%</div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">当前状态</label>
                    <div class="alert alert-info mb-0" id="uploadStatus">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="uploadStatusText">准备上传...</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">镜像信息</label>
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">镜像名称:</small><br>
                                    <strong id="uploadImageName">-</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">文件格式:</small><br>
                                    <strong id="uploadImageFormat">-</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="cancelUploadBtn" onclick="cancelUpload()">
                    <i class="fas fa-times me-1"></i>取消上传
                </button>
                <button type="button" class="btn btn-success" id="uploadCompleteBtn" style="display: none;" onclick="closeUploadModal()">
                    <i class="fas fa-check me-1"></i>完成
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 统计信息模态框 -->
<div class="modal fade" id="statisticsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-bar me-2"></i>镜像统计
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="statisticsContent">
                <!-- 统计信息将通过JavaScript填充 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<style>
    /* 上传进度条动画增强 */
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite, progress-bar-glow 2s ease-in-out infinite alternate;
    }
    
    @keyframes progress-bar-glow {
        0% { box-shadow: 0 0 5px rgba(37, 99, 235, 0.4); }
        100% { box-shadow: 0 0 20px rgba(37, 99, 235, 0.8); }
    }
    
    /* 文件信息卡片样式 */
    #fileInfo {
        background: rgba(37, 99, 235, 0.05);
        border: 1px solid rgba(37, 99, 235, 0.1);
        border-radius: 0.375rem;
        padding: 0.5rem;
    }
    
    /* 上传模态框样式优化 */
    #uploadProgressModal .modal-content {
        border: none;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    
    #uploadProgressModal .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    
    /* 状态图标动画 */
    .fa-spinner {
        animation: fa-spin 1s infinite linear;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let currentClusterId = null;
    let currentPage = 1;
    let currentFilters = {};
    let currentUploadXhr = null;  // 用于取消上传
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        loadClusters();
        initEventListeners();
    });
    
    // 初始化事件监听器
    function initEventListeners() {
        // 上传方式切换
        document.querySelectorAll('input[name="uploadType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const urlSection = document.getElementById('urlUploadSection');
                const fileSection = document.getElementById('fileUploadSection');
                
                if (this.value === 'url') {
                    urlSection.style.display = 'block';
                    fileSection.style.display = 'none';
                    document.getElementById('imageUrl').required = true;
                    document.getElementById('imageFile').required = false;
                } else {
                    urlSection.style.display = 'none';
                    fileSection.style.display = 'block';
                    document.getElementById('imageUrl').required = false;
                    document.getElementById('imageFile').required = true;
                }
            });
        });
        
        // 创建镜像表单提交
        document.getElementById('createImageForm').addEventListener('submit', handleCreateImage);
    }
    
    // 加载集群列表
    async function loadClusters() {
        try {
            const response = await fetch('/api/clusters');
            const data = await response.json();
            
            if (data.success && data.data) {
                const select = document.getElementById('clusterSelect');
                select.innerHTML = '<option value="">请选择集群</option>';
                
                let firstConnectedCluster = null;
                
                data.data.forEach(cluster => {
                    const option = document.createElement('option');
                    option.value = cluster.id;
                    option.textContent = `${cluster.name} (${cluster.connection_status})`;
                    
                    if (cluster.connection_status !== 'connected') {
                        option.disabled = true;
                        option.textContent += ' - 连接失败';
                    } else if (!firstConnectedCluster) {
                        firstConnectedCluster = cluster;
                    }
                    
                    select.appendChild(option);
                });
                
                // 自动选择第一个可用集群
                if (firstConnectedCluster) {
                    select.value = firstConnectedCluster.id;
                    currentClusterId = firstConnectedCluster.id;
                    onClusterChange();
                }
            } else {
                showAlert('加载集群列表失败', 'danger');
            }
        } catch (error) {
            console.error('Error loading clusters:', error);
            showAlert('加载集群列表时发生错误', 'danger');
        }
    }
    
    // 集群选择变化
    function onClusterChange() {
        const select = document.getElementById('clusterSelect');
        const selectedValue = select.value;
        currentClusterId = selectedValue ? parseInt(selectedValue) : null;
        
        if (currentClusterId) {
            loadImages();
            loadStatistics();
        } else {
            clearImagesList();
            clearStatistics();
        }
    }
    
    // 加载镜像列表
    async function loadImages() {
        if (!currentClusterId) return;
        
        try {
            showLoading(true);
            
            const params = new URLSearchParams({
                cluster_id: currentClusterId,
                page: currentPage,
                per_page: 20,
                ...currentFilters
            });
            
            const response = await fetch(`/api/images?${params}`);
            const data = await response.json();
            
            if (data.success) {
                renderImagesTable(data.data);
                renderPagination(data.page, data.total_pages, data.total);
            } else {
                showAlert('加载镜像列表失败: ' + data.error, 'danger');
                clearImagesList();
            }
        } catch (error) {
            console.error('Error loading images:', error);
            showAlert('加载镜像列表时发生错误', 'danger');
            clearImagesList();
        } finally {
            showLoading(false);
        }
    }
    
    // 渲染镜像表格
    function renderImagesTable(images) {
        const tbody = document.getElementById('imagesTableBody');
        
        if (!images || images.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="fas fa-compact-disc fa-3x mb-3 opacity-25"></i><br>
                        暂无镜像数据
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = images.map(image => {
            const statusBadge = getStatusBadge(image.status);
            const visibilityBadge = getVisibilityBadge(image.visibility);
            const protectedIcon = image.protected ? '<i class="fas fa-shield-alt text-warning ms-1" title="受保护"></i>' : '';
            
            return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-compact-disc text-primary me-2"></i>
                            <div>
                                <div class="fw-bold">${image.name}${protectedIcon}</div>
                                <small class="text-muted">${image.id}</small>
                            </div>
                        </div>
                    </td>
                    <td>${statusBadge}</td>
                    <td>${image.size_readable}</td>
                    <td>
                        <small class="badge bg-secondary">${image.disk_format.toUpperCase()}</small>
                        <br>
                        <small class="text-muted">${image.container_format}</small>
                    </td>
                    <td>${visibilityBadge}</td>
                    <td>
                        <small>${image.created_at || 'N/A'}</small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="showImageDetail('${image.id}')" title="详情">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="downloadImage('${image.id}')" title="下载">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="editImage('${image.id}')" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteImage('${image.id}', '${image.name}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    // 获取状态徽章
    function getStatusBadge(status) {
        const statusMap = {
            'active': 'bg-success',
            'queued': 'bg-info', 
            'saving': 'bg-warning',
            'deleted': 'bg-secondary',
            'error': 'bg-danger',
            'killed': 'bg-dark'
        };
        
        const badgeClass = statusMap[status] || 'bg-secondary';
        return `<span class="badge ${badgeClass}">${status.toUpperCase()}</span>`;
    }
    
    // 获取可见性徽章
    function getVisibilityBadge(visibility) {
        const visibilityMap = {
            'private': 'bg-secondary',
            'public': 'bg-success',
            'shared': 'bg-info',
            'community': 'bg-warning'
        };
        
        const badgeClass = visibilityMap[visibility] || 'bg-secondary';
        const labelMap = {
            'private': '私有',
            'public': '公开',
            'shared': '共享',
            'community': '社区'
        };
        
        const label = labelMap[visibility] || visibility;
        return `<span class="badge ${badgeClass}">${label}</span>`;
    }
    
    // 渲染分页
    function renderPagination(currentPage, totalPages, totalItems) {
        const nav = document.getElementById('paginationNav');
        const list = document.getElementById('paginationList');
        
        if (totalPages <= 1) {
            nav.style.display = 'none';
            return;
        }
        
        nav.style.display = 'block';
        
        let html = '';
        
        // 上一页
        if (currentPage > 1) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage - 1})">&laquo; 上一页</a></li>`;
        }
        
        // 页码
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            const activeClass = i === currentPage ? 'active' : '';
            html += `<li class="page-item ${activeClass}"><a class="page-link" href="#" onclick="changePage(${i})">${i}</a></li>`;
        }
        
        // 下一页
        if (currentPage < totalPages) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页 &raquo;</a></li>`;
        }
        
        list.innerHTML = html;
    }
    
    // 换页
    function changePage(page) {
        currentPage = page;
        loadImages();
    }
    
    // 应用过滤器
    function applyFilters() {
        currentFilters = {
            status: document.getElementById('statusFilter').value,
            visibility: document.getElementById('visibilityFilter').value,
            disk_format: document.getElementById('diskFormatFilter').value,
            name: document.getElementById('nameSearch').value
        };
        
        // 过滤掉空值
        Object.keys(currentFilters).forEach(key => {
            if (!currentFilters[key]) {
                delete currentFilters[key];
            }
        });
        
        currentPage = 1;
        loadImages();
    }
    
    // 刷新镜像列表
    function refreshImages() {
        if (!currentClusterId) {
            showAlert('请先选择一个集群', 'warning');
            return;
        }
        
        currentPage = 1;
        loadImages();
        loadStatistics();
    }
    
    // 加载统计信息
    async function loadStatistics() {
        if (!currentClusterId) return;
        
        try {
            const response = await fetch(`/api/images/statistics?cluster_id=${currentClusterId}`);
            const data = await response.json();
            
            if (data.success) {
                updateStatisticsDisplay(data.data);
            }
        } catch (error) {
            console.error('Error loading statistics:', error);
        }
    }
    
    // 更新统计显示
    function updateStatisticsDisplay(stats) {
        document.getElementById('totalImagesCount').textContent = stats.total_count;
        document.getElementById('activeImagesCount').textContent = stats.active_count;
        document.getElementById('publicImagesCount').textContent = stats.public_count;
        document.getElementById('totalSize').textContent = stats.total_size_readable;
    }
    
    // 清空统计显示
    function clearStatistics() {
        document.getElementById('totalImagesCount').textContent = '0';
        document.getElementById('activeImagesCount').textContent = '0';
        document.getElementById('publicImagesCount').textContent = '0';
        document.getElementById('totalSize').textContent = '0 B';
    }
    
    // 显示创建镜像模态框
    function showCreateImageModal() {
        if (!currentClusterId) {
            showAlert('请先选择一个集群', 'warning');
            return;
        }
        
        document.getElementById('createImageForm').reset();
        document.getElementById('uploadTypeUrl').checked = true;
        document.getElementById('uploadTypeUrl').dispatchEvent(new Event('change'));
        
        const modal = new bootstrap.Modal(document.getElementById('createImageModal'));
        modal.show();
    }
    
    // 处理创建镜像
    async function handleCreateImage(event) {
        event.preventDefault();
        
        // 禁用上传按钮，防止重复提交
        const uploadBtn = document.getElementById('uploadBtn');
        const originalBtnContent = uploadBtn.innerHTML;
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>准备上传...';
        
        const formData = new FormData(event.target);
        formData.append('cluster_id', currentClusterId);
        
        const uploadType = formData.get('uploadType');
        formData.append('upload_type', uploadType);
        
        // 验证表单
        if (!formData.get('name').trim()) {
            showAlert('请输入镜像名称', 'warning');
            resetUploadButton(uploadBtn, originalBtnContent);
            return;
        }
        
        if (uploadType === 'url' && !formData.get('image_url').trim()) {
            showAlert('请输入镜像URL', 'warning');
            resetUploadButton(uploadBtn, originalBtnContent);
            return;
        }
        
        if (uploadType === 'file' && !formData.get('image_file').name) {
            showAlert('请选择镜像文件', 'warning');
            resetUploadButton(uploadBtn, originalBtnContent);
            return;
        }
        
        // 获取镜像信息用于进度显示
        const imageName = formData.get('name');
        const diskFormat = formData.get('disk_format');
        
        // 显示进度条
        showUploadProgress(imageName, diskFormat);
        
        // 关闭创建模态框并重置按钮
        bootstrap.Modal.getInstance(document.getElementById('createImageModal')).hide();
        resetUploadButton(uploadBtn, originalBtnContent);
        
        try {
            const xhr = new XMLHttpRequest();
            currentUploadXhr = xhr;  // 存储引用用于取消
            
            // 设置超时时间 (30分钟，对于大文件上传)
            xhr.timeout = 30 * 60 * 1000; // 30分钟
            
            // 设置上传进度监听
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    updateUploadProgress(percentComplete, '上传文件中...');
                }
            });
            
            // 设置请求完成监听
            xhr.addEventListener('load', function() {
                if (xhr.status === 200) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            updateUploadProgress(100, '上传完成！镜像正在处理中...');
                            completeUpload(true, '镜像上传成功');
                            setTimeout(() => {
                                loadImages();
                                loadStatistics();
                            }, 2000);
                        } else {
                            completeUpload(false, '镜像上传失败: ' + data.error);
                        }
                    } catch (e) {
                        completeUpload(false, '服务器响应解析错误');
                    }
                } else if (xhr.status === 413) {
                    completeUpload(false, '文件过大：请选择小于50GB的镜像文件，或使用URL上传方式');
                } else if (xhr.status === 0) {
                    completeUpload(false, '网络连接中断：请检查网络连接并重试');
                } else {
                    let errorMessage = '服务器错误: ' + xhr.status;
                    if (xhr.status === 502) errorMessage = '服务器暂时不可用，请稍后重试';
                    if (xhr.status === 504) errorMessage = '服务器响应超时，请检查网络连接';
                    completeUpload(false, errorMessage);
                }
            });
            
            // 设置错误监听
            xhr.addEventListener('error', function() {
                completeUpload(false, '网络连接错误：请检查网络连接并重试');
            });
            
            // 设置超时监听
            xhr.addEventListener('timeout', function() {
                completeUpload(false, '上传超时：文件过大或网络较慢，建议使用URL上传方式');
            });
            
            // 发送请求
            xhr.open('POST', '/api/images');
            xhr.send(formData);
            
        } catch (error) {
            console.error('Error creating image:', error);
            completeUpload(false, '镜像上传时发生错误: ' + error.message);
        }
    }
    
    // 显示上传进度
    function showUploadProgress(imageName, diskFormat) {
        // 确保spinner显示
        const spinner = document.querySelector('#uploadProgressModal .spinner-border');
        const progressBar = document.getElementById('uploadProgressBar');
        
        if (spinner) {
            spinner.style.display = 'block';
        }
        
        // 确保进度条动画开启
        progressBar.classList.add('progress-bar-animated');
        progressBar.classList.add('progress-bar-striped');
        
        // 重置进度条
        updateUploadProgress(0, '准备上传...');
        
        // 设置镜像信息
        document.getElementById('uploadImageName').textContent = imageName;
        document.getElementById('uploadImageFormat').textContent = diskFormat.toUpperCase();
        
        // 重置按钮状态
        document.getElementById('cancelUploadBtn').style.display = 'inline-block';
        document.getElementById('uploadCompleteBtn').style.display = 'none';
        
        // 显示进度模态框
        const progressModal = new bootstrap.Modal(document.getElementById('uploadProgressModal'));
        progressModal.show();
        
        // 模拟初始进度
        setTimeout(() => updateUploadProgress(5, '验证镜像信息...'), 500);
        setTimeout(() => updateUploadProgress(10, '连接到OpenStack...'), 1000);
    }
    
    // 更新上传进度
    function updateUploadProgress(percent, status) {
        const progressBar = document.getElementById('uploadProgressBar');
        const statusText = document.getElementById('uploadStatusText');
        const spinner = document.querySelector('#uploadProgressModal .spinner-border');
        
        progressBar.style.width = percent + '%';
        progressBar.setAttribute('aria-valuenow', percent);
        progressBar.textContent = percent + '%';
        
        if (status) {
            statusText.textContent = status;
        }
        
        // 更新状态颜色和动画
        const statusAlert = document.getElementById('uploadStatus');
        if (percent === 100) {
            // 上传完成，停止所有动画
            statusAlert.className = 'alert alert-success mb-0';
            statusAlert.querySelector('i').className = 'fas fa-check-circle me-2';
            
            // 停止顶部转圈动画
            if (spinner) {
                spinner.style.display = 'none';
            }
            
            // 停止进度条动画
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.remove('progress-bar-striped');
            
        } else if (percent > 0) {
            statusAlert.className = 'alert alert-info mb-0';
            statusAlert.querySelector('i').className = 'fas fa-spinner fa-spin me-2';
            
            // 确保动画正在运行
            if (spinner) {
                spinner.style.display = 'block';
            }
            
            // 确保进度条动画正在运行
            progressBar.classList.add('progress-bar-animated');
            progressBar.classList.add('progress-bar-striped');
        }
    }
    
    // 完成上传
    function completeUpload(success, message) {
        // 清理XMLHttpRequest引用
        currentUploadXhr = null;
        
        const statusAlert = document.getElementById('uploadStatus');
        const statusText = document.getElementById('uploadStatusText');
        const cancelBtn = document.getElementById('cancelUploadBtn');
        const completeBtn = document.getElementById('uploadCompleteBtn');
        const spinner = document.querySelector('#uploadProgressModal .spinner-border');
        const progressBar = document.getElementById('uploadProgressBar');
        
        // 停止所有动画
        if (spinner) {
            spinner.style.display = 'none';
        }
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.remove('progress-bar-striped');
        
        if (success) {
            statusAlert.className = 'alert alert-success mb-0';
            statusAlert.querySelector('i').className = 'fas fa-check-circle me-2';
            updateUploadProgress(100, message);
        } else {
            statusAlert.className = 'alert alert-danger mb-0';
            statusAlert.querySelector('i').className = 'fas fa-exclamation-triangle me-2';
            statusText.textContent = message;
        }
        
        // 更新按钮状态
        cancelBtn.style.display = 'none';
        completeBtn.style.display = 'inline-block';
        
        // 显示全局提示
        showAlert(message, success ? 'success' : 'danger');
    }
    
    // 取消上传
    function cancelUpload() {
        if (confirm('确定要取消上传吗？已上传的部分将会丢失。')) {
            // 中止当前上传请求
            if (currentUploadXhr) {
                currentUploadXhr.abort();
                currentUploadXhr = null;
            }
            
            // 停止所有动画
            const spinner = document.querySelector('#uploadProgressModal .spinner-border');
            const progressBar = document.getElementById('uploadProgressBar');
            
            if (spinner) {
                spinner.style.display = 'none';
            }
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.remove('progress-bar-striped');
            
            // 更新进度条状态
            updateUploadProgress(0, '上传已取消');
            const statusAlert = document.getElementById('uploadStatus');
            statusAlert.className = 'alert alert-warning mb-0';
            statusAlert.querySelector('i').className = 'fas fa-times-circle me-2';
            
            // 显示取消按钮，隐藏完成按钮
            document.getElementById('cancelUploadBtn').style.display = 'none';
            document.getElementById('uploadCompleteBtn').style.display = 'inline-block';
            
            showAlert('上传已取消', 'info');
        }
    }
    
    // 关闭上传模态框
    function closeUploadModal() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('uploadProgressModal'));
        if (modal) {
            modal.hide();
        }
    }
    
    // 重置上传按钮
    function resetUploadButton(button, originalContent) {
        button.disabled = false;
        button.innerHTML = originalContent;
    }
    
    // 验证文件大小并显示信息
    function validateFileSize(input) {
        const fileInfo = document.getElementById('fileInfo');
        const fileSizeSpan = document.getElementById('fileSize');
        const estimatedTimeSpan = document.getElementById('estimatedTime');
        
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const fileSizeBytes = file.size;
            const fileSizeMB = fileSizeBytes / (1024 * 1024);
            const fileSizeGB = fileSizeMB / 1024;
            
            // 格式化文件大小显示
            let sizeText;
            if (fileSizeGB >= 1) {
                sizeText = fileSizeGB.toFixed(2) + ' GB';
            } else {
                sizeText = fileSizeMB.toFixed(2) + ' MB';
            }
            
            // 估算上传时间（假设平均上传速度为10MB/s）
            const estimatedSeconds = fileSizeMB / 10;
            let timeText;
            if (estimatedSeconds > 3600) {
                timeText = Math.round(estimatedSeconds / 3600) + ' 小时';
            } else if (estimatedSeconds > 60) {
                timeText = Math.round(estimatedSeconds / 60) + ' 分钟';
            } else {
                timeText = Math.round(estimatedSeconds) + ' 秒';
            }
            
            fileSizeSpan.textContent = sizeText;
            estimatedTimeSpan.textContent = timeText;
            fileInfo.style.display = 'block';
            
            // 文件大小警告 (按大小递减顺序检查)
            if (fileSizeGB > 50) {
                showAlert('错误：文件大小超过50GB限制，请使用URL上传方式', 'danger');
                input.value = ''; // 清除文件选择
                fileInfo.style.display = 'none';
                return;
            } else if (fileSizeGB > 20) {
                showAlert('警告：文件非常大(' + sizeText + ')，建议使用URL上传方式，上传速度更快', 'warning');
            } else if (fileSizeGB > 5) {
                showAlert('提示：文件较大(' + sizeText + ')，上传可能需要' + timeText + '，请保持网络连接稳定', 'info');
            }
            
        } else {
            fileInfo.style.display = 'none';
        }
    }
    
    // 显示镜像详情
    async function showImageDetail(imageId) {
        try {
            const response = await fetch(`/api/images/${imageId}?cluster_id=${currentClusterId}`);
            const data = await response.json();
            
            if (data.success) {
                renderImageDetail(data.data);
                const modal = new bootstrap.Modal(document.getElementById('imageDetailModal'));
                modal.show();
            } else {
                showAlert('获取镜像详情失败: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Error loading image detail:', error);
            showAlert('加载镜像详情时发生错误', 'danger');
        }
    }
    
    // 渲染镜像详情
    function renderImageDetail(image) {
        const content = document.getElementById('imageDetailContent');
        const protectedIcon = image.protected ? '<i class="fas fa-shield-alt text-warning ms-2"></i>' : '';
        const tags = image.tags && image.tags.length > 0 
            ? image.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')
            : '<span class="text-muted">无标签</span>';
            
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="fw-bold mb-3">基本信息</h6>
                    <table class="table table-sm">
                        <tr><td class="fw-bold">名称:</td><td>${image.name}${protectedIcon}</td></tr>
                        <tr><td class="fw-bold">ID:</td><td><code>${image.id}</code></td></tr>
                        <tr><td class="fw-bold">状态:</td><td>${getStatusBadge(image.status)}</td></tr>
                        <tr><td class="fw-bold">可见性:</td><td>${getVisibilityBadge(image.visibility)}</td></tr>
                        <tr><td class="fw-bold">描述:</td><td>${image.description || '无描述'}</td></tr>
                        <tr><td class="fw-bold">拥有者:</td><td>${image.owner || 'N/A'}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6 class="fw-bold mb-3">技术参数</h6>
                    <table class="table table-sm">
                        <tr><td class="fw-bold">大小:</td><td>${image.size_readable}</td></tr>
                        <tr><td class="fw-bold">磁盘格式:</td><td>${image.disk_format.toUpperCase()}</td></tr>
                        <tr><td class="fw-bold">容器格式:</td><td>${image.container_format}</td></tr>
                        <tr><td class="fw-bold">最小磁盘:</td><td>${image.min_disk} GB</td></tr>
                        <tr><td class="fw-bold">最小内存:</td><td>${image.min_ram} MB</td></tr>
                        <tr><td class="fw-bold">校验和:</td><td><small>${image.checksum || 'N/A'}</small></td></tr>
                    </table>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6 class="fw-bold mb-3">时间信息</h6>
                    <table class="table table-sm">
                        <tr><td class="fw-bold">创建时间:</td><td>${image.created_at || 'N/A'}</td></tr>
                        <tr><td class="fw-bold">更新时间:</td><td>${image.updated_at || 'N/A'}</td></tr>
                    </table>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6 class="fw-bold mb-3">标签</h6>
                    <div>${tags}</div>
                </div>
            </div>
        `;
    }
    
    // 下载镜像
    async function downloadImage(imageId) {
        if (!confirm('确定要下载这个镜像吗？大型镜像可能需要较长时间。')) {
            return;
        }
        
        try {
            showAlert('正在准备下载...', 'info');
            
            const response = await fetch(`/api/images/${imageId}/download?cluster_id=${currentClusterId}`);
            
            if (response.ok) {
                // 创建下载链接
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `image_${imageId}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert('镜像下载已开始', 'success');
            } else {
                const data = await response.json();
                showAlert('下载失败: ' + (data.error || '未知错误'), 'danger');
            }
        } catch (error) {
            console.error('Error downloading image:', error);
            showAlert('下载镜像时发生错误', 'danger');
        }
    }
    
    // 编辑镜像
    function editImage(imageId) {
        showAlert('编辑功能开发中...', 'info');
    }
    
    // 删除镜像
    async function deleteImage(imageId, imageName) {
        if (!confirm(`确定要删除镜像 "${imageName}" 吗？此操作不可撤销。`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/images/${imageId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ cluster_id: currentClusterId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('镜像删除成功', 'success');
                loadImages();
                loadStatistics();
            } else {
                showAlert('删除失败: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Error deleting image:', error);
            showAlert('删除镜像时发生错误', 'danger');
        }
    }
    
    // 显示统计模态框
    async function showStatisticsModal() {
        if (!currentClusterId) {
            showAlert('请先选择一个集群', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/api/images/statistics?cluster_id=${currentClusterId}`);
            const data = await response.json();
            
            if (data.success) {
                renderStatistics(data.data);
                const modal = new bootstrap.Modal(document.getElementById('statisticsModal'));
                modal.show();
            } else {
                showAlert('获取统计信息失败: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Error loading statistics:', error);
            showAlert('加载统计信息时发生错误', 'danger');
        }
    }
    
    // 渲染统计信息
    function renderStatistics(stats) {
        const content = document.getElementById('statisticsContent');
        
        // 状态分布
        const statusChart = Object.entries(stats.status_distribution)
            .map(([status, count]) => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>${getStatusBadge(status)}</span>
                    <span class="fw-bold">${count}</span>
                </div>
            `).join('');
        
        // 可见性分布
        const visibilityChart = Object.entries(stats.visibility_distribution)
            .map(([visibility, count]) => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>${getVisibilityBadge(visibility)}</span>
                    <span class="fw-bold">${count}</span>
                </div>
            `).join('');
        
        // 格式分布
        const formatChart = Object.entries(stats.format_distribution)
            .map(([format, count]) => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-secondary">${format.toUpperCase()}</span>
                    <span class="fw-bold">${count}</span>
                </div>
            `).join('');
        
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-body text-center">
                            <h3 class="text-primary">${stats.total_count}</h3>
                            <p class="text-muted mb-0">总镜像数</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-body text-center">
                            <h3 class="text-info">${stats.total_size_readable}</h3>
                            <p class="text-muted mb-0">总存储空间</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <h6 class="fw-bold mb-3">状态分布</h6>
                    ${statusChart || '<p class="text-muted">无数据</p>'}
                </div>
                <div class="col-md-4">
                    <h6 class="fw-bold mb-3">可见性分布</h6>
                    ${visibilityChart || '<p class="text-muted">无数据</p>'}
                </div>
                <div class="col-md-4">
                    <h6 class="fw-bold mb-3">格式分布</h6>
                    ${formatChart || '<p class="text-muted">无数据</p>'}
                </div>
            </div>
        `;
    }
    
    // 清空镜像列表
    function clearImagesList() {
        document.getElementById('imagesTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">请选择集群</td>
            </tr>
        `;
        document.getElementById('paginationNav').style.display = 'none';
    }
    
    // 显示/隐藏加载动画
    function showLoading(show) {
        if (show) {
            document.getElementById('imagesTableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <div class="mt-2">加载镜像列表...</div>
                    </td>
                </tr>
            `;
        }
    }
    
    // 显示提示信息
    function showAlert(message, type = 'info') {
        // 移除现有提示
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const content = document.querySelector('main');
        content.insertBefore(alertDiv, content.firstChild);
        
        // 自动隐藏
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}集群管理 - {{ super() }}{% endblock %}

{% block extra_css %}
<style>
    .cluster-card {
        transition: transform 0.2s;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
    }
    .cluster-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .status-badge {
        font-size: 0.8rem;
    }
    .connection-test-btn {
        opacity: 0;
        transition: opacity 0.3s;
    }
    .cluster-card:hover .connection-test-btn {
        opacity: 1;
    }
    .resource-stats {
        font-size: 0.85rem;
    }
    .cluster-actions {
        opacity: 0;
        transition: opacity 0.3s;
    }
    .cluster-card:hover .cluster-actions {
        opacity: 1;
    }
    .stats-overview {
        margin-bottom: 2rem;
    }
    .loading-spinner {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-server me-2"></i>集群管理
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        {% if current_user.has_role(['super_admin', 'admin']) %}
        <div class="btn-group me-2">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClusterModal">
                <i class="fas fa-plus me-1"></i>添加集群
            </button>
        </div>
        {% endif %}
        <div class="btn-group">
            <button type="button" class="btn btn-outline-secondary" onclick="refreshAllClusters()">
                <i class="fas fa-sync-alt me-1"></i>刷新状态
            </button>
        </div>
    </div>
</div>

<!-- 加载指示器 -->
<div id="loadingIndicator" class="text-center py-4 loading-spinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">加载中...</span>
    </div>
    <p class="mt-2 text-muted">正在加载集群信息...</p>
</div>

<!-- 集群状态概览 -->
<div class="stats-overview">
    <div class="row" id="statsOverview">
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">总集群数</h5>
                    <h2 class="mb-0" id="totalClusters">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">已连接</h5>
                    <h2 class="mb-0" id="connectedClusters">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">连接失败</h5>
                    <h2 class="mb-0" id="failedClusters">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">未知状态</h5>
                    <h2 class="mb-0" id="unknownClusters">-</h2>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 集群列表 -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>集群列表
        </h5>
    </div>
    <div class="card-body">
        <div id="clustersContainer" class="row">
            <!-- 集群卡片将通过JavaScript动态加载 -->
        </div>
    </div>
</div>

<!-- 分页 -->
<nav class="mt-4" id="paginationContainer" style="display: none;">
    <ul class="pagination justify-content-center" id="pagination">
    </ul>
</nav>

<!-- 添加集群模态框 -->
{% if current_user.has_role(['super_admin', 'admin']) %}
<div class="modal fade" id="addClusterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加集群</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addClusterForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">集群名称 *</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">区域名称</label>
                                <input type="text" class="form-control" name="region_name" value="RegionOne">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">描述</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">认证URL *</label>
                        <input type="url" class="form-control" name="auth_url" required 
                               placeholder="http://keystone.example.com:5000/v3">
                    </div>
                    
                    <hr>
                    <h6>认证信息</h6>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">用户名 *</label>
                                <input type="text" class="form-control" name="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">密码 *</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="addClusterPassword" name="password" required>
                                    <button class="btn btn-outline-secondary" type="button" id="toggleAddPassword" onclick="togglePasswordVisibility('addClusterPassword', 'toggleAddPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">项目名称 *</label>
                                <input type="text" class="form-control" name="project_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">用户域</label>
                                <input type="text" class="form-control" name="user_domain_name" value="Default">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">项目域</label>
                        <input type="text" class="form-control" name="project_domain_name" value="Default">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createCluster()">创建集群</button>
            </div>
        </div>
    </div>
</div>
<!-- 编辑集群模态框 -->
<div class="modal fade" id="editClusterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑集群</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editClusterForm">
                    <input type="hidden" id="editClusterId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">集群名称 *</label>
                                <input type="text" class="form-control" id="editClusterName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">区域名称</label>
                                <input type="text" class="form-control" id="editClusterRegion" name="region_name" value="RegionOne">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">描述</label>
                        <textarea class="form-control" id="editClusterDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">认证URL *</label>
                        <input type="url" class="form-control" id="editClusterAuthUrl" name="auth_url" required 
                               placeholder="http://keystone.example.com:5000/v3">
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editClusterActive" name="is_active">
                        <label class="form-check-label" for="editClusterActive">启用集群</label>
                    </div>
                    
                    <hr>
                    <h6>认证信息 <small class="text-muted">(留空则保持不变)</small></h6>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">用户名</label>
                                <input type="text" class="form-control" id="editClusterUsername" name="username">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">密码</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="editClusterPassword" name="password">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleEditPassword" onclick="togglePasswordVisibility('editClusterPassword', 'toggleEditPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">项目名称</label>
                                <input type="text" class="form-control" id="editClusterProject" name="project_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">用户域</label>
                                <input type="text" class="form-control" id="editClusterUserDomain" name="user_domain_name" value="Default">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">项目域</label>
                        <input type="text" class="form-control" id="editClusterProjectDomain" name="project_domain_name" value="Default">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateCluster()">更新集群</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 删除确认模态框 -->
{% if current_user.has_role(['super_admin', 'admin']) %}
<div class="modal fade" id="deleteClusterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>删除集群
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">您确定要删除集群 <strong id="deleteClusterName"></strong> 吗？</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    此操作不可逆，请谨慎操作。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteCluster()">确认删除</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let currentClusterId = null;
    let isLoading = false;

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        showLoading(true);
        Promise.all([
            loadClusters(),
            loadClustersStatus()
        ]).finally(() => {
            showLoading(false);
        });
    });

    function showLoading(show) {
        const indicator = document.getElementById('loadingIndicator');
        const content = document.getElementById('clustersContainer').parentElement.parentElement;
        const stats = document.getElementById('statsOverview');
        
        if (show) {
            indicator.style.display = 'block';
            content.style.opacity = '0.5';
            stats.style.opacity = '0.5';
        } else {
            indicator.style.display = 'none';
            content.style.opacity = '1';
            stats.style.opacity = '1';
        }
        isLoading = show;
    }

    // 加载集群列表
    async function loadClusters(page = 1) {
        try {
            const response = await fetch(`/api/clusters?page=${page}&per_page=6`);
            const data = await response.json();
            
            if (data.success) {
                renderClusters(data.data);
                renderPagination(data.pagination);
                currentPage = page;
            } else {
                showAlert('加载集群列表失败: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Error loading clusters:', error);
            showAlert('网络错误，请检查连接', 'danger');
        }
    }

    // 渲染集群卡片
    function renderClusters(clusters) {
        const container = document.getElementById('clustersContainer');
        
        if (clusters.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-server fa-3x mb-3"></i>
                        <p>暂无集群，点击"添加集群"开始。</p>
                    </div>
                </div>
            `;
            return;
        }

        container.innerHTML = clusters.map(cluster => `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card cluster-card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-server me-2"></i>
                            ${cluster.name}
                        </h6>
                        <div class="cluster-actions">
                            <button class="btn btn-sm btn-outline-primary connection-test-btn me-1" 
                                    onclick="testConnection(${cluster.id})" title="测试连接">
                                <i class="fas fa-wifi"></i>
                            </button>
                            {% if current_user.has_role(['super_admin', 'admin']) %}
                            <div class="dropdown d-inline">
                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editCluster(${cluster.id})">
                                        <i class="fas fa-edit me-2"></i>编辑
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="viewResources(${cluster.id})">
                                        <i class="fas fa-chart-bar me-2"></i>资源统计
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteCluster(${cluster.id}, '${cluster.name}')">
                                        <i class="fas fa-trash me-2"></i>删除
                                    </a></li>
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <span class="badge status-badge ${getStatusClass(cluster.connection_status)}">
                                ${getStatusText(cluster.connection_status)}
                            </span>
                        </div>
                        
                        ${cluster.description ? `<p class="text-muted small mb-2">${cluster.description}</p>` : ''}
                        
                        <div class="resource-stats">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="text-primary">
                                        <i class="fas fa-server"></i><br>
                                        <strong>${cluster.instance_count || 0}</strong><br>
                                        <small>实例</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-success">
                                        <i class="fas fa-hdd"></i><br>
                                        <strong>${cluster.volume_count || 0}</strong><br>
                                        <small>卷</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-info">
                                        <i class="fas fa-network-wired"></i><br>
                                        <strong>${cluster.network_count || 0}</strong><br>
                                        <small>网络</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            ${cluster.last_connection_test ? 
                                '测试: ' + formatTime(cluster.last_connection_test) : 
                                '未测试连接'
                            }
                        </small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // 加载集群状态概览
    async function loadClustersStatus() {
        try {
            const response = await fetch('/api/clusters/status');
            const data = await response.json();
            
            if (data.success) {
                const status = data.data;
                document.getElementById('totalClusters').textContent = status.total;
                document.getElementById('connectedClusters').textContent = status.connected;
                document.getElementById('failedClusters').textContent = status.failed;
                document.getElementById('unknownClusters').textContent = status.unknown;
            }
        } catch (error) {
            console.error('Error loading status:', error);
        }
    }

    // 辅助函数
    function getStatusClass(status) {
        const classes = {
            'connected': 'bg-success',
            'failed': 'bg-danger', 
            'unknown': 'bg-secondary'
        };
        return classes[status] || 'bg-secondary';
    }

    function getStatusText(status) {
        const texts = {
            'connected': '已连接',
            'failed': '连接失败',
            'unknown': '未知'
        };
        return texts[status] || '未知';
    }

    function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString('zh-CN');
    }

    // 测试连接
    async function testConnection(clusterId) {
        if (isLoading) return;
        
        const btn = event.target.closest('button');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        try {
            const response = await fetch(`/api/clusters/${clusterId}/test`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                showAlert(`连接测试成功: ${data.message}`, 'success');
                // 延迟重新加载以显示更新后的状态
                setTimeout(() => {
                    loadClusters(currentPage);
                    loadClustersStatus();
                }, 1000);
            } else {
                showAlert(`连接测试失败: ${data.error}`, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('测试连接时发生错误', 'danger');
        } finally {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }

    // 刷新所有集群状态
    function refreshAllClusters() {
        if (isLoading) return;
        
        showLoading(true);
        Promise.all([
            loadClusters(currentPage),
            loadClustersStatus()
        ]).finally(() => {
            showLoading(false);
            showAlert('已刷新集群状态', 'info');
        });
    }

    {% if current_user.has_role(['super_admin', 'admin']) %}
    // 创建集群
    async function createCluster() {
        const form = document.getElementById('addClusterForm');
        const formData = new FormData(form);
        
        const clusterData = {
            name: formData.get('name'),
            description: formData.get('description'),
            auth_url: formData.get('auth_url'),
            region_name: formData.get('region_name'),
            credentials: {
                username: formData.get('username'),
                password: formData.get('password'),
                project_name: formData.get('project_name'),
                user_domain_name: formData.get('user_domain_name'),
                project_domain_name: formData.get('project_domain_name')
            }
        };

        try {
            const response = await fetch('/api/clusters', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(clusterData)
            });
            const data = await response.json();

            if (data.success) {
                showAlert(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('addClusterModal')).hide();
                form.reset();
                loadClusters();
                loadClustersStatus();
            } else {
                showAlert(data.error, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('创建集群时发生错误', 'danger');
        }
    }
    {% endif %}

    // 编辑集群
    async function editCluster(clusterId) {
        try {
            const response = await fetch(`/api/clusters/${clusterId}`);
            const data = await response.json();

            if (data.success) {
                const cluster = data.data;
                
                // 填充表单
                document.getElementById('editClusterId').value = cluster.id;
                document.getElementById('editClusterName').value = cluster.name;
                document.getElementById('editClusterDescription').value = cluster.description || '';
                document.getElementById('editClusterAuthUrl').value = cluster.auth_url;
                document.getElementById('editClusterRegion').value = cluster.region_name;
                document.getElementById('editClusterActive').checked = cluster.is_active;

                // 如果包含凭据信息，填充所有字段包括密码
                if (cluster.credentials) {
                    document.getElementById('editClusterUsername').value = cluster.credentials.username || '';
                    document.getElementById('editClusterPassword').value = cluster.credentials.password || '';
                    document.getElementById('editClusterProject').value = cluster.credentials.project_name || '';
                    document.getElementById('editClusterUserDomain').value = cluster.credentials.user_domain_name || 'Default';
                    document.getElementById('editClusterProjectDomain').value = cluster.credentials.project_domain_name || 'Default';
                }

                // 重置密码输入框的显示状态为隐藏
                const passwordInput = document.getElementById('editClusterPassword');
                const toggleButton = document.getElementById('toggleEditPassword');
                const icon = toggleButton.querySelector('i');
                passwordInput.type = 'password';
                icon.className = 'fas fa-eye';

                new bootstrap.Modal(document.getElementById('editClusterModal')).show();
            } else {
                showAlert('获取集群信息失败: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('获取集群信息时发生错误', 'danger');
        }
    }

    async function updateCluster() {
        const clusterId = document.getElementById('editClusterId').value;
        const form = document.getElementById('editClusterForm');
        const formData = new FormData(form);

        const updateData = {
            name: formData.get('name'),
            description: formData.get('description'),
            auth_url: formData.get('auth_url'),
            region_name: formData.get('region_name'),
            is_active: document.getElementById('editClusterActive').checked
        };

        // 只在有值的情况下更新凭据
        const username = formData.get('username');
        const password = formData.get('password');
        const projectName = formData.get('project_name');
        
        if (username || password || projectName) {
            updateData.credentials = {};
            if (username) updateData.credentials.username = username;
            if (password) updateData.credentials.password = password;
            if (projectName) updateData.credentials.project_name = projectName;
            updateData.credentials.user_domain_name = formData.get('user_domain_name');
            updateData.credentials.project_domain_name = formData.get('project_domain_name');
        }

        try {
            const response = await fetch(`/api/clusters/${clusterId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            });
            const data = await response.json();

            if (data.success) {
                showAlert(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('editClusterModal')).hide();
                loadClusters();
                loadClustersStatus();
            } else {
                showAlert(data.error, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('更新集群时发生错误', 'danger');
        }
    }

    {% if current_user.has_role(['super_admin', 'admin']) %}
    // 删除集群
    function deleteCluster(clusterId, clusterName) {
        currentClusterId = clusterId;
        document.getElementById('deleteClusterName').textContent = clusterName;
        new bootstrap.Modal(document.getElementById('deleteClusterModal')).show();
    }

    async function confirmDeleteCluster() {
        try {
            const response = await fetch(`/api/clusters/${currentClusterId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                showAlert(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('deleteClusterModal')).hide();
                loadClusters();
                loadClustersStatus();
            } else {
                showAlert(data.error, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('删除集群时发生错误', 'danger');
        }
    }
    {% endif %}

    // 查看资源统计
    async function viewResources(clusterId) {
        try {
            const response = await fetch(`/api/clusters/${clusterId}/resources`);
            const data = await response.json();
            
            if (data.success) {
                const resources = data.data;
                const message = `
                    <strong>${resources.cluster_name}</strong> 资源统计：<br>
                    实例：${resources.summary.instances} 个<br>
                    卷：${resources.summary.volumes} 个<br>
                    存储总量：${resources.summary.total_volume_size} GB<br>
                    最后更新：${resources.last_updated ? formatTime(resources.last_updated) : '未知'}
                `;
                showAlert(message, 'info');
            } else {
                showAlert('获取资源统计失败: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('获取资源统计时发生错误', 'danger');
        }
    }

    // 显示警告消息
    function showAlert(message, type) {
        // 移除现有的alert
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const content = document.querySelector('main');
        content.insertBefore(alertDiv, content.firstChild);
        
        // 5秒后自动删除（除了info类型的alert）
        if (type !== 'info') {
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    }

    // 渲染分页
    function renderPagination(pagination) {
        const container = document.getElementById('paginationContainer');
        const ul = document.getElementById('pagination');

        if (pagination.pages <= 1) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'block';
        ul.innerHTML = '';

        // 上一页
        if (pagination.has_prev) {
            ul.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadClusters(${pagination.page - 1})">上一页</a></li>`;
        }

        // 页码
        for (let i = 1; i <= pagination.pages; i++) {
            const active = i === pagination.page ? 'active' : '';
            ul.innerHTML += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="loadClusters(${i})">${i}</a></li>`;
        }

        // 下一页
        if (pagination.has_next) {
            ul.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadClusters(${pagination.page + 1})">下一页</a></li>`;
        }
    }

    // 切换密码可见性
    function togglePasswordVisibility(inputId, buttonId) {
        const passwordInput = document.getElementById(inputId);
        const toggleButton = document.getElementById(buttonId);
        const icon = toggleButton.querySelector('i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            passwordInput.type = 'password';
            icon.className = 'fas fa-eye';
        }
    }
</script>
{% endblock %}
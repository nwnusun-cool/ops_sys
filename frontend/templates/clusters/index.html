{% extends "base.html" %}

{% block title %}集群管理 - {{ super() }}{% endblock %}

{% block extra_css %}
<style>
    .cluster-card {
        transition: transform 0.2s;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
    }
    .cluster-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .status-badge {
        font-size: 0.8rem;
    }
    .connection-test-btn {
        opacity: 0;
        transition: opacity 0.3s;
    }
    .cluster-card:hover .connection-test-btn {
        opacity: 1;
    }
    .resource-stats {
        font-size: 0.85rem;
    }
    .cluster-actions {
        opacity: 0;
        transition: opacity 0.3s;
    }
    .cluster-card:hover .cluster-actions {
        opacity: 1;
    }
    .stats-overview {
        margin-bottom: 2rem;
    }
    .loading-spinner {
        display: none;
    }
    
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-server me-2"></i>集群管理
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        {% if current_user.has_role(['super_admin', 'admin']) %}
        <div class="btn-group me-2">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClusterModal">
                <i class="fas fa-plus me-1"></i>添加集群
            </button>
        </div>
        {% endif %}
        <div class="btn-group">
            <button type="button" class="btn btn-outline-secondary" onclick="refreshAllClusters()">
                <i class="fas fa-sync-alt me-1"></i>刷新状态
            </button>
        </div>
    </div>
</div>

<!-- 加载指示器 -->
<div id="loadingIndicator" class="text-center py-4 loading-spinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">加载中...</span>
    </div>
    <p class="mt-2 text-muted">正在加载集群信息...</p>
</div>

<!-- 集群状态概览 -->
<div class="stats-overview">
    <div class="row" id="statsOverview">
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">总集群数</h5>
                    <h2 class="mb-0" id="totalClusters">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">已连接</h5>
                    <h2 class="mb-0" id="connectedClusters">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">连接失败</h5>
                    <h2 class="mb-0" id="failedClusters">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">未知状态</h5>
                    <h2 class="mb-0" id="unknownClusters">-</h2>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 集群列表 -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>集群列表
        </h5>
    </div>
    <div class="card-body">
        <div id="clustersContainer" class="row">
            <!-- 集群卡片将通过JavaScript动态加载 -->
        </div>
    </div>
</div>

<!-- 分页 -->
<nav class="mt-4" id="paginationContainer" style="display: none;">
    <ul class="pagination justify-content-center" id="pagination">
    </ul>
</nav>

<!-- 添加集群模态框 -->
{% if current_user.has_role(['super_admin', 'admin']) %}
<div class="modal fade" id="addClusterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加集群</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addClusterForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">集群名称 *</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">区域名称</label>
                                <input type="text" class="form-control" name="region_name" value="RegionOne">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">描述</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">认证URL *</label>
                        <input type="url" class="form-control" name="auth_url" required 
                               placeholder="http://keystone.example.com:5000/v3">
                    </div>
                    
                    <hr>
                    <h6>认证信息</h6>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">用户名 *</label>
                                <input type="text" class="form-control" name="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">密码 *</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="addClusterPassword" name="password" required>
                                    <button class="btn btn-outline-secondary" type="button" id="toggleAddPassword" onclick="togglePasswordVisibility('addClusterPassword', 'toggleAddPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">项目名称 *</label>
                                <input type="text" class="form-control" name="project_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">用户域</label>
                                <input type="text" class="form-control" name="user_domain_name" value="Default">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">项目域</label>
                        <input type="text" class="form-control" name="project_domain_name" value="Default">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createCluster()">创建集群</button>
            </div>
        </div>
    </div>
</div>
<!-- 编辑集群模态框 -->
<div class="modal fade" id="editClusterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑集群</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editClusterForm">
                    <input type="hidden" id="editClusterId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">集群名称 *</label>
                                <input type="text" class="form-control" id="editClusterName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">区域名称</label>
                                <input type="text" class="form-control" id="editClusterRegion" name="region_name" value="RegionOne">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">描述</label>
                        <textarea class="form-control" id="editClusterDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">认证URL *</label>
                        <input type="url" class="form-control" id="editClusterAuthUrl" name="auth_url" required 
                               placeholder="http://keystone.example.com:5000/v3">
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editClusterActive" name="is_active">
                        <label class="form-check-label" for="editClusterActive">启用集群</label>
                    </div>
                    
                    <hr>
                    <h6>认证信息 <small class="text-muted">(留空则保持不变)</small></h6>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">用户名</label>
                                <input type="text" class="form-control" id="editClusterUsername" name="username">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">密码</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="editClusterPassword" name="password">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleEditPassword" onclick="togglePasswordVisibility('editClusterPassword', 'toggleEditPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">项目名称</label>
                                <input type="text" class="form-control" id="editClusterProject" name="project_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">用户域</label>
                                <input type="text" class="form-control" id="editClusterUserDomain" name="user_domain_name" value="Default">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">项目域</label>
                        <input type="text" class="form-control" id="editClusterProjectDomain" name="project_domain_name" value="Default">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateCluster()">更新集群</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 删除确认模态框 -->
{% if current_user.has_role(['super_admin', 'admin']) %}
<div class="modal fade" id="deleteClusterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>删除集群
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">您确定要删除集群 <strong id="deleteClusterName"></strong> 吗？</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    此操作不可逆，请谨慎操作。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteCluster()">确认删除</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 集群统计信息模态框 -->
<div class="modal fade" id="clusterStatisticsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-bar me-2"></i>集群统计信息
                    <small class="text-muted ms-2" id="statisticsClusterName"></small>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 加载状态 -->
                <div id="statisticsLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2 text-muted">正在收集统计数据...</p>
                </div>
                
                <!-- 统计内容 -->
                <div id="statisticsContent" style="display: none;">
                    <!-- 概览统计 -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-server fa-2x mb-2"></i>
                                    <h4 class="mb-0" id="statsTotalInstances">-</h4>
                                    <small>实例总数</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-hdd fa-2x mb-2"></i>
                                    <h4 class="mb-0" id="statsTotalVolumes">-</h4>
                                    <small>卷总数</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                    <h4 class="mb-0" id="statsTotalSnapshots">-</h4>
                                    <small>快照总数</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-network-wired fa-2x mb-2"></i>
                                    <h4 class="mb-0" id="statsTotalNetworks">-</h4>
                                    <small>网络总数</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 详细统计表格 -->
                    <div class="row">
                        <!-- 实例统计 -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-server me-2"></i>实例状态分布
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="instanceStatsContent">
                                        <p class="text-muted text-center">暂无数据</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 卷统计 -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-hdd me-2"></i>卷状态分布
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="volumeStatsContent">
                                        <p class="text-muted text-center">暂无数据</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 存储使用情况 -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-database me-2"></i>存储使用情况
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">卷存储总量</label>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" id="volumeStorageBar" style="width: 0%">
                                                <span id="volumeStorageText">0 GB</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">快照存储总量</label>
                                        <div class="progress">
                                            <div class="progress-bar bg-info" id="snapshotStorageBar" style="width: 0%">
                                                <span id="snapshotStorageText">0 GB</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">镜像存储总量</label>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" id="imageStorageBar" style="width: 0%">
                                                <span id="imageStorageText">0 GB</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 网络资源 -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-network-wired me-2"></i>网络资源统计
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="border rounded p-2 mb-2">
                                                <h5 class="text-primary mb-0" id="statsNetworkCount">-</h5>
                                                <small class="text-muted">网络</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="border rounded p-2 mb-2">
                                                <h5 class="text-success mb-0" id="statsRouterCount">-</h5>
                                                <small class="text-muted">路由器</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="border rounded p-2">
                                                <h5 class="text-info mb-0" id="statsFloatingIPCount">-</h5>
                                                <small class="text-muted">浮动IP</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="border rounded p-2">
                                                <h5 class="text-warning mb-0" id="statsSecurityGroupCount">-</h5>
                                                <small class="text-muted">安全组</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 集群健康状态 -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-heartbeat me-2"></i>集群健康状态
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <h6 class="text-muted">连接状态</h6>
                                            <p id="clusterConnectionStatus">
                                                <span class="badge bg-secondary">检测中...</span>
                                            </p>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="text-muted">最后更新</h6>
                                            <p id="clusterLastUpdated" class="text-muted">-</p>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="text-muted">数据收集时间</h6>
                                            <p id="statisticsTimestamp" class="text-muted">-</p>
                                        </div>
                                    </div>
                                    
                                    <!-- OpenStack服务状态 -->
                                    <div class="mt-3">
                                        <h6 class="text-muted">OpenStack服务状态</h6>
                                        <div class="row" id="serviceStatusContainer">
                                            <div class="col-md-3">
                                                <small class="text-muted">Nova (计算)</small><br>
                                                <span class="badge bg-secondary" id="novaStatus">未知</span>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">Cinder (存储)</small><br>
                                                <span class="badge bg-secondary" id="cinderStatus">未知</span>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">Neutron (网络)</small><br>
                                                <span class="badge bg-secondary" id="neutronStatus">未知</span>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">Glance (镜像)</small><br>
                                                <span class="badge bg-secondary" id="glanceStatus">未知</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 错误状态 -->
                <div id="statisticsError" style="display: none;" class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5>无法获取统计数据</h5>
                    <p class="text-muted" id="statisticsErrorMessage">请检查集群连接状态</p>
                    <button class="btn btn-outline-primary" onclick="retryLoadStatistics()">
                        <i class="fas fa-sync-alt me-1"></i>重试
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="refreshStatistics()">
                    <i class="fas fa-sync-alt me-1"></i>刷新数据
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let currentClusterId = null;
    let isLoading = false;
    let currentStatisticsClusterId = null;

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        showLoading(true);
        Promise.all([
            loadClusters(),
            loadClustersStatus()
        ]).finally(() => {
            showLoading(false);
        });
    });

    function showLoading(show) {
        const indicator = document.getElementById('loadingIndicator');
        const content = document.getElementById('clustersContainer').parentElement.parentElement;
        const stats = document.getElementById('statsOverview');
        
        if (show) {
            indicator.style.display = 'block';
            content.style.opacity = '0.5';
            stats.style.opacity = '0.5';
        } else {
            indicator.style.display = 'none';
            content.style.opacity = '1';
            stats.style.opacity = '1';
        }
        isLoading = show;
    }

    // 加载集群列表
    async function loadClusters(page = 1) {
        try {
            const response = await fetch(`/api/clusters?page=${page}&per_page=6`);
            const data = await response.json();
            
            if (data.success) {
                renderClusters(data.data);
                renderPagination(data.pagination);
                currentPage = page;
            } else {
                showAlert('加载集群列表失败: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Error loading clusters:', error);
            showAlert('网络错误，请检查连接', 'danger');
        }
    }

    // 渲染集群卡片
    function renderClusters(clusters) {
        const container = document.getElementById('clustersContainer');
        
        if (clusters.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-server fa-3x mb-3"></i>
                        <p>暂无集群，点击"添加集群"开始。</p>
                    </div>
                </div>
            `;
            return;
        }

        // 检查用户权限
        const hasAdminRole = {{ 'true' if current_user.has_role(['super_admin', 'admin']) else 'false' }};

        container.innerHTML = clusters.map(cluster => `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card cluster-card h-100" data-cluster-id="${cluster.id}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-server me-2"></i>
                            ${cluster.name}
                        </h6>
                        <div class="cluster-actions">
                            <button class="btn btn-sm btn-outline-primary connection-test-btn me-1" 
                                    onclick="testConnection(${cluster.id})" title="测试连接">
                                <i class="fas fa-wifi"></i>
                            </button>
                            ${hasAdminRole ? `
                            <div class="dropdown d-inline">
                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editCluster(${cluster.id})">
                                        <i class="fas fa-edit me-2"></i>编辑
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="showClusterStatistics(${cluster.id})">
                                        <i class="fas fa-chart-bar me-2"></i>详细统计
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteCluster(${cluster.id}, '${cluster.name}')">
                                        <i class="fas fa-trash me-2"></i>删除
                                    </a></li>
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <span class="badge status-badge ${getStatusClass(cluster.connection_status)}">
                                ${getStatusText(cluster.connection_status)}
                            </span>
                        </div>
                        
                        ${cluster.description ? `<p class="text-muted small mb-2">${cluster.description}</p>` : ''}
                        
                        <div class="resource-stats">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="text-primary">
                                        <i class="fas fa-server"></i><br>
                                        <strong>${cluster.instance_count || 0}</strong><br>
                                        <small>实例</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-success">
                                        <i class="fas fa-hdd"></i><br>
                                        <strong>${cluster.volume_count || 0}</strong><br>
                                        <small>卷</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-info">
                                        <i class="fas fa-network-wired"></i><br>
                                        <strong>${cluster.network_count || 0}</strong><br>
                                        <small>网络</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            ${cluster.last_connection_test ? 
                                '测试: ' + formatTime(cluster.last_connection_test) : 
                                '未测试连接'
                            }
                        </small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // 加载集群状态概览
    async function loadClustersStatus() {
        try {
            const response = await fetch('/api/clusters/status');
            const data = await response.json();
            
            if (data.success) {
                const status = data.data;
                document.getElementById('totalClusters').textContent = status.total;
                document.getElementById('connectedClusters').textContent = status.connected;
                document.getElementById('failedClusters').textContent = status.failed;
                document.getElementById('unknownClusters').textContent = status.unknown;
            }
        } catch (error) {
            console.error('Error loading status:', error);
        }
    }

    // 辅助函数
    function getStatusClass(status) {
        const classes = {
            'connected': 'bg-success',
            'failed': 'bg-danger', 
            'unknown': 'bg-secondary'
        };
        return classes[status] || 'bg-secondary';
    }

    function getStatusText(status) {
        const texts = {
            'connected': '已连接',
            'failed': '连接失败',
            'unknown': '未知'
        };
        return texts[status] || '未知';
    }

    function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString('zh-CN');
    }

    // 测试连接
    async function testConnection(clusterId) {
        if (isLoading) return;
        
        const btn = event.target.closest('button');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        try {
            const response = await fetch(`/api/clusters/${clusterId}/test`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                showAlert(`连接测试成功: ${data.message}`, 'success');
                // 延迟重新加载以显示更新后的状态
                setTimeout(() => {
                    loadClusters(currentPage);
                    loadClustersStatus();
                }, 1000);
            } else {
                showAlert(`连接测试失败: ${data.error}`, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('测试连接时发生错误', 'danger');
        } finally {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }

    // 刷新所有集群状态
    function refreshAllClusters() {
        if (isLoading) return;
        
        showLoading(true);
        Promise.all([
            loadClusters(currentPage),
            loadClustersStatus()
        ]).finally(() => {
            showLoading(false);
            showAlert('已刷新集群状态', 'info');
        });
    }

    {% if current_user.has_role(['super_admin', 'admin']) %}
    // 创建集群
    async function createCluster() {
        const form = document.getElementById('addClusterForm');
        const formData = new FormData(form);
        
        const clusterData = {
            name: formData.get('name'),
            description: formData.get('description'),
            auth_url: formData.get('auth_url'),
            region_name: formData.get('region_name'),
            credentials: {
                username: formData.get('username'),
                password: formData.get('password'),
                project_name: formData.get('project_name'),
                user_domain_name: formData.get('user_domain_name'),
                project_domain_name: formData.get('project_domain_name')
            }
        };

        try {
            const response = await fetch('/api/clusters', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(clusterData)
            });
            const data = await response.json();

            if (data.success) {
                showAlert(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('addClusterModal')).hide();
                form.reset();
                loadClusters();
                loadClustersStatus();
            } else {
                showAlert(data.error, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('创建集群时发生错误', 'danger');
        }
    }
    {% endif %}

    // 编辑集群
    async function editCluster(clusterId) {
        try {
            const response = await fetch(`/api/clusters/${clusterId}`);
            const data = await response.json();

            if (data.success) {
                const cluster = data.data;
                
                // 填充表单
                document.getElementById('editClusterId').value = cluster.id;
                document.getElementById('editClusterName').value = cluster.name;
                document.getElementById('editClusterDescription').value = cluster.description || '';
                document.getElementById('editClusterAuthUrl').value = cluster.auth_url;
                document.getElementById('editClusterRegion').value = cluster.region_name;
                document.getElementById('editClusterActive').checked = cluster.is_active;

                // 如果包含凭据信息，填充所有字段包括密码
                if (cluster.credentials) {
                    document.getElementById('editClusterUsername').value = cluster.credentials.username || '';
                    document.getElementById('editClusterPassword').value = cluster.credentials.password || '';
                    document.getElementById('editClusterProject').value = cluster.credentials.project_name || '';
                    document.getElementById('editClusterUserDomain').value = cluster.credentials.user_domain_name || 'Default';
                    document.getElementById('editClusterProjectDomain').value = cluster.credentials.project_domain_name || 'Default';
                }

                // 重置密码输入框的显示状态为隐藏
                const passwordInput = document.getElementById('editClusterPassword');
                const toggleButton = document.getElementById('toggleEditPassword');
                const icon = toggleButton.querySelector('i');
                passwordInput.type = 'password';
                icon.className = 'fas fa-eye';

                new bootstrap.Modal(document.getElementById('editClusterModal')).show();
            } else {
                showAlert('获取集群信息失败: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('获取集群信息时发生错误', 'danger');
        }
    }

    async function updateCluster() {
        const clusterId = document.getElementById('editClusterId').value;
        const form = document.getElementById('editClusterForm');
        const formData = new FormData(form);

        const updateData = {
            name: formData.get('name'),
            description: formData.get('description'),
            auth_url: formData.get('auth_url'),
            region_name: formData.get('region_name'),
            is_active: document.getElementById('editClusterActive').checked
        };

        // 只在有值的情况下更新凭据
        const username = formData.get('username');
        const password = formData.get('password');
        const projectName = formData.get('project_name');
        
        if (username || password || projectName) {
            updateData.credentials = {};
            if (username) updateData.credentials.username = username;
            if (password) updateData.credentials.password = password;
            if (projectName) updateData.credentials.project_name = projectName;
            updateData.credentials.user_domain_name = formData.get('user_domain_name');
            updateData.credentials.project_domain_name = formData.get('project_domain_name');
        }

        try {
            const response = await fetch(`/api/clusters/${clusterId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            });
            const data = await response.json();

            if (data.success) {
                showAlert(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('editClusterModal')).hide();
                loadClusters();
                loadClustersStatus();
            } else {
                showAlert(data.error, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('更新集群时发生错误', 'danger');
        }
    }

    {% if current_user.has_role(['super_admin', 'admin']) %}
    // 删除集群
    function deleteCluster(clusterId, clusterName) {
        currentClusterId = clusterId;
        document.getElementById('deleteClusterName').textContent = clusterName;
        new bootstrap.Modal(document.getElementById('deleteClusterModal')).show();
    }

    async function confirmDeleteCluster() {
        try {
            const response = await fetch(`/api/clusters/${currentClusterId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                showAlert(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('deleteClusterModal')).hide();
                loadClusters();
                loadClustersStatus();
            } else {
                showAlert(data.error, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('删除集群时发生错误', 'danger');
        }
    }
    {% endif %}

    // 查看资源统计
    async function viewResources(clusterId) {
        try {
            const response = await fetch(`/api/clusters/${clusterId}/resources`);
            const data = await response.json();
            
            if (data.success) {
                const resources = data.data;
                const message = `
                    <strong>${resources.cluster_name}</strong> 资源统计：<br>
                    实例：${resources.summary.instances} 个<br>
                    卷：${resources.summary.volumes} 个<br>
                    存储总量：${resources.summary.total_volume_size} GB<br>
                    最后更新：${resources.last_updated ? formatTime(resources.last_updated) : '未知'}
                `;
                showAlert(message, 'info');
            } else {
                showAlert('获取资源统计失败: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('获取资源统计时发生错误', 'danger');
        }
    }

    // 显示警告消息
    function showAlert(message, type) {
        // 移除现有的alert
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const content = document.querySelector('main');
        content.insertBefore(alertDiv, content.firstChild);
        
        // 5秒后自动删除（除了info类型的alert）
        if (type !== 'info') {
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    }

    // 渲染分页
    function renderPagination(pagination) {
        const container = document.getElementById('paginationContainer');
        const ul = document.getElementById('pagination');

        if (pagination.pages <= 1) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'block';
        ul.innerHTML = '';

        // 上一页
        if (pagination.has_prev) {
            ul.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadClusters(${pagination.page - 1})">上一页</a></li>`;
        }

        // 页码
        for (let i = 1; i <= pagination.pages; i++) {
            const active = i === pagination.page ? 'active' : '';
            ul.innerHTML += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="loadClusters(${i})">${i}</a></li>`;
        }

        // 下一页
        if (pagination.has_next) {
            ul.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadClusters(${pagination.page + 1})">下一页</a></li>`;
        }
    }
    
    // 显示集群统计信息
    async function showClusterStatistics(clusterId) {
        currentStatisticsClusterId = clusterId;
        
        // 重置界面状态
        document.getElementById('statisticsLoading').style.display = 'block';
        document.getElementById('statisticsContent').style.display = 'none';
        document.getElementById('statisticsError').style.display = 'none';
        
        // 获取集群名称
        try {
            const clusterResponse = await fetch(`/api/clusters/${clusterId}`);
            const clusterData = await clusterResponse.json();
            if (clusterData.success) {
                document.getElementById('statisticsClusterName').textContent = clusterData.data.name;
            }
        } catch (error) {
            console.error('Error getting cluster name:', error);
        }
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('clusterStatisticsModal'));
        modal.show();
        
        // 加载统计数据
        await loadClusterStatistics(clusterId);
    }
    
    // 加载集群统计数据
    async function loadClusterStatistics(clusterId) {
        try {
            // 获取综合统计数据
            const response = await fetch(`/api/clusters/${clusterId}/resources`);
            const data = await response.json();
            
            // 检查数据是否可用
            if (!data.success) {
                throw new Error(data.error || '无法获取资源数据');
            }
            
            // 渲染统计数据
            renderClusterStatistics(data.data);
            
            // 显示内容，隐藏加载状态
            document.getElementById('statisticsLoading').style.display = 'none';
            document.getElementById('statisticsContent').style.display = 'block';
            
        } catch (error) {
            console.error('Error loading cluster statistics:', error);
            showStatisticsError(error.message);
        }
    }
    
    // 渲染集群统计数据
    function renderClusterStatistics(data) {
        const { summary, statistics } = data;
        
        // 基础统计数字
        document.getElementById('statsTotalInstances').textContent = summary.instances || 0;
        document.getElementById('statsTotalVolumes').textContent = summary.volumes || 0;
        document.getElementById('statsTotalSnapshots').textContent = summary.snapshots || 0;
        document.getElementById('statsTotalNetworks').textContent = summary.networks || 0;
        
        // 实例状态分布
        renderInstanceStatsFromData(statistics.instance_stats || {});
        
        // 卷状态分布  
        renderVolumeStatsFromData(statistics.volume_stats || {});
        
        // 存储使用情况
        renderStorageStatsFromSummary(summary);
        
        // 网络资源统计
        renderNetworkStatsFromData(statistics.network_stats || {});
        
        // 集群健康状态
        renderClusterHealth(data);
        
        // 服务状态（基于统计数据是否存在判断）
        const hasInstanceStats = Object.keys(statistics.instance_stats || {}).length > 0;
        const hasVolumeStats = Object.keys(statistics.volume_stats || {}).length > 0;
        const hasNetworkStats = Object.keys(statistics.network_stats || {}).length > 0;
        const hasImageStats = Object.keys(statistics.image_stats || {}).length > 0;
        renderServiceStatus(hasInstanceStats, hasVolumeStats, hasNetworkStats, hasImageStats);
        
        // 时间戳
        document.getElementById('statisticsTimestamp').textContent = data.last_updated ? 
            new Date(data.last_updated).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN');
    }
    
    // 渲染实例状态统计（原始函数保持兼容性）
    function renderInstanceStats(instances) {
        const statusCounts = {};
        instances.forEach(instance => {
            const status = instance.status;
            statusCounts[status] = (statusCounts[status] || 0) + 1;
        });
        renderInstanceStatsFromData(statusCounts, instances.length);
    }
    
    // 渲染实例状态统计（从数据对象）
    function renderInstanceStatsFromData(statusCounts, totalCount) {
        const container = document.getElementById('instanceStatsContent');
        
        if (!statusCounts || Object.keys(statusCounts).length === 0) {
            container.innerHTML = '<p class="text-muted text-center">暂无实例数据</p>';
            return;
        }
        
        const total = totalCount || Object.values(statusCounts).reduce((sum, count) => sum + count, 0);
        
        // 渲染状态分布
        let html = '';
        Object.entries(statusCounts).forEach(([status, count]) => {
            const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
            const statusClass = getInstanceStatusClass(status);
            
            html += `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>
                        <span class="badge ${statusClass}">${status}</span>
                    </span>
                    <span>
                        <strong>${count}</strong> 
                        <small class="text-muted">(${percentage}%)</small>
                    </span>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // 渲染卷状态统计（原始函数保持兼容性）
    function renderVolumeStats(volumes) {
        const statusCounts = {};
        volumes.forEach(volume => {
            const status = volume.status;
            statusCounts[status] = (statusCounts[status] || 0) + 1;
        });
        renderVolumeStatsFromData(statusCounts, volumes.length);
    }
    
    // 渲染卷状态统计（从数据对象）
    function renderVolumeStatsFromData(statusCounts, totalCount) {
        const container = document.getElementById('volumeStatsContent');
        
        if (!statusCounts || Object.keys(statusCounts).length === 0) {
            container.innerHTML = '<p class="text-muted text-center">暂无卷数据</p>';
            return;
        }
        
        const total = totalCount || Object.values(statusCounts).reduce((sum, count) => sum + count, 0);
        
        // 渲染状态分布
        let html = '';
        Object.entries(statusCounts).forEach(([status, count]) => {
            const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
            const statusClass = getVolumeStatusClass(status);
            
            html += `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>
                        <span class="badge ${statusClass}">${status}</span>
                    </span>
                    <span>
                        <strong>${count}</strong> 
                        <small class="text-muted">(${percentage}%)</small>
                    </span>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // 渲染存储使用情况（原始函数保持兼容性）
    function renderStorageStats(volumes, snapshots, images) {
        let volumeStorage = 0;
        let snapshotStorage = 0;
        let imageStorage = 0;
        
        volumes.forEach(volume => {
            volumeStorage += volume.size || 0;
        });
        
        snapshots.forEach(snapshot => {
            if (snapshot.type === 'volume') {
                snapshotStorage += snapshot.size || 0;
            } else {
                imageStorage += (snapshot.size || 0) / (1024 * 1024 * 1024);
            }
        });
        
        images.forEach(image => {
            imageStorage += (image.size || 0) / (1024 * 1024 * 1024);
        });
        
        renderStorageStatsFromSummary({
            total_volume_size: volumeStorage,
            total_snapshot_size: snapshotStorage,
            total_image_size: imageStorage
        });
    }
    
    // 渲染存储使用情况（从汇总数据）
    function renderStorageStatsFromSummary(summary) {
        const volumeStorage = summary.total_volume_size || 0;
        const snapshotStorage = summary.total_snapshot_size || 0;
        const imageStorage = summary.total_image_size || 0;
        
        const totalStorage = volumeStorage + snapshotStorage + imageStorage;
        const maxStorage = Math.max(totalStorage * 1.2, 100); // 假设最大存储容量
        
        // 更新进度条
        updateStorageBar('volumeStorageBar', 'volumeStorageText', volumeStorage, maxStorage);
        updateStorageBar('snapshotStorageBar', 'snapshotStorageText', snapshotStorage, maxStorage);
        updateStorageBar('imageStorageBar', 'imageStorageText', imageStorage, maxStorage);
    }
    
    // 更新存储进度条
    function updateStorageBar(barId, textId, value, maxValue) {
        const percentage = maxValue > 0 ? (value / maxValue) * 100 : 0;
        const bar = document.getElementById(barId);
        const text = document.getElementById(textId);
        
        bar.style.width = Math.min(percentage, 100) + '%';
        text.textContent = value.toFixed(1) + ' GB';
    }
    
    // 渲染网络资源统计（原始函数保持兼容性）
    function renderNetworkStats(networks) {
        const networkStats = {
            total: networks.length || 0,
            external: 0,
            internal: 0
        };
        
        networks.forEach(network => {
            if (network.router && network.router.external) {
                networkStats.external++;
            } else {
                networkStats.internal++;
            }
        });
        
        renderNetworkStatsFromData(networkStats);
    }
    
    // 渲染网络资源统计（从数据对象）
    function renderNetworkStatsFromData(networkStats) {
        document.getElementById('statsNetworkCount').textContent = networkStats.total || '-';
        document.getElementById('statsRouterCount').textContent = networkStats.external || '-';
        document.getElementById('statsFloatingIPCount').textContent = '-'; // 需要浮动IP API
        document.getElementById('statsSecurityGroupCount').textContent = '-'; // 需要安全组API
    }
    
    // 渲染集群健康状态
    function renderClusterHealth(data) {
        const statusElement = document.getElementById('clusterConnectionStatus');
        const lastUpdatedElement = document.getElementById('clusterLastUpdated');
        
        // 连接状态
        const connectionStatus = data.connection_status || 'unknown';
        const hasError = data.note || data.error_message;
        const statusClass = hasError ? 'bg-warning' : (connectionStatus === 'connected' ? 'bg-success' : 'bg-danger');
        const statusText = hasError ? '连接异常' : (connectionStatus === 'connected' ? '连接正常' : '连接失败');
        statusElement.innerHTML = `<span class="badge ${statusClass}">${statusText}</span>`;
        
        if (hasError) {
            const errorMessage = data.note || data.error_message;
            statusElement.innerHTML += `<br><small class="text-warning">${errorMessage}</small>`;
        }
        
        // 最后更新时间
        const lastConnectionTest = data.last_connection_test || data.last_updated;
        lastUpdatedElement.textContent = lastConnectionTest ? 
            formatTime(lastConnectionTest) : '未知';
    }
    
    // 渲染服务状态
    function renderServiceStatus(novaOk, cinderOk, neutronOk, glanceOk) {
        const updateServiceStatus = (elementId, isOk) => {
            const element = document.getElementById(elementId);
            element.className = `badge ${isOk ? 'bg-success' : 'bg-danger'}`;
            element.textContent = isOk ? '正常' : '异常';
        };
        
        updateServiceStatus('novaStatus', novaOk);
        updateServiceStatus('cinderStatus', cinderOk);
        updateServiceStatus('neutronStatus', neutronOk);
        updateServiceStatus('glanceStatus', glanceOk);
    }
    
    // 获取实例状态样式类
    function getInstanceStatusClass(status) {
        const classMap = {
            'ACTIVE': 'bg-success',
            'SHUTOFF': 'bg-secondary',
            'ERROR': 'bg-danger',
            'BUILDING': 'bg-warning',
            'PAUSED': 'bg-info',
            'SUSPENDED': 'bg-warning',
            'REBOOT': 'bg-warning'
        };
        return classMap[status] || 'bg-secondary';
    }
    
    // 获取卷状态样式类
    function getVolumeStatusClass(status) {
        const classMap = {
            'available': 'bg-success',
            'in-use': 'bg-primary',
            'error': 'bg-danger',
            'creating': 'bg-warning',
            'attaching': 'bg-info',
            'detaching': 'bg-info',
            'deleting': 'bg-secondary'
        };
        return classMap[status] || 'bg-secondary';
    }
    
    // 显示统计错误
    function showStatisticsError(message) {
        document.getElementById('statisticsLoading').style.display = 'none';
        document.getElementById('statisticsContent').style.display = 'none';
        document.getElementById('statisticsError').style.display = 'block';
        document.getElementById('statisticsErrorMessage').textContent = message;
    }
    
    // 重试加载统计数据
    function retryLoadStatistics() {
        if (currentStatisticsClusterId) {
            document.getElementById('statisticsError').style.display = 'none';
            document.getElementById('statisticsLoading').style.display = 'block';
            loadClusterStatistics(currentStatisticsClusterId);
        }
    }
    
    // 刷新统计数据
    function refreshStatistics() {
        if (currentStatisticsClusterId) {
            document.getElementById('statisticsContent').style.display = 'none';
            document.getElementById('statisticsLoading').style.display = 'block';
            loadClusterStatistics(currentStatisticsClusterId);
        }
    }

    // 切换密码可见性
    function togglePasswordVisibility(inputId, buttonId) {
        const passwordInput = document.getElementById(inputId);
        const toggleButton = document.getElementById(buttonId);
        const icon = toggleButton.querySelector('i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            passwordInput.type = 'password';
            icon.className = 'fas fa-eye';
        }
    }

</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}K8sé›†ç¾¤èŠ‚ç‚¹æ¦‚è§ˆ{% endblock %}

{% block extra_css %}
<style>
.cluster-section {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 2rem;
    overflow: hidden;
}

.cluster-header {
    background: #f8f9fa;
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    cursor: pointer;
    transition: background-color 0.2s;
}

.cluster-header:hover {
    background: #e9ecef;
}

.cluster-body {
    padding: 1rem;
}

.node-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
}

.node-mini-card {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 0.75rem;
    transition: transform 0.2s, box-shadow 0.2s;
}

.node-mini-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    cursor: pointer;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
}

.status-ready { background: #28a745; }
.status-notready { background: #dc3545; }
.status-unknown { background: #6c757d; }

.resource-mini-bar {
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
    margin-top: 2px;
}

.collapsed {
    display: none;
}

.cluster-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.stat-item {
    text-align: center;
    padding: 0.5rem;
    background: white;
    border: 1px solid #e3e6f0;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">K8sé›†ç¾¤èŠ‚ç‚¹æ¦‚è§ˆ</h1>
            <p class="text-muted mb-0">æŸ¥çœ‹æ‰€æœ‰K8sé›†ç¾¤çš„èŠ‚ç‚¹çŠ¶æ€</p>
        </div>
        <div>
            <button type="button" class="btn btn-outline-primary btn-sm mr-2" onclick="refreshAllData()">
                <i class="fas fa-sync-alt"></i> å…¨éƒ¨åˆ·æ–°
            </button>
            <a href="/k8s-clusters" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left"></i> è¿”å›K8sç®¡ç†
            </a>
        </div>
    </div>

    <!-- æ€»è§ˆç»Ÿè®¡ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                æ€»é›†ç¾¤æ•°
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-clusters">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-layer-group fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                æ€»èŠ‚ç‚¹æ•°
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-nodes">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-server fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                å°±ç»ªèŠ‚ç‚¹
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="ready-nodes">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                æ€»Podæ•°
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-pods">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-cubes fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é›†ç¾¤å’ŒèŠ‚ç‚¹åˆ—è¡¨ -->
    <div id="clusters-container">
        <!-- é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loading-section" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">åŠ è½½ä¸­...</span>
        </div>
        <p class="mt-3 text-muted">æ­£åœ¨åŠ è½½é›†ç¾¤å’ŒèŠ‚ç‚¹ä¿¡æ¯...</p>
    </div>

    <!-- ç¤ºä¾‹æ•°æ®æŒ‰é’® -->
    <div id="demo-section" class="text-center py-5" style="display: none;">
        <i class="fas fa-database fa-3x text-muted mb-3"></i>
        <h5>æš‚æ— æ•°æ®</h5>
        <p class="text-muted">æ²¡æœ‰æ‰¾åˆ°æ´»è·ƒçš„K8sé›†ç¾¤æˆ–èŠ‚ç‚¹æ•°æ®</p>
        <button class="btn btn-primary" onclick="loadDemoData()">
            <i class="fas fa-play"></i> åŠ è½½æ¼”ç¤ºæ•°æ®
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- K8sçŠ¶æ€ç®¡ç†å™¨ -->
<script src="{{ url_for('static', filename='js/k8s-state-manager.js') }}"></script>
<script>
// é¡µé¢åˆå§‹åŒ–
$(document).ready(function() {
    console.log('ğŸ“± K8sé›†ç¾¤èŠ‚ç‚¹æ¦‚è§ˆé¡µé¢åˆå§‹åŒ–');
    loadAllClustersNodes();
});

// åŠ è½½æ‰€æœ‰é›†ç¾¤çš„èŠ‚ç‚¹ä¿¡æ¯
function loadAllClustersNodes() {
    $('#loading-section').show();
    $('#demo-section').hide();
    
    // å…ˆè·å–æ‰€æœ‰é›†ç¾¤
    $.get('/api/k8s/clusters')
        .done(function(response) {
            console.log('âœ… é›†ç¾¤åˆ—è¡¨å“åº”:', response);
            
            if (response.success && response.data && response.data.length > 0) {
                loadNodesForClusters(response.data);
            } else {
                $('#loading-section').hide();
                $('#demo-section').show();
            }
        })
        .fail(function(xhr) {
            console.error('âŒ è·å–é›†ç¾¤åˆ—è¡¨å¤±è´¥:', xhr.status, xhr.statusText);
            $('#loading-section').hide();
            
            if (xhr.status === 401) {
                showError('è¯·å…ˆç™»å½•ç³»ç»Ÿ');
            } else {
                $('#demo-section').show();
            }
        });
}

// ä¸ºæ¯ä¸ªé›†ç¾¤åŠ è½½èŠ‚ç‚¹ä¿¡æ¯
function loadNodesForClusters(clusters) {
    let completedCount = 0;
    let allNodesData = [];
    
    const clustersContainer = $('#clusters-container');
    clustersContainer.empty();
    
    clusters.forEach(cluster => {
        // ä¸ºæ¯ä¸ªé›†ç¾¤è·å–èŠ‚ç‚¹ä¿¡æ¯
        const nodePromise = $.get(`/api/k8s/clusters/${cluster.id}/nodes`)
            .done(function(nodeResponse) {
                console.log(`âœ… é›†ç¾¤ ${cluster.name} èŠ‚ç‚¹å“åº”:`, nodeResponse);
                
                let nodes = [];
                if (nodeResponse.success && nodeResponse.data) {
                    nodes = nodeResponse.data;
                }
                
                allNodesData = allNodesData.concat(nodes);
                renderClusterSection(cluster, nodes);
            })
            .fail(function(xhr) {
                console.warn(`âš ï¸ é›†ç¾¤ ${cluster.name} èŠ‚ç‚¹è·å–å¤±è´¥:`, xhr.status);
                // å³ä½¿å¤±è´¥ä¹Ÿè¦æ¸²æŸ“é›†ç¾¤éƒ¨åˆ†
                renderClusterSection(cluster, []);
            })
            .always(function() {
                completedCount++;
                if (completedCount === clusters.length) {
                    $('#loading-section').hide();
                    updateOverallStats(clusters.length, allNodesData);
                }
            });
    });
    
    // å¦‚æœæ²¡æœ‰é›†ç¾¤ï¼Œéšè—åŠ è½½çŠ¶æ€
    if (clusters.length === 0) {
        $('#loading-section').hide();
        $('#demo-section').show();
    }
}

// æ¸²æŸ“å•ä¸ªé›†ç¾¤çš„èŠ‚ç‚¹éƒ¨åˆ†
function renderClusterSection(cluster, nodes) {
    const readyNodes = nodes.filter(n => n.status === 'Ready').length;
    const totalPods = nodes.reduce((sum, n) => sum + (n.pod_count || 0), 0);
    
    const clusterSection = $(`
        <div class="cluster-section">
            <div class="cluster-header" onclick="toggleCluster(${cluster.id})">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">
                            <i class="fas fa-layer-group mr-2 text-primary"></i>${cluster.name}
                            <small class="text-muted ml-2">${cluster.k8s_version || 'Unknown'}</small>
                        </h5>
                        <small class="text-muted">${cluster.api_server}</small>
                    </div>
                    <div class="text-right">
                        <div class="cluster-stats">
                            <div class="stat-item">
                                <div class="text-primary font-weight-bold">${nodes.length}</div>
                                <small class="text-muted">èŠ‚ç‚¹</small>
                            </div>
                            <div class="stat-item">
                                <div class="text-success font-weight-bold">${readyNodes}</div>
                                <small class="text-muted">å°±ç»ª</small>
                            </div>
                            <div class="stat-item">
                                <div class="text-warning font-weight-bold">${totalPods}</div>
                                <small class="text-muted">Pod</small>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down" id="chevron-${cluster.id}"></i>
                    </div>
                </div>
            </div>
            <div class="cluster-body" id="cluster-body-${cluster.id}">
                ${renderNodesGrid(cluster.id, nodes)}
            </div>
        </div>
    `);
    
    $('#clusters-container').append(clusterSection);
}

// æ¸²æŸ“èŠ‚ç‚¹ç½‘æ ¼
function renderNodesGrid(clusterId, nodes) {
    if (nodes.length === 0) {
        return `
            <div class="text-center py-4">
                <i class="fas fa-info-circle fa-2x text-muted mb-2"></i>
                <p class="text-muted">æ­¤é›†ç¾¤æš‚æ— èŠ‚ç‚¹æ•°æ®</p>
                <button class="btn btn-sm btn-outline-primary" onclick="loadClusterMockData(${clusterId})">
                    <i class="fas fa-database"></i> åŠ è½½ç¤ºä¾‹æ•°æ®
                </button>
            </div>
        `;
    }
    
    let nodesHtml = '<div class="node-grid">';
    
    nodes.forEach(node => {
        const statusClass = node.status === 'Ready' ? 'status-ready' : 
                           node.status === 'NotReady' ? 'status-notready' : 'status-unknown';
        
        const cpuPercent = calculateUsagePercent(node.cpu_used || '0', node.capacity?.cpu || '0');
        const memoryPercent = calculateUsagePercent(node.memory_used || '0', node.capacity?.memory || '0');
        
        nodesHtml += `
            <div class="node-mini-card" onclick="goToNodeDetail(${clusterId}, '${node.name}')">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">
                        <span class="status-indicator ${statusClass}"></span>
                        ${node.name}
                    </h6>
                    <small class="text-muted">${Array.isArray(node.roles) ? node.roles.join(',') : node.roles || 'worker'}</small>
                </div>
                <div class="mb-1">
                    <small class="text-muted">CPU: ${cpuPercent}%</small>
                    <div class="resource-mini-bar">
                        <div style="width: ${cpuPercent}%; height: 100%; background: #007bff;"></div>
                    </div>
                </div>
                <div class="mb-1">
                    <small class="text-muted">å†…å­˜: ${memoryPercent}%</small>
                    <div class="resource-mini-bar">
                        <div style="width: ${memoryPercent}%; height: 100%; background: #28a745;"></div>
                    </div>
                </div>
                <div class="d-flex justify-content-between">
                    <small class="text-muted">Pod: ${node.pod_count || 0}</small>
                    <small class="text-muted">${node.version || 'Unknown'}</small>
                </div>
            </div>
        `;
    });
    
    nodesHtml += '</div>';
    return nodesHtml;
}

// è®¡ç®—ä½¿ç”¨ç™¾åˆ†æ¯”ï¼ˆå¤ç”¨ä¹‹å‰çš„å‡½æ•°ï¼‰
function calculateUsagePercent(used, total) {
    if (!used || !total) return 0;
    
    // å¤„ç†CPU (millicores)
    if (typeof used === 'string' && used.includes('m')) {
        used = parseInt(used.replace('m', ''));
    }
    if (typeof total === 'string' && total.includes('m')) {
        total = parseInt(total.replace('m', ''));
    } else if (typeof total === 'string' && !total.includes('m')) {
        total = parseInt(total) * 1000; // æ ¸å¿ƒè½¬æ¢ä¸ºmillicores
    }
    
    // å¤„ç†å†…å­˜ (è½¬æ¢ä¸ºMB)
    if (typeof used === 'string' && used.includes('Mi')) {
        used = parseInt(used.replace('Mi', ''));
    }
    if (typeof total === 'string' && total.includes('Mi')) {
        total = parseInt(total.replace('Mi', ''));
    } else if (typeof total === 'string' && total.includes('Gi')) {
        total = parseInt(total.replace('Gi', '')) * 1024;
    }
    
    const percent = (used / total) * 100;
    return Math.min(Math.max(Math.round(percent), 0), 100);
}

// æ›´æ–°æ€»è§ˆç»Ÿè®¡
function updateOverallStats(clusterCount, allNodes) {
    const totalNodes = allNodes.length;
    const readyNodes = allNodes.filter(n => n.status === 'Ready').length;
    const totalPods = allNodes.reduce((sum, n) => sum + (n.pod_count || 0), 0);
    
    $('#total-clusters').text(clusterCount);
    $('#total-nodes').text(totalNodes);
    $('#ready-nodes').text(readyNodes);
    $('#total-pods').text(totalPods);
}

// åˆ‡æ¢é›†ç¾¤å±•å¼€/æ”¶èµ·
function toggleCluster(clusterId) {
    const body = $(`#cluster-body-${clusterId}`);
    const chevron = $(`#chevron-${clusterId}`);
    
    body.slideToggle();
    chevron.toggleClass('fa-chevron-down fa-chevron-up');
}

// è·³è½¬åˆ°èŠ‚ç‚¹è¯¦æƒ…
function goToNodeDetail(clusterId, nodeName) {
    window.open(`/k8s/clusters/${clusterId}/nodes`, '_blank');
}

// åˆ·æ–°æ‰€æœ‰æ•°æ®
function refreshAllData() {
    loadAllClustersNodes();
}

// ä¸ºå•ä¸ªé›†ç¾¤åŠ è½½Mockæ•°æ®
function loadClusterMockData(clusterId) {
    const mockNodes = [
        {
            name: `cluster-${clusterId}-master-1`,
            status: 'Ready',
            roles: ['master'],
            version: 'v1.21.0',
            cpu_used: '800m',
            memory_used: '2048Mi',
            pod_count: 12,
            capacity: { cpu: '4000m', memory: '8192Mi' }
        },
        {
            name: `cluster-${clusterId}-worker-1`,
            status: 'Ready',
            roles: ['worker'],
            version: 'v1.21.0',
            cpu_used: '1200m',
            memory_used: '3072Mi',
            pod_count: 18,
            capacity: { cpu: '4000m', memory: '8192Mi' }
        }
    ];
    
    // æ›´æ–°å¯¹åº”é›†ç¾¤çš„èŠ‚ç‚¹æ˜¾ç¤º
    $(`#cluster-body-${clusterId}`).html(renderNodesGrid(clusterId, mockNodes));
}

// åŠ è½½æ¼”ç¤ºæ•°æ®
function loadDemoData() {
    const demoClusters = [
        { id: 1, name: 'Production Cluster', k8s_version: 'v1.21.0', api_server: 'https://prod-k8s.example.com' },
        { id: 2, name: 'Staging Cluster', k8s_version: 'v1.20.5', api_server: 'https://staging-k8s.example.com' },
        { id: 3, name: 'Development Cluster', k8s_version: 'v1.21.2', api_server: 'https://dev-k8s.example.com' }
    ];
    
    $('#loading-section').show();
    $('#demo-section').hide();
    
    setTimeout(() => {
        loadNodesForClusters(demoClusters);
    }, 1000);
}

function showError(message) {
    alert('é”™è¯¯: ' + message);
}
</script>
{% endblock %}
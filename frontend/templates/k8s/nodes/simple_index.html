{% extends "base.html" %}

{% block title %}K8sèŠ‚ç‚¹ç®¡ç†{% endblock %}

{% block extra_css %}
<style>
.node-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
}

.node-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.node-status-ready {
    background: #d4edda;
    color: #155724;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
}

.node-status-notready {
    background: #f8d7da;
    color: #721c24;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
}

.resource-bar {
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 4px;
}

.resource-fill {
    height: 100%;
    transition: width 0.3s ease;
}

.cpu-fill { background: #007bff; }
.memory-fill { background: #28a745; }
.pod-fill { background: #ffc107; }

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.no-data {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    border: 1px solid #f5c6cb;
}

.success-message {
    background: #d4edda;
    color: #155724;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    border: 1px solid #c3e6cb;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">K8sé›†ç¾¤èŠ‚ç‚¹ç®¡ç†</h1>
            <p class="text-muted mb-0">é›†ç¾¤: <span id="cluster-name" class="text-primary font-weight-bold">-</span></p>
        </div>
        <div>
            <button type="button" class="btn btn-outline-primary btn-sm mr-2" onclick="refreshData()">
                <span id="refresh-icon">
                    <i class="fas fa-sync-alt"></i> åˆ·æ–°
                </span>
            </button>
            <a href="/k8s-clusters" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left"></i> è¿”å›é›†ç¾¤åˆ—è¡¨
            </a>
        </div>
    </div>

    <!-- æ¶ˆæ¯åŒºåŸŸ -->
    <div id="message-area"></div>

    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <div class="stats-grid">
        <div class="stat-card">
            <h4 class="text-primary mb-0" id="total-nodes">-</h4>
            <small class="text-muted">æ€»èŠ‚ç‚¹æ•°</small>
        </div>
        <div class="stat-card">
            <h4 class="text-success mb-0" id="ready-nodes">-</h4>
            <small class="text-muted">å°±ç»ªèŠ‚ç‚¹</small>
        </div>
        <div class="stat-card">
            <h4 class="text-warning mb-0" id="total-pods">-</h4>
            <small class="text-muted">è¿è¡ŒPodæ•°</small>
        </div>
        <div class="stat-card">
            <h4 class="text-info mb-0" id="cluster-version">-</h4>
            <small class="text-muted">é›†ç¾¤ç‰ˆæœ¬</small>
        </div>
    </div>

    <!-- èŠ‚ç‚¹åˆ—è¡¨ -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-server mr-2"></i>èŠ‚ç‚¹åˆ—è¡¨
                <span id="loading-indicator" style="display: none;" class="ml-2">
                    <span class="loading-spinner"></span> åŠ è½½ä¸­...
                </span>
            </h5>
        </div>
        <div class="card-body">
            <!-- èŠ‚ç‚¹å®¹å™¨ -->
            <div id="nodes-container">
                <!-- èŠ‚ç‚¹å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- æ— æ•°æ®æç¤º -->
            <div id="no-data" class="no-data" style="display: none;">
                <i class="fas fa-server fa-3x text-muted mb-3"></i>
                <h5>æš‚æ— èŠ‚ç‚¹æ•°æ®</h5>
                <p class="text-muted">å¯èƒ½æ˜¯é›†ç¾¤è¿æ¥é—®é¢˜æˆ–é›†ç¾¤ä¸­ç¡®å®æ²¡æœ‰èŠ‚ç‚¹</p>
                <button class="btn btn-primary" onclick="loadMockData()">
                    <i class="fas fa-database"></i> åŠ è½½ç¤ºä¾‹æ•°æ®
                </button>
            </div>
        </div>
    </div>
</div>

<!-- èŠ‚ç‚¹è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="nodeDetailModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-server mr-2"></i>èŠ‚ç‚¹è¯¦æƒ…: <span id="modal-node-name"></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="node-detail-content">
                    <!-- èŠ‚ç‚¹è¯¦æƒ…å†…å®¹ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentClusterId = null;

// é¡µé¢åˆå§‹åŒ–
$(document).ready(function() {
    console.log('ğŸ“± K8sèŠ‚ç‚¹ç®¡ç†é¡µé¢åˆå§‹åŒ–');
    
    // ä»URLè·å–é›†ç¾¤ID
    const pathParts = window.location.pathname.split('/');
    currentClusterId = pathParts[3]; // /k8s/clusters/{id}/nodes
    
    console.log('ğŸ” å½“å‰é›†ç¾¤ID:', currentClusterId);
    
    if (currentClusterId) {
        loadClusterInfo();
        loadNodes();
    } else {
        showError('æ— æ³•è·å–é›†ç¾¤IDï¼Œè¯·ä»é›†ç¾¤åˆ—è¡¨é¡µé¢è®¿é—®');
    }
});

// åŠ è½½é›†ç¾¤ä¿¡æ¯
function loadClusterInfo() {
    const url = `/api/k8s/clusters/${currentClusterId}`;
    console.log('ğŸ“¡ è¯·æ±‚é›†ç¾¤ä¿¡æ¯:', url);
    
    $.get(url)
        .done(function(response) {
            console.log('âœ… é›†ç¾¤ä¿¡æ¯å“åº”:', response);
            if (response.success) {
                $('#cluster-name').text(response.data.name);
                $('#cluster-version').text(response.data.k8s_version || 'Unknown');
            } else {
                $('#cluster-name').text(`é›†ç¾¤ ${currentClusterId}`);
                console.warn('âš ï¸ è·å–é›†ç¾¤ä¿¡æ¯å¤±è´¥:', response.error);
            }
        })
        .fail(function(xhr) {
            console.error('âŒ é›†ç¾¤ä¿¡æ¯è¯·æ±‚å¤±è´¥:', xhr.status, xhr.statusText);
            $('#cluster-name').text(`é›†ç¾¤ ${currentClusterId}`);
            
            if (xhr.status === 401) {
                showError('è¯·å…ˆç™»å½•ç³»ç»Ÿ');
            }
        });
}

// åŠ è½½èŠ‚ç‚¹æ•°æ®
function loadNodes() {
    showLoading(true);
    clearMessages();
    
    const url = `/api/k8s/clusters/${currentClusterId}/nodes`;
    console.log('ğŸ“¡ è¯·æ±‚èŠ‚ç‚¹åˆ—è¡¨:', url);
    
    $.get(url)
        .done(function(response) {
            console.log('âœ… èŠ‚ç‚¹å“åº”:', response);
            handleNodesResponse(response);
        })
        .fail(function(xhr) {
            console.error('âŒ èŠ‚ç‚¹è¯·æ±‚å¤±è´¥:', xhr.status, xhr.statusText);
            showLoading(false);
            
            if (xhr.status === 401) {
                showError('è¯·å…ˆç™»å½•ç³»ç»Ÿ');
            } else if (xhr.status === 404) {
                showError('é›†ç¾¤ä¸å­˜åœ¨');
            } else {
                // å…¶ä»–é”™è¯¯ï¼Œä»ç„¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                showError('æ— æ³•åŠ è½½èŠ‚ç‚¹æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜');
                showNoData();
            }
        });
}

// å¤„ç†èŠ‚ç‚¹å“åº”
function handleNodesResponse(response) {
    showLoading(false);
    
    if (response.success && response.data && response.data.length > 0) {
        console.log('âœ… æ‰¾åˆ°èŠ‚ç‚¹:', response.data.length, 'ä¸ª');
        renderNodes(response.data);
        updateStats(response.data);
        
        // æ˜¾ç¤ºAPIè¿”å›çš„æ¶ˆæ¯ï¼Œå¦‚æœæ˜¯fallbackæ•°æ®ä¼šæœ‰ç›¸åº”æç¤º
        if (response.message) {
            showInfo(response.message);
        } else {
            showSuccess('èŠ‚ç‚¹æ•°æ®åŠ è½½æˆåŠŸ');
        }
    } else {
        console.log('âš ï¸ æ²¡æœ‰èŠ‚ç‚¹æ•°æ®');
        showNoData();
        resetStats();
    }
}

// æ¸²æŸ“èŠ‚ç‚¹åˆ—è¡¨
function renderNodes(nodes) {
    const container = $('#nodes-container');
    container.empty();
    
    nodes.forEach((node, index) => {
        const nodeCard = createNodeCard(node, index);
        container.append(nodeCard);
    });
    
    $('#no-data').hide();
}

// åˆ›å»ºèŠ‚ç‚¹å¡ç‰‡
function createNodeCard(node, index) {
    const statusClass = node.status === 'Ready' ? 'node-status-ready' : 'node-status-notready';
    const cpuPercent = calculateUsagePercent(node.cpu_used || '0', node.capacity?.cpu || '0');
    const memoryPercent = calculateUsagePercent(node.memory_used || '0', node.capacity?.memory || '0');
    const podPercent = calculateUsagePercent(node.pod_count || 0, node.capacity?.pods || 0);
    
    const card = $(`
        <div class="node-card" onclick="showNodeDetail('${node.name}', ${index})">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="mb-2">
                        <i class="fas fa-server mr-2"></i>${node.name}
                    </h6>
                    <div class="mb-2">
                        <span class="${statusClass}">${node.status}</span>
                        ${node.roles ? `<span class="ml-2 text-muted">${Array.isArray(node.roles) ? node.roles.join(', ') : node.roles}</span>` : ''}
                    </div>
                    <div class="text-muted small">
                        <div>ç‰ˆæœ¬: ${node.version || 'Unknown'}</div>
                        <div>è¿è¡Œæ—¶é—´: ${node.age || 'Unknown'}</div>
                        <div>å†…éƒ¨IP: ${node.internal_ip || 'N/A'}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <small>CPUä½¿ç”¨</small>
                            <small>${cpuPercent}%</small>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-fill cpu-fill" style="width: ${cpuPercent}%"></div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <small>å†…å­˜ä½¿ç”¨</small>
                            <small>${memoryPercent}%</small>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-fill memory-fill" style="width: ${memoryPercent}%"></div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <small>Podä½¿ç”¨</small>
                            <small>${node.pod_count || 0}/${node.capacity?.pods || 0}</small>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-fill pod-fill" style="width: ${podPercent}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `);
    
    return card;
}

// è®¡ç®—ä½¿ç”¨ç™¾åˆ†æ¯”
function calculateUsagePercent(used, total) {
    if (!used || !total) return 0;
    
    // å¤„ç†CPU (millicores)
    if (typeof used === 'string' && used.includes('m')) {
        used = parseInt(used.replace('m', ''));
    }
    if (typeof total === 'string' && total.includes('m')) {
        total = parseInt(total.replace('m', ''));
    } else if (typeof total === 'string' && !total.includes('m')) {
        total = parseInt(total) * 1000; // æ ¸å¿ƒè½¬æ¢ä¸ºmillicores
    }
    
    // å¤„ç†å†…å­˜ (è½¬æ¢ä¸ºMB)
    if (typeof used === 'string' && used.includes('Mi')) {
        used = parseInt(used.replace('Mi', ''));
    }
    if (typeof total === 'string' && total.includes('Mi')) {
        total = parseInt(total.replace('Mi', ''));
    } else if (typeof total === 'string' && total.includes('Gi')) {
        total = parseInt(total.replace('Gi', '')) * 1024;
    }
    
    const percent = (used / total) * 100;
    return Math.min(Math.max(Math.round(percent), 0), 100);
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats(nodes) {
    let totalNodes = nodes.length;
    let readyNodes = 0;
    let totalPods = 0;
    
    nodes.forEach(node => {
        if (node.status === 'Ready') readyNodes++;
        if (node.pod_count) totalPods += node.pod_count;
    });
    
    $('#total-nodes').text(totalNodes);
    $('#ready-nodes').text(readyNodes);
    $('#total-pods').text(totalPods);
}

// é‡ç½®ç»Ÿè®¡ä¿¡æ¯
function resetStats() {
    $('#total-nodes').text('0');
    $('#ready-nodes').text('0');
    $('#total-pods').text('0');
}

// æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…
function showNodeDetail(nodeName, index) {
    console.log('ğŸ” æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…:', nodeName);
    
    // è¿™é‡Œå¯ä»¥è°ƒç”¨è¯¦ç»†çš„èŠ‚ç‚¹ä¿¡æ¯API
    // ç°åœ¨å…ˆæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
    $('#modal-node-name').text(nodeName);
    
    const detailHtml = `
        <div class="row">
            <div class="col-md-6">
                <h6>åŸºæœ¬ä¿¡æ¯</h6>
                <table class="table table-sm">
                    <tr><td>èŠ‚ç‚¹åç§°</td><td>${nodeName}</td></tr>
                    <tr><td>çŠ¶æ€</td><td><span class="badge badge-success">Ready</span></td></tr>
                    <tr><td>è§’è‰²</td><td>worker</td></tr>
                    <tr><td>ç‰ˆæœ¬</td><td>v1.21.0</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>èµ„æºä¿¡æ¯</h6>
                <table class="table table-sm">
                    <tr><td>CPUå®¹é‡</td><td>4 cores</td></tr>
                    <tr><td>å†…å­˜å®¹é‡</td><td>8Gi</td></tr>
                    <tr><td>Podå®¹é‡</td><td>110</td></tr>
                    <tr><td>è¿è¡ŒPod</td><td>15</td></tr>
                </table>
            </div>
        </div>
    `;
    
    $('#node-detail-content').html(detailHtml);
    $('#nodeDetailModal').modal('show');
}

// åŠ è½½Mockæ•°æ®
function loadMockData() {
    console.log('ğŸ“¦ åŠ è½½Mockæ•°æ®');
    
    const mockNodes = [
        {
            name: 'k8s-master-1',
            status: 'Ready',
            roles: ['master', 'control-plane'],
            version: 'v1.21.0',
            age: '15d',
            internal_ip: '192.168.1.10',
            external_ip: '203.0.113.10',
            cpu_used: '800m',
            memory_used: '2048Mi',
            pod_count: 12,
            capacity: {
                cpu: '4000m',
                memory: '8192Mi',
                pods: 110,
                storage: '100Gi'
            }
        },
        {
            name: 'k8s-worker-1',
            status: 'Ready',
            roles: ['worker'],
            version: 'v1.21.0',
            age: '15d',
            internal_ip: '192.168.1.11',
            external_ip: '<none>',
            cpu_used: '1200m',
            memory_used: '3072Mi',
            pod_count: 18,
            capacity: {
                cpu: '4000m',
                memory: '8192Mi',
                pods: 110,
                storage: '100Gi'
            }
        },
        {
            name: 'k8s-worker-2',
            status: 'Ready',
            roles: ['worker'],
            version: 'v1.21.0',
            age: '12d',
            internal_ip: '192.168.1.12',
            external_ip: '<none>',
            cpu_used: '600m',
            memory_used: '1536Mi',
            pod_count: 8,
            capacity: {
                cpu: '4000m',
                memory: '8192Mi',
                pods: 110,
                storage: '100Gi'
            }
        }
    ];
    
    showSuccess('Mockæ•°æ®åŠ è½½æˆåŠŸï¼');
    renderNodes(mockNodes);
    updateStats(mockNodes);
    $('#cluster-version').text('v1.21.0');
}

// åˆ·æ–°æ•°æ®
function refreshData() {
    const refreshIcon = $('#refresh-icon');
    refreshIcon.html('<span class="loading-spinner"></span> åˆ·æ–°ä¸­...');
    
    loadClusterInfo();
    loadNodes();
    
    setTimeout(() => {
        refreshIcon.html('<i class="fas fa-sync-alt"></i> åˆ·æ–°');
    }, 2000);
}

// UIæ§åˆ¶å‡½æ•°
function showLoading(show) {
    if (show) {
        $('#loading-indicator').show();
    } else {
        $('#loading-indicator').hide();
    }
}

function showNoData() {
    $('#no-data').show();
    $('#nodes-container').empty();
}

function showSuccess(message) {
    showMessage(message, 'success');
}

function showError(message) {
    showMessage(message, 'error');
}

function showWarning(message) {
    showMessage(message, 'warning');
}

function showInfo(message) {
    showMessage(message, 'info');
}

function showMessage(message, type) {
    const alertClass = type === 'success' ? 'success-message' : 
                      type === 'warning' ? 'alert alert-warning' : 
                      type === 'info' ? 'alert alert-info' : 'error-message';
    
    const iconType = type === 'success' ? 'check-circle' : 
                    type === 'warning' ? 'exclamation-triangle' :
                    type === 'info' ? 'info-circle' : 'exclamation-circle';
    
    const messageHtml = `
        <div class="${alertClass}">
            <i class="fas fa-${iconType} mr-2"></i>
            ${message}
            <button type="button" class="close" onclick="clearMessages()">
                <span>&times;</span>
            </button>
        </div>
    `;
    
    $('#message-area').html(messageHtml);
    
    // è‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
    if (type === 'success') {
        setTimeout(clearMessages, 3000);
    }
}

function clearMessages() {
    $('#message-area').empty();
}
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Pod管理 - Kubernetes{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pods-kubesphere.css') }}?v=2.2">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pod-logs-viewer.css') }}?v=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='css/yaml-viewer.css') }}?v=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pod-terminal.css') }}?v=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pod-monitoring.css') }}?v=1.0">
<!-- xterm.js CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
{% endblock %}

{% block content %}
<!-- Pod管理页面 - KubeSphere风格 -->
<div class="page-wrapper">
  <!-- 面包屑导航 -->
  <div class="breadcrumb-section">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="{{ url_for('main.index') }}"><i class="fas fa-dharmachakra"></i> Kubernetes</a>
        </li>
        <li class="breadcrumb-item">
          <a href="{{ url_for('main.k8s_workloads') }}">工作负载</a>
        </li>
        <li class="breadcrumb-item active">Pods</li>
      </ol>
    </nav>
  </div>

  <!-- 页面标题和统计 -->
  <div class="page-header">
    <div class="page-title-section">
      <h1 class="page-title">
        <i class="fas fa-cube text-primary"></i>
        Pod 管理
      </h1>
      <p class="page-description">管理Kubernetes集群中的Pod实例</p>
    </div>
    
    <!-- 统计卡片 -->
    <div class="stats-cards-row">
      <div class="stat-card stat-card-success">
        <div class="stat-card-content">
          <div class="stat-number" id="running-pods-count">0</div>
          <div class="stat-label">运行中</div>
        </div>
        <div class="stat-icon">
          <i class="fas fa-check-circle"></i>
        </div>
      </div>
      
      <div class="stat-card stat-card-warning">
        <div class="stat-card-content">
          <div class="stat-number" id="pending-pods-count">0</div>
          <div class="stat-label">待调度</div>
        </div>
        <div class="stat-icon">
          <i class="fas fa-clock"></i>
        </div>
      </div>
      
      <div class="stat-card stat-card-danger">
        <div class="stat-card-content">
          <div class="stat-number" id="failed-pods-count">0</div>
          <div class="stat-label">失败</div>
        </div>
        <div class="stat-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
      </div>
      
      <div class="stat-card stat-card-info">
        <div class="stat-card-content">
          <div class="stat-number" id="total-pods-count">0</div>
          <div class="stat-label">总数</div>
        </div>
        <div class="stat-icon">
          <i class="fas fa-cubes"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- 工具栏 -->
  <div class="toolbar-section">
    <div class="toolbar-left">
      <!-- 集群选择器 -->
      <div class="cluster-selector">
        <select class="form-select form-select-sm" id="cluster-filter">
          <option value="">选择集群...</option>
        </select>
      </div>
      
      <!-- 命名空间过滤 -->
      <div class="filter-item">
        <select class="form-select form-select-sm" id="namespace-filter">
          <option value="">所有命名空间</option>
        </select>
      </div>
      
      <!-- 状态过滤 -->
      <div class="filter-item">
        <select class="form-select form-select-sm" id="status-filter">
          <option value="">所有状态</option>
          <option value="Running">运行中</option>
          <option value="Pending">待调度</option>
          <option value="Succeeded">已完成</option>
          <option value="Failed">失败</option>
          <option value="Unknown">未知</option>
        </select>
      </div>
      
      <!-- 批量操作 -->
      <div class="batch-actions" id="batch-actions" style="display: none;">
        <button class="btn btn-sm btn-outline-danger" id="batch-delete-btn">
          <i class="fas fa-trash"></i> 批量删除
        </button>
        <span class="batch-info">已选择 <span id="selected-count">0</span> 个Pod</span>
      </div>
    </div>
    
    <div class="toolbar-right">
      
      <!-- 搜索框 -->
      <div class="search-box">
        <input type="text" class="form-control form-control-sm" id="pod-search" 
               placeholder="搜索Pod名称...">
        <i class="fas fa-search search-icon"></i>
      </div>
      
      <!-- 视图切换 -->
      <div class="view-toggle">
        <div class="btn-group btn-group-sm" role="group">
          <input type="radio" class="btn-check" name="view-mode" id="table-view" checked>
          <label class="btn btn-outline-secondary" for="table-view">
            <i class="fas fa-list"></i>
          </label>
          
          <input type="radio" class="btn-check" name="view-mode" id="card-view">
          <label class="btn btn-outline-secondary" for="card-view">
            <i class="fas fa-th"></i>
          </label>
        </div>
      </div>
      
      <!-- 刷新按钮 -->
      <button class="btn btn-sm btn-outline-primary" id="refresh-btn">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>
  </div>

  <!-- 表格视图 -->
  <div class="content-section" id="table-view-content">
    <div class="table-container">
      <table class="table table-hover pods-table" id="pods-table">
        <thead>
          <tr>
            <th width="40">
              <input type="checkbox" id="select-all-checkbox">
            </th>
            <th width="50">状态</th>
            <th>名称</th>
            <th>命名空间</th>
            <th>节点</th>
            <th>CPU/内存</th>
            <th>重启次数</th>
            <th>创建时间</th>
            <th width="120">操作</th>
          </tr>
        </thead>
        <tbody id="pods-table-body">
          <!-- Pod行将通过JavaScript动态生成 -->
        </tbody>
      </table>
    </div>
    
    <!-- 分页 -->
    <div class="pagination-section">
      <div class="pagination-info">
        显示 <span id="items-range">0-0</span> / <span id="total-items">0</span> 个Pod
      </div>
      <nav aria-label="分页">
        <ul class="pagination pagination-sm" id="pagination-controls">
        </ul>
      </nav>
    </div>
  </div>

  <!-- 卡片视图 -->
  <div class="content-section" id="card-view-content" style="display: none;">
    <div class="cards-container" id="pods-cards-container">
      <!-- Pod卡片将通过JavaScript动态生成 -->
    </div>
  </div>
</div>

<!-- Pod详情全屏模态框 -->
<div class="modal fade" id="pod-detail-modal" tabindex="-1">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title d-flex align-items-center">
          <i class="fas fa-cube me-2"></i>
          <span id="pod-detail-modal-title">Pod详情</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="pod-detail-modal-body">
        <!-- 详情内容将在这里动态加载 -->
        <div class="loading-container text-center p-5">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-3">加载Pod详情中...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pod YAML查看模态框 -->
<div class="modal fade" id="pod-yaml-modal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-fullscreen-lg-down modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title d-flex align-items-center">
          <i class="fas fa-code me-2"></i>
          <span id="yaml-modal-title">Pod YAML</span>
        </h5>
        <div class="header-controls d-flex align-items-center gap-2 me-3">
          <button class="btn btn-sm btn-outline-light" id="copy-yaml-btn" title="复制YAML">
            <i class="fas fa-copy"></i>
          </button>
          <button class="btn btn-sm btn-outline-light" id="download-yaml-btn" title="下载YAML">
            <i class="fas fa-download"></i>
          </button>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body p-0">
        <div class="yaml-container">
          <pre id="yaml-content" class="yaml-editor" style="display: none;"><code class="language-yaml"></code></pre>
          <div class="yaml-loading text-center p-4 hidden" id="yaml-loading">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">加载YAML配置中...</p>
          </div>
        </div>
      </div>
      
      <div class="modal-footer bg-light">
        <div class="footer-left">
          <small class="text-muted">
            <i class="fas fa-info-circle"></i>
            只读模式 - 显示Pod的YAML配置
          </small>
        </div>
        <div class="footer-right">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pod终端模态框 -->
<div class="modal fade" id="pod-terminal-modal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="terminal-modal-title">
          <i class="fas fa-terminal"></i>
          Pod 终端
        </h5>
        <div class="terminal-controls">
          <select id="terminal-container-select" class="container-selector" title="选择容器">
            <option value="">选择容器...</option>
          </select>
          <span id="terminal-status" class="terminal-status disconnected">未连接</span>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="terminal-container">
        <div id="terminal-container"></div>
        <div id="terminal-overlay" class="terminal-overlay hidden">
          <div class="spinner"></div>
          <span>初始化终端...</span>
        </div>
      </div>
      
      <div class="modal-footer">
        <div class="terminal-info">
          <small class="text-muted">
            <i class="fas fa-keyboard"></i>
            使用 Ctrl+C 中断，Ctrl+D 退出
          </small>
        </div>
        <div class="terminal-actions">
          <button type="button" class="btn-terminal" id="terminal-clear-btn" title="清屏">
            <i class="fas fa-eraser"></i> 清屏
          </button>
          <button type="button" class="btn-terminal" id="terminal-reconnect-btn" title="重连">
            <i class="fas fa-redo"></i> 重连
          </button>
          <button type="button" class="btn-terminal btn-danger" id="terminal-disconnect-btn" title="断开连接">
            <i class="fas fa-times"></i> 断开
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- K8s状态管理器 -->
<script src="{{ url_for('static', filename='js/k8s-state-manager.js') }}"></script>
<!-- Socket.IO for WebSocket -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<!-- xterm.js for terminal -->
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
<!-- Chart.js for monitoring - 本地UMD版本 v4.4.0 -->
<script src="{{ url_for('static', filename='js/vendor/chart.min.js') }}" 
        onload="
          console.log('✅ Chart.js 本地文件加载成功'); 
          console.log('🔍 Chart.js UMD加载状态:', typeof window.Chart);
          window.chartJSLoaded = true; 
          
          // 给UMD格式一些时间来初始化Chart对象
          setTimeout(() => {
            console.log('🔍 延迟检查Chart对象:', typeof window.Chart, typeof Chart);
            if (typeof window.Chart !== 'undefined' || typeof Chart !== 'undefined') {
              console.log('✅ Chart对象已可用，触发loaded事件');
              window.dispatchEvent(new Event('chartjs-loaded'));
            } else {
              console.warn('⚠️ Chart对象仍未可用，等待UMD初始化...');
              // 再次延迟检查
              setTimeout(() => {
                if (typeof window.Chart !== 'undefined' || typeof Chart !== 'undefined') {
                  console.log('✅ Chart对象延迟可用，触发loaded事件');
                  window.dispatchEvent(new Event('chartjs-loaded'));
                } else {
                  console.error('❌ Chart对象最终未可用，触发error事件');
                  window.dispatchEvent(new Event('chartjs-error'));
                }
              }, 200);
            }
          }, 50);
        " 
        onerror="
          console.error('❌ Chart.js 本地文件加载失败'); 
          window.chartJSLoadError = true; 
          window.dispatchEvent(new Event('chartjs-error'));
        "></script>

<script src="{{ url_for('static', filename='js/pod-logs-viewer.js') }}?v=1.0"></script>
<script src="{{ url_for('static', filename='js/pod-terminal.js') }}?v=1.0"></script>
<script src="{{ url_for('static', filename='js/pod-monitoring.js') }}?v=2.4"></script>
<script src="{{ url_for('static', filename='js/pods-manager.js') }}?v=2.3"></script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Podç®¡ç† - Kubernetes{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pods-kubesphere.css') }}?v=2.2">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pod-logs-viewer.css') }}?v=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='css/yaml-viewer.css') }}?v=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pod-terminal.css') }}?v=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pod-monitoring.css') }}?v=1.0">
<!-- xterm.js CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
{% endblock %}

{% block content %}
<!-- Podç®¡ç†é¡µé¢ - KubeSphereé£æ ¼ -->
<div class="page-wrapper">
  <!-- é¢åŒ…å±‘å¯¼èˆª -->
  <div class="breadcrumb-section">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="{{ url_for('main.index') }}"><i class="fas fa-dharmachakra"></i> Kubernetes</a>
        </li>
        <li class="breadcrumb-item">
          <a href="{{ url_for('main.k8s_workloads') }}">å·¥ä½œè´Ÿè½½</a>
        </li>
        <li class="breadcrumb-item active">Pods</li>
      </ol>
    </nav>
  </div>

  <!-- é¡µé¢æ ‡é¢˜å’Œç»Ÿè®¡ -->
  <div class="page-header">
    <div class="page-title-section">
      <h1 class="page-title">
        <i class="fas fa-cube text-primary"></i>
        Pod ç®¡ç†
      </h1>
      <p class="page-description">ç®¡ç†Kubernetesé›†ç¾¤ä¸­çš„Podå®ä¾‹</p>
    </div>
    
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-cards-row">
      <div class="stat-card stat-card-success">
        <div class="stat-card-content">
          <div class="stat-number" id="running-pods-count">0</div>
          <div class="stat-label">è¿è¡Œä¸­</div>
        </div>
        <div class="stat-icon">
          <i class="fas fa-check-circle"></i>
        </div>
      </div>
      
      <div class="stat-card stat-card-warning">
        <div class="stat-card-content">
          <div class="stat-number" id="pending-pods-count">0</div>
          <div class="stat-label">å¾…è°ƒåº¦</div>
        </div>
        <div class="stat-icon">
          <i class="fas fa-clock"></i>
        </div>
      </div>
      
      <div class="stat-card stat-card-danger">
        <div class="stat-card-content">
          <div class="stat-number" id="failed-pods-count">0</div>
          <div class="stat-label">å¤±è´¥</div>
        </div>
        <div class="stat-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
      </div>
      
      <div class="stat-card stat-card-info">
        <div class="stat-card-content">
          <div class="stat-number" id="total-pods-count">0</div>
          <div class="stat-label">æ€»æ•°</div>
        </div>
        <div class="stat-icon">
          <i class="fas fa-cubes"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- å·¥å…·æ  -->
  <div class="toolbar-section">
    <div class="toolbar-left">
      <!-- é›†ç¾¤é€‰æ‹©å™¨ -->
      <div class="cluster-selector">
        <select class="form-select form-select-sm" id="cluster-filter">
          <option value="">é€‰æ‹©é›†ç¾¤...</option>
        </select>
      </div>
      
      <!-- å‘½åç©ºé—´è¿‡æ»¤ -->
      <div class="filter-item">
        <select class="form-select form-select-sm" id="namespace-filter">
          <option value="">æ‰€æœ‰å‘½åç©ºé—´</option>
        </select>
      </div>
      
      <!-- çŠ¶æ€è¿‡æ»¤ -->
      <div class="filter-item">
        <select class="form-select form-select-sm" id="status-filter">
          <option value="">æ‰€æœ‰çŠ¶æ€</option>
          <option value="Running">è¿è¡Œä¸­</option>
          <option value="Pending">å¾…è°ƒåº¦</option>
          <option value="Succeeded">å·²å®Œæˆ</option>
          <option value="Failed">å¤±è´¥</option>
          <option value="Unknown">æœªçŸ¥</option>
        </select>
      </div>
      
      <!-- æ‰¹é‡æ“ä½œ -->
      <div class="batch-actions" id="batch-actions" style="display: none;">
        <button class="btn btn-sm btn-outline-danger" id="batch-delete-btn">
          <i class="fas fa-trash"></i> æ‰¹é‡åˆ é™¤
        </button>
        <span class="batch-info">å·²é€‰æ‹© <span id="selected-count">0</span> ä¸ªPod</span>
      </div>
    </div>
    
    <div class="toolbar-right">
      
      <!-- æœç´¢æ¡† -->
      <div class="search-box">
        <input type="text" class="form-control form-control-sm" id="pod-search" 
               placeholder="æœç´¢Podåç§°...">
        <i class="fas fa-search search-icon"></i>
      </div>
      
      <!-- è§†å›¾åˆ‡æ¢ -->
      <div class="view-toggle">
        <div class="btn-group btn-group-sm" role="group">
          <input type="radio" class="btn-check" name="view-mode" id="table-view" checked>
          <label class="btn btn-outline-secondary" for="table-view">
            <i class="fas fa-list"></i>
          </label>
          
          <input type="radio" class="btn-check" name="view-mode" id="card-view">
          <label class="btn btn-outline-secondary" for="card-view">
            <i class="fas fa-th"></i>
          </label>
        </div>
      </div>
      
      <!-- åˆ·æ–°æŒ‰é’® -->
      <button class="btn btn-sm btn-outline-primary" id="refresh-btn">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>
  </div>

  <!-- è¡¨æ ¼è§†å›¾ -->
  <div class="content-section" id="table-view-content">
    <div class="table-container">
      <table class="table table-hover pods-table" id="pods-table">
        <thead>
          <tr>
            <th width="40">
              <input type="checkbox" id="select-all-checkbox">
            </th>
            <th width="50">çŠ¶æ€</th>
            <th>åç§°</th>
            <th>å‘½åç©ºé—´</th>
            <th>èŠ‚ç‚¹</th>
            <th>CPU/å†…å­˜</th>
            <th>é‡å¯æ¬¡æ•°</th>
            <th>åˆ›å»ºæ—¶é—´</th>
            <th width="120">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="pods-table-body">
          <!-- Podè¡Œå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </tbody>
      </table>
    </div>
    
    <!-- åˆ†é¡µ -->
    <div class="pagination-section">
      <div class="pagination-info">
        æ˜¾ç¤º <span id="items-range">0-0</span> / <span id="total-items">0</span> ä¸ªPod
      </div>
      <nav aria-label="åˆ†é¡µ">
        <ul class="pagination pagination-sm" id="pagination-controls">
        </ul>
      </nav>
    </div>
  </div>

  <!-- å¡ç‰‡è§†å›¾ -->
  <div class="content-section" id="card-view-content" style="display: none;">
    <div class="cards-container" id="pods-cards-container">
      <!-- Podå¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>
</div>

<!-- Podè¯¦æƒ…å…¨å±æ¨¡æ€æ¡† -->
<div class="modal fade" id="pod-detail-modal" tabindex="-1">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title d-flex align-items-center">
          <i class="fas fa-cube me-2"></i>
          <span id="pod-detail-modal-title">Podè¯¦æƒ…</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="pod-detail-modal-body">
        <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        <div class="loading-container text-center p-5">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-3">åŠ è½½Podè¯¦æƒ…ä¸­...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pod YAMLæŸ¥çœ‹æ¨¡æ€æ¡† -->
<div class="modal fade" id="pod-yaml-modal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-fullscreen-lg-down modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title d-flex align-items-center">
          <i class="fas fa-code me-2"></i>
          <span id="yaml-modal-title">Pod YAML</span>
        </h5>
        <div class="header-controls d-flex align-items-center gap-2 me-3">
          <button class="btn btn-sm btn-outline-light" id="copy-yaml-btn" title="å¤åˆ¶YAML">
            <i class="fas fa-copy"></i>
          </button>
          <button class="btn btn-sm btn-outline-light" id="download-yaml-btn" title="ä¸‹è½½YAML">
            <i class="fas fa-download"></i>
          </button>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body p-0">
        <div class="yaml-container">
          <pre id="yaml-content" class="yaml-editor" style="display: none;"><code class="language-yaml"></code></pre>
          <div class="yaml-loading text-center p-4 hidden" id="yaml-loading">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">åŠ è½½YAMLé…ç½®ä¸­...</p>
          </div>
        </div>
      </div>
      
      <div class="modal-footer bg-light">
        <div class="footer-left">
          <small class="text-muted">
            <i class="fas fa-info-circle"></i>
            åªè¯»æ¨¡å¼ - æ˜¾ç¤ºPodçš„YAMLé…ç½®
          </small>
        </div>
        <div class="footer-right">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Podç»ˆç«¯æ¨¡æ€æ¡† -->
<div class="modal fade" id="pod-terminal-modal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="terminal-modal-title">
          <i class="fas fa-terminal"></i>
          Pod ç»ˆç«¯
        </h5>
        <div class="terminal-controls">
          <select id="terminal-container-select" class="container-selector" title="é€‰æ‹©å®¹å™¨">
            <option value="">é€‰æ‹©å®¹å™¨...</option>
          </select>
          <span id="terminal-status" class="terminal-status disconnected">æœªè¿æ¥</span>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="terminal-container">
        <div id="terminal-container"></div>
        <div id="terminal-overlay" class="terminal-overlay hidden">
          <div class="spinner"></div>
          <span>åˆå§‹åŒ–ç»ˆç«¯...</span>
        </div>
      </div>
      
      <div class="modal-footer">
        <div class="terminal-info">
          <small class="text-muted">
            <i class="fas fa-keyboard"></i>
            ä½¿ç”¨ Ctrl+C ä¸­æ–­ï¼ŒCtrl+D é€€å‡º
          </small>
        </div>
        <div class="terminal-actions">
          <button type="button" class="btn-terminal" id="terminal-clear-btn" title="æ¸…å±">
            <i class="fas fa-eraser"></i> æ¸…å±
          </button>
          <button type="button" class="btn-terminal" id="terminal-reconnect-btn" title="é‡è¿">
            <i class="fas fa-redo"></i> é‡è¿
          </button>
          <button type="button" class="btn-terminal btn-danger" id="terminal-disconnect-btn" title="æ–­å¼€è¿æ¥">
            <i class="fas fa-times"></i> æ–­å¼€
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- K8sçŠ¶æ€ç®¡ç†å™¨ -->
<script src="{{ url_for('static', filename='js/k8s-state-manager.js') }}"></script>
<!-- Socket.IO for WebSocket -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<!-- xterm.js for terminal -->
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
<!-- Chart.js for monitoring - æœ¬åœ°UMDç‰ˆæœ¬ v4.4.0 -->
<script src="{{ url_for('static', filename='js/vendor/chart.min.js') }}" 
        onload="
          console.log('âœ… Chart.js æœ¬åœ°æ–‡ä»¶åŠ è½½æˆåŠŸ'); 
          console.log('ğŸ” Chart.js UMDåŠ è½½çŠ¶æ€:', typeof window.Chart);
          window.chartJSLoaded = true; 
          
          // ç»™UMDæ ¼å¼ä¸€äº›æ—¶é—´æ¥åˆå§‹åŒ–Chartå¯¹è±¡
          setTimeout(() => {
            console.log('ğŸ” å»¶è¿Ÿæ£€æŸ¥Chartå¯¹è±¡:', typeof window.Chart, typeof Chart);
            if (typeof window.Chart !== 'undefined' || typeof Chart !== 'undefined') {
              console.log('âœ… Chartå¯¹è±¡å·²å¯ç”¨ï¼Œè§¦å‘loadedäº‹ä»¶');
              window.dispatchEvent(new Event('chartjs-loaded'));
            } else {
              console.warn('âš ï¸ Chartå¯¹è±¡ä»æœªå¯ç”¨ï¼Œç­‰å¾…UMDåˆå§‹åŒ–...');
              // å†æ¬¡å»¶è¿Ÿæ£€æŸ¥
              setTimeout(() => {
                if (typeof window.Chart !== 'undefined' || typeof Chart !== 'undefined') {
                  console.log('âœ… Chartå¯¹è±¡å»¶è¿Ÿå¯ç”¨ï¼Œè§¦å‘loadedäº‹ä»¶');
                  window.dispatchEvent(new Event('chartjs-loaded'));
                } else {
                  console.error('âŒ Chartå¯¹è±¡æœ€ç»ˆæœªå¯ç”¨ï¼Œè§¦å‘erroräº‹ä»¶');
                  window.dispatchEvent(new Event('chartjs-error'));
                }
              }, 200);
            }
          }, 50);
        " 
        onerror="
          console.error('âŒ Chart.js æœ¬åœ°æ–‡ä»¶åŠ è½½å¤±è´¥'); 
          window.chartJSLoadError = true; 
          window.dispatchEvent(new Event('chartjs-error'));
        "></script>

<script src="{{ url_for('static', filename='js/pod-logs-viewer.js') }}?v=1.0"></script>
<script src="{{ url_for('static', filename='js/pod-terminal.js') }}?v=1.0"></script>
<script src="{{ url_for('static', filename='js/pod-monitoring.js') }}?v=2.4"></script>
<script src="{{ url_for('static', filename='js/pods-manager.js') }}?v=2.3"></script>
{% endblock %}
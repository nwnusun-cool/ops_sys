{% extends "base.html" %}

{% block title %}å®ä¾‹ç®¡ç† - {{ super() }}{% endblock %}

{% block page_header %}
<h1 class="page-title">
    <i class="fas fa-desktop"></i>
    å®ä¾‹ç®¡ç†
</h1>
<div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2" id="batchOperationBtn" style="display: none;">
        <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
            <i class="fas fa-list me-1"></i>æ‰¹é‡æ“ä½œ
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="batchOperation('start')">
                <i class="fas fa-play text-success me-2"></i>æ‰¹é‡å¯åŠ¨
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="batchOperation('stop')">
                <i class="fas fa-stop text-danger me-2"></i>æ‰¹é‡åœæ­¢
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="batchOperation('restart')">
                <i class="fas fa-redo text-warning me-2"></i>æ‰¹é‡é‡å¯
            </a></li>
        </ul>
    </div>
    <div class="btn-group me-2" id="exportBtn" style="display: none;">
        <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">
            <i class="fas fa-download me-1"></i>å¯¼å‡º
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportData('excel')">
                <i class="fas fa-file-excel text-success me-2"></i>å¯¼å‡ºExcel
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="exportData('csv')">
                <i class="fas fa-file-csv text-info me-2"></i>å¯¼å‡ºCSV
            </a></li>
        </ul>
    </div>
    <button type="button" class="btn btn-primary" onclick="window.location.href='{{ url_for('main.create_instance') }}'">
        <i class="fas fa-plus me-1"></i>åˆ›å»ºå®ä¾‹
    </button>
</div>
{% endblock %}

{% block extra_head %}
<style>
    .instance-card {
        border-left: 4px solid var(--bs-border-color);
    }
    .instance-card.status-ACTIVE {
        border-left-color: var(--bs-success);
    }
    .instance-card.status-SHUTOFF {
        border-left-color: var(--bs-danger);
    }
    .instance-card.status-SUSPENDED {
        border-left-color: var(--bs-warning);
    }
    .instance-card.status-PAUSED {
        border-left-color: var(--bs-info);
    }
    .instance-card.status-BUILD {
        border-left-color: var(--bs-info);
    }
    .instance-actions {
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    .instance-card:hover .instance-actions {
        opacity: 1;
    }
    .stats-overview {
        margin-bottom: 1.5rem;
    }
    .loading-spinner {
        display: none;
    }
    .instance-ip {
        font-size: 0.85rem;
        color: #6c757d;
    }
    .console-modal {
        max-width: 90vw;
        max-height: 90vh;
    }
    .console-iframe {
        width: 100%;
        height: 70vh;
        border: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-server me-2"></i>å®ä¾‹ç®¡ç†
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('main.create_instance') }}" class="btn btn-success">
                <i class="fas fa-plus me-1"></i>åˆ›å»ºå®ä¾‹
            </a>
        </div>
        <div class="btn-group me-2">
            <button type="button" class="btn btn-outline-secondary" onclick="refreshInstances()">
                <i class="fas fa-sync-alt me-1"></i>åˆ·æ–°
            </button>
        </div>
        <div class="btn-group me-2">
            <button type="button" class="btn btn-outline-primary" id="batchOperationBtn" onclick="toggleBatchMode()" style="display: none;">
                <i class="fas fa-tasks me-1"></i>æ‰¹é‡æ“ä½œ
            </button>
            <button type="button" class="btn btn-success" id="exportBtn" onclick="exportInstances()" style="display: none;">
                <i class="fas fa-download me-1"></i>å¯¼å‡ºExcel
            </button>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-secondary" id="viewToggle" onclick="toggleView()" title="åˆ‡æ¢è§†å›¾">
                <i class="fas fa-th me-1"></i>å¡ç‰‡è§†å›¾
            </button>
        </div>
    </div>
</div>

<!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
<div id="loadingIndicator" class="text-center py-4 loading-spinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
    <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½å®ä¾‹ä¿¡æ¯...</p>
</div>

<!-- é›†ç¾¤é€‰æ‹©å’Œç»Ÿè®¡æ¦‚è§ˆ -->
<div class="stats-overview">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <label class="form-label">é€‰æ‹©é›†ç¾¤</label>
                    <select class="form-select" id="clusterSelect" onchange="onClusterChange()">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">æ€»å®ä¾‹æ•°</h5>
                    <h2 class="mb-0" id="totalInstances">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">è¿è¡Œä¸­</h5>
                    <h2 class="mb-0" id="activeInstances">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">å·²åœæ­¢</h5>
                    <h2 class="mb-0" id="shutoffInstances">-</h2>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åˆ°æœŸçŠ¶æ€ç»Ÿè®¡ -->
    <div class="row mt-3">
        <div class="col-md-4">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">âš ï¸ å³å°†åˆ°æœŸ</h6>
                    <h3 class="mb-0" id="warningInstances">-</h3>
                    <small>24å°æ—¶å†…åˆ°æœŸ</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">ğŸ”¥ å·²åˆ°æœŸ</h6>
                    <h3 class="mb-0" id="expiredInstances">-</h3>
                    <small>éœ€è¦å¤„ç†</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-light text-dark">
                <div class="card-body text-center">
                    <h6 class="card-title">âœ… æ­£å¸¸</h6>
                    <h3 class="mb-0" id="normalInstances">-</h3>
                    <small>æ— åˆ°æœŸé£é™©</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
<div class="alert alert-info" id="batchToolbar" style="display: none;">
    <div class="row align-items-center">
        <div class="col-md-6">
            <span id="selectedCount">å·²é€‰æ‹© 0 ä¸ªå®ä¾‹</span>
            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="selectAllInstances()">
                <i class="fas fa-check-square me-1"></i>å…¨é€‰
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="clearSelection()">
                <i class="fas fa-square me-1"></i>å–æ¶ˆé€‰æ‹©
            </button>
        </div>
        <div class="col-md-6 text-end">
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-success" onclick="batchAction('start')">
                    <i class="fas fa-play me-1"></i>æ‰¹é‡å¯åŠ¨
                </button>
                <button type="button" class="btn btn-sm btn-warning" onclick="batchAction('stop')">
                    <i class="fas fa-stop me-1"></i>æ‰¹é‡åœæ­¢
                </button>
                <button type="button" class="btn btn-sm btn-info" onclick="batchAction('restart')">
                    <i class="fas fa-redo me-1"></i>æ‰¹é‡é‡å¯
                </button>
                {% if current_user.has_role(['super_admin', 'admin']) %}
                <button type="button" class="btn btn-sm btn-danger" onclick="batchAction('delete')">
                    <i class="fas fa-trash me-1"></i>æ‰¹é‡åˆ é™¤
                </button>
                {% endif %}
            </div>
            <button type="button" class="btn btn-sm btn-secondary ms-2" onclick="toggleBatchMode()">
                <i class="fas fa-times me-1"></i>é€€å‡ºæ‰¹é‡æ¨¡å¼
            </button>
        </div>
    </div>
</div>

<!-- è¿‡æ»¤å™¨ -->
<div class="filter-section" id="filterSection" style="display: none;">
    <div class="row">
        <div class="col-md-3">
            <label class="form-label">çŠ¶æ€è¿‡æ»¤</label>
            <select class="form-select" id="statusFilter" onchange="applyFilters()">
                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                <option value="ACTIVE">è¿è¡Œä¸­</option>
                <option value="SHUTOFF">å·²åœæ­¢</option>
                <option value="SUSPENDED">å·²æŒ‚èµ·</option>
                <option value="PAUSED">å·²æš‚åœ</option>
                <option value="ERROR">é”™è¯¯</option>
                <option value="BUILD">æ„å»ºä¸­</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">åˆ°æœŸçŠ¶æ€</label>
            <select class="form-select" id="expireFilter" onchange="applyFilters()">
                <option value="">æ‰€æœ‰åˆ°æœŸçŠ¶æ€</option>
                <option value="normal">æ­£å¸¸</option>
                <option value="warning" class="text-warning">24å°æ—¶å†…åˆ°æœŸ</option>
                <option value="expired" class="text-danger">å·²åˆ°æœŸ</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">æœç´¢</label>
            <input type="text" class="form-control" id="searchInput" placeholder="å®ä¾‹åç§°æˆ–ID..." onkeyup="debounceSearch()">
        </div>
        <div class="col-md-3">
            <label class="form-label">æ¯é¡µæ˜¾ç¤º</label>
            <select class="form-select" id="perPageSelect" onchange="applyFilters()">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
            </select>
        </div>
    </div>
</div>

<!-- å®ä¾‹åˆ—è¡¨ -->
<div class="card" id="instancesCard" style="display: none;">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>å®ä¾‹åˆ—è¡¨
            <span class="badge bg-secondary ms-2" id="instanceCount">0</span>
        </h5>
    </div>
    <div class="card-body">
        <!-- å¡ç‰‡è§†å›¾ -->
        <div id="cardView">
            <div id="instancesContainer" class="row">
                <!-- å®ä¾‹å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
        
        <!-- è¡¨æ ¼è§†å›¾ -->
        <div id="tableView" style="display: none;">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th width="40" id="batchSelectHeader" style="display: none;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                            </th>
                            <th>åç§°</th>
                            <th>é›†ç¾¤</th>
                            <th>çŠ¶æ€</th>
                            <th>è§„æ ¼</th>
                            <th>é•œåƒ</th>
                            <th>IPåœ°å€</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="instancesTableBody">
                        <!-- è¡¨æ ¼è¡Œå°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="emptyState" class="text-center py-5 text-muted" style="display: none;">
            <i class="fas fa-server fa-3x mb-3"></i>
            <h5>æ²¡æœ‰æ‰¾åˆ°å®ä¾‹</h5>
            <p>é€‰æ‹©ä¸€ä¸ªé›†ç¾¤å¼€å§‹ç®¡ç†å®ä¾‹</p>
        </div>
    </div>
</div>

<!-- åˆ†é¡µ -->
<nav class="mt-4" id="paginationContainer" style="display: none;">
    <ul class="pagination justify-content-center" id="pagination">
    </ul>
</nav>

<!-- å®ä¾‹è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="instanceDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-server me-2"></i>å®ä¾‹è¯¦æƒ…
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="instanceDetailContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<!-- æ§åˆ¶å°æ¨¡æ€æ¡† -->
<div class="modal fade" id="consoleModal" tabindex="-1">
    <div class="modal-dialog console-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-terminal me-2"></i>å®ä¾‹æ§åˆ¶å°
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="consoleFrame" class="console-iframe" src="about:blank"></iframe>
            </div>
        </div>
    </div>
</div>

<!-- æ“ä½œç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>ç¡®è®¤æ“ä½œ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="actionMessage">æ‚¨ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
                <div id="actionOptions" style="display: none;">
                    <label class="form-label">é‡å¯ç±»å‹:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="restartType" id="softRestart" value="soft" checked>
                        <label class="form-check-label" for="softRestart">è½¯é‡å¯ (æ¨è)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="restartType" id="hardRestart" value="hard">
                        <label class="form-check-label" for="hardRestart">ç¡¬é‡å¯</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn" onclick="confirmAction()">ç¡®è®¤</button>
            </div>
        </div>
    </div>
</div>

<!-- é‡å‘½åå®ä¾‹æ¨¡æ€æ¡† -->
<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>é‡å‘½åå®ä¾‹
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="renameForm">
                    <div class="mb-3">
                        <label class="form-label">å½“å‰åç§°</label>
                        <input type="text" class="form-control" id="currentName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ–°åç§° *</label>
                        <input type="text" class="form-control" id="newName" required placeholder="è¯·è¾“å…¥æ–°çš„å®ä¾‹åç§°">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmRename()">ç¡®è®¤é‡å‘½å</button>
            </div>
        </div>
    </div>
</div>

<!-- é”€æ¯æ—¶é—´è®¾ç½®æ¨¡æ€æ¡† -->
<div class="modal fade" id="destroyTimerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clock me-2"></i>è®¾ç½®é”€æ¯æ—¶é—´
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="destroyTimerForm">
                    <div class="mb-3">
                        <label class="form-label">å®ä¾‹åç§°</label>
                        <input type="text" class="form-control" id="destroyInstanceName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">é”€æ¯æ—¶é—´ *</label>
                        <input type="datetime-local" class="form-control" id="destroyDateTime" required>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>è­¦å‘Šï¼š</strong>å®ä¾‹å°†åœ¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨é”€æ¯ï¼Œæ­¤æ“ä½œä¸å¯é€†ï¼
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" onclick="confirmDestroyTimer()">è®¾ç½®é”€æ¯æ—¶é—´</button>
            </div>
        </div>
    </div>
</div>

<!-- æ‰¹é‡æ“ä½œç»“æœæ¨¡æ€æ¡† -->
<div class="modal fade" id="batchResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tasks me-2"></i>æ‰¹é‡æ“ä½œç»“æœ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="batchResultContent">
                    <!-- ç»“æœå†…å®¹å°†é€šè¿‡JavaScriptå¡«å…… -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/instances-enhanced.js') }}"></script>
<script>
    let currentClusterId = null;
    let currentPage = 1;
    let currentFilters = {};
    let isLoading = false;
    let searchTimeout = null;
    let pendingAction = null;
    let selectedInstances = new Set();
    let isBatchMode = false;
    let currentView = 'card'; // 'card' or 'table'
    let currentRenameInstance = null;
    let expireCheckInterval = null;
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadClusters();
        startExpireCheck();
    });

    // åŠ è½½é›†ç¾¤åˆ—è¡¨
    async function loadClusters() {
        try {
            const response = await fetch('/api/clusters');
            const data = await response.json();
            
            if (data.success) {
                const select = document.getElementById('clusterSelect');
                select.innerHTML = '<option value="">æ‰€æœ‰é›†ç¾¤</option>';
                
                let firstConnectedCluster = null;
                
                data.data.forEach(cluster => {
                    const option = document.createElement('option');
                    option.value = cluster.id;
                    option.textContent = `${cluster.name} (${cluster.connection_status})`;
                    if (cluster.connection_status !== 'connected') {
                        option.disabled = true;
                        option.textContent += ' - è¿æ¥å¤±è´¥';
                    } else if (!firstConnectedCluster) {
                        firstConnectedCluster = cluster;
                    }
                    select.appendChild(option);
                });
                
                // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨é›†ç¾¤
                if (firstConnectedCluster) {
                    select.value = firstConnectedCluster.id;
                    currentClusterId = firstConnectedCluster.id;
                    onClusterChange();
                }
            }
        } catch (error) {
            console.error('Error loading clusters:', error);
            showAlert('åŠ è½½é›†ç¾¤åˆ—è¡¨å¤±è´¥', 'danger');
        }
    }

    // é›†ç¾¤é€‰æ‹©å˜åŒ–
    function onClusterChange() {
        const select = document.getElementById('clusterSelect');
        const selectedValue = select.value;
        currentClusterId = selectedValue ? parseInt(selectedValue) : null;
        
        // æ˜¾ç¤ºç›¸å…³ç•Œé¢å…ƒç´ 
        document.getElementById('filterSection').style.display = 'block';
        document.getElementById('instancesCard').style.display = 'block';
        document.getElementById('batchOperationBtn').style.display = 'inline-block';
        document.getElementById('exportBtn').style.display = 'inline-block';
        currentPage = 1;
        
        // æ ¹æ®é€‰æ‹©çš„é›†ç¾¤ç±»å‹åŠ è½½å®ä¾‹
        if (selectedValue === '') {
            // é€‰æ‹©"æ‰€æœ‰é›†ç¾¤"
            loadAllClustersInstances();
        } else {
            // é€‰æ‹©ç‰¹å®šé›†ç¾¤
            loadInstances();
            // é€‰æ‹©é›†ç¾¤åç«‹å³æ£€æŸ¥åˆ°æœŸå®ä¾‹
            setTimeout(() => checkExpiredInstances(), 1000);
        }
    }

    // åŠ è½½æ‰€æœ‰é›†ç¾¤çš„å®ä¾‹åˆ—è¡¨
    async function loadAllClustersInstances(page = 1) {
        if (isLoading) return;
        
        showLoading(true);
        
        try {
            const params = new URLSearchParams({
                page: page,
                per_page: document.getElementById('perPageSelect').value
            });
            
            // æ·»åŠ è¿‡æ»¤å‚æ•°
            const status = document.getElementById('statusFilter').value;
            const search = document.getElementById('searchInput').value;
            const expireFilter = document.getElementById('expireFilter').value;
            
            if (status) params.append('status', status);
            if (search) params.append('search', search);
            if (expireFilter) params.append('expire_filter', expireFilter);
            
            const response = await fetch(`/api/instances/all-clusters?${params}`);
            const data = await response.json();
            
            if (data.success) {
                renderInstances(data.data);
                renderPagination(data.pagination);
                updateStats(data.statistics);
                currentPage = page;
            } else {
                showAlert('åŠ è½½å®ä¾‹å¤±è´¥: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Error loading all cluster instances:', error);
            showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥', 'danger');
        } finally {
            showLoading(false);
        }
    }

    // åŠ è½½å®ä¾‹åˆ—è¡¨
    async function loadInstances(page = 1) {
        if (!currentClusterId || isLoading) return;
        
        showLoading(true);
        
        try {
            const params = new URLSearchParams({
                cluster_id: currentClusterId,
                page: page,
                per_page: document.getElementById('perPageSelect').value
            });
            
            // æ·»åŠ è¿‡æ»¤å‚æ•°
            const status = document.getElementById('statusFilter').value;
            const search = document.getElementById('searchInput').value;
            const expireFilter = document.getElementById('expireFilter').value;
            
            if (status) params.append('status', status);
            if (search) params.append('search', search);
            if (expireFilter) params.append('expire_filter', expireFilter);
            
            const response = await fetch(`/api/instances?${params}`);
            const data = await response.json();
            
            if (data.success) {
                renderInstances(data.data);
                renderPagination(data.pagination);
                updateStats(data.statistics);
                currentPage = page;
            } else {
                showAlert('åŠ è½½å®ä¾‹å¤±è´¥: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Error loading instances:', error);
            showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥', 'danger');
        } finally {
            showLoading(false);
        }
    }

    // æ¸²æŸ“å®ä¾‹åˆ—è¡¨
    function renderInstances(instances) {
        const emptyState = document.getElementById('emptyState');
        const instanceCount = document.getElementById('instanceCount');
        
        instanceCount.textContent = instances.length;
        
        if (instances.length === 0) {
            if (currentView === 'card') {
                document.getElementById('instancesContainer').innerHTML = '';
            } else {
                document.getElementById('instancesTableBody').innerHTML = `<tr><td colspan="${isBatchMode ? '8' : '7'}" class="text-center text-muted">æ²¡æœ‰æ‰¾åˆ°å®ä¾‹</td></tr>`;
            }
            emptyState.style.display = 'block';
            return;
        }
        
        emptyState.style.display = 'none';
        
        if (currentView === 'table') {
            renderInstanceTable(instances);
            return;
        }
        
        // å¡ç‰‡è§†å›¾æ¸²æŸ“
        const container = document.getElementById('instancesContainer');
        container.innerHTML = instances.map(instance => `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card instance-card status-${instance.status.toLowerCase()} ${selectedInstances.has(instance.id) ? 'border-primary' : ''}" data-instance-id="${instance.id}">
                    ${isBatchMode ? `
                    <div class="card-header d-flex align-items-center">
                        <input type="checkbox" class="form-check-input instance-checkbox me-2" value="${instance.id}" 
                               ${selectedInstances.has(instance.id) ? 'checked' : ''} 
                               onchange="toggleInstanceSelection('${instance.id}')">
                        <h6 class="mb-0 flex-grow-1">
                            <i class="fas fa-server me-2"></i>
                            ${instance.name}
                        </h6>
                        <div class="instance-actions">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="viewInstanceDetail('${instance.id}')">
                                        <i class="fas fa-eye me-2"></i>æŸ¥çœ‹è¯¦æƒ…
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="openConsole('${instance.id}')">
                                        <i class="fas fa-terminal me-2"></i>æ§åˆ¶å°
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="renameInstance('${instance.id}', '${instance.name}')">
                                        <i class="fas fa-edit me-2"></i>é‡å‘½å
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setDestroyTimer('${instance.id}', '${instance.name}')">
                                        <i class="fas fa-clock me-2 text-warning"></i>è®¾ç½®é”€æ¯æ—¶é—´
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    ${getActionMenuItems(instance)}
                                </ul>
                            </div>
                        </div>
                    </div>
                    ` : `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-server me-2"></i>
                            ${instance.name}
                        </h6>
                        <div class="instance-actions">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="viewInstanceDetail('${instance.id}')">
                                        <i class="fas fa-eye me-2"></i>æŸ¥çœ‹è¯¦æƒ…
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="openConsole('${instance.id}')">
                                        <i class="fas fa-terminal me-2"></i>æ§åˆ¶å°
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="renameInstance('${instance.id}', '${instance.name}')">
                                        <i class="fas fa-edit me-2"></i>é‡å‘½å
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setDestroyTimer('${instance.id}', '${instance.name}')">
                                        <i class="fas fa-clock me-2 text-warning"></i>è®¾ç½®é”€æ¯æ—¶é—´
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    ${getActionMenuItems(instance)}
                                </ul>
                            </div>
                        </div>
                    </div>
                    `}
                    <div class="card-body">
                        <div class="mb-2">
                            <span class="badge status-badge ${getStatusClass(instance.status)}">
                                ${getStatusText(instance.status)}
                            </span>
                            <span class="badge bg-secondary ms-1">${instance.flavor.name}</span>
                            ${instance.cluster_name ? `<span class="badge bg-info ms-1">${instance.cluster_name}</span>` : ''}
                        </div>
                        
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-hdd me-1"></i>
                                é•œåƒ: ${instance.image.name}
                            </small>
                        </div>
                        
                        ${getInstanceIPs(instance.addresses)}
                        
                        ${instance.metadata && instance.metadata.destroy_at ? 
                            `<div class="mb-2">
                                <small class="${getExpireStatusClass(instance.expire_status)}">
                                    <i class="fas fa-clock me-1"></i>
                                    é”€æ¯: ${formatTime(instance.metadata.destroy_at)}
                                    ${getExpireStatusBadge(instance.expire_status)}
                                </small>
                            </div>` : ''
                        }
                        
                        <hr>
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            åˆ›å»º: ${formatTime(instance.created)}
                        </small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // è·å–çŠ¶æ€æ ·å¼ç±»
    function getStatusClass(status) {
        const classes = {
            'ACTIVE': 'bg-success',
            'SHUTOFF': 'bg-danger',
            'SUSPENDED': 'bg-warning',
            'PAUSED': 'bg-info',
            'ERROR': 'bg-danger',
            'BUILD': 'bg-primary',
            'REBOOT': 'bg-warning'
        };
        return classes[status] || 'bg-secondary';
    }

    // è·å–çŠ¶æ€æ–‡æœ¬
    function getStatusText(status) {
        const texts = {
            'ACTIVE': 'è¿è¡Œä¸­',
            'SHUTOFF': 'å·²åœæ­¢',
            'SUSPENDED': 'å·²æŒ‚èµ·',
            'PAUSED': 'å·²æš‚åœ',
            'ERROR': 'é”™è¯¯',
            'BUILD': 'æ„å»ºä¸­',
            'REBOOT': 'é‡å¯ä¸­'
        };
        return texts[status] || status;
    }

    // è·å–å®ä¾‹IPåœ°å€æ˜¾ç¤º
    function getInstanceIPs(addresses) {
        if (!addresses || Object.keys(addresses).length === 0) {
            return '<div class="instance-ip">æ— ç½‘ç»œè¿æ¥</div>';
        }
        
        let ipHtml = '';
        for (const [network, ips] of Object.entries(addresses)) {
            ips.forEach(ip => {
                ipHtml += `<div class="instance-ip">
                    <i class="fas fa-network-wired me-1"></i>
                    ${network}: ${ip.addr}
                </div>`;
            });
        }
        return ipHtml;
    }

    // è·å–æ“ä½œèœå•é¡¹
    function getActionMenuItems(instance) {
        const status = instance.status;
        let items = [];
        
        if (status === 'SHUTOFF') {
            items.push('<li><a class="dropdown-item" href="#" onclick="performAction(\'' + instance.id + '\', \'start\', \'' + instance.name + '\')"><i class="fas fa-play me-2 text-success"></i>å¯åŠ¨</a></li>');
        }
        
        if (status === 'ACTIVE') {
            items.push('<li><a class="dropdown-item" href="#" onclick="performAction(\'' + instance.id + '\', \'stop\', \'' + instance.name + '\')"><i class="fas fa-stop me-2 text-danger"></i>åœæ­¢</a></li>');
            items.push('<li><a class="dropdown-item" href="#" onclick="performAction(\'' + instance.id + '\', \'restart\', \'' + instance.name + '\')"><i class="fas fa-redo me-2 text-warning"></i>é‡å¯</a></li>');
        }
        
        if (status === 'ACTIVE') {
            items.push('<li><a class="dropdown-item" href="#" onclick="performAction(\'' + instance.id + '\', \'pause\', \'' + instance.name + '\')"><i class="fas fa-pause me-2 text-info"></i>æš‚åœ</a></li>');
            items.push('<li><a class="dropdown-item" href="#" onclick="performAction(\'' + instance.id + '\', \'suspend\', \'' + instance.name + '\')"><i class="fas fa-moon me-2 text-warning"></i>æŒ‚èµ·</a></li>');
        }
        
        if (status === 'PAUSED') {
            items.push('<li><a class="dropdown-item" href="#" onclick="performAction(\'' + instance.id + '\', \'unpause\', \'' + instance.name + '\')"><i class="fas fa-play me-2 text-success"></i>æ¢å¤</a></li>');
        }
        
        if (status === 'SUSPENDED') {
            items.push('<li><a class="dropdown-item" href="#" onclick="performAction(\'' + instance.id + '\', \'resume\', \'' + instance.name + '\')"><i class="fas fa-play me-2 text-success"></i>æ¢å¤</a></li>');
        }
        
        if (items.length > 0) {
            items.push('<li><hr class="dropdown-divider"></li>');
        }
        
        {% if current_user.has_role(['super_admin', 'admin']) %}
        items.push('<li><a class="dropdown-item text-danger" href="#" onclick="performAction(\'' + instance.id + '\', \'delete\', \'' + instance.name + '\')"><i class="fas fa-trash me-2"></i>åˆ é™¤</a></li>');
        {% endif %}
        
        return items.join('');
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats(stats) {
        document.getElementById('totalInstances').textContent = stats.total_instances;
        document.getElementById('activeInstances').textContent = stats.status_counts['ACTIVE'] || 0;
        document.getElementById('shutoffInstances').textContent = stats.status_counts['SHUTOFF'] || 0;
        
        // æ›´æ–°åˆ°æœŸçŠ¶æ€ç»Ÿè®¡
        if (stats.expire_counts) {
            document.getElementById('warningInstances').textContent = stats.expire_counts['warning'] || 0;
            document.getElementById('expiredInstances').textContent = stats.expire_counts['expired'] || 0;
            document.getElementById('normalInstances').textContent = stats.expire_counts['normal'] || 0;
            
            // å¦‚æœæœ‰åˆ°æœŸæˆ–å³å°†åˆ°æœŸçš„å®ä¾‹ï¼Œæ˜¾ç¤ºè­¦å‘Š
            showExpireWarning(stats.expire_counts);
        }
    }

    // é‡ç½®ç»Ÿè®¡ä¿¡æ¯
    function resetStats() {
        document.getElementById('totalInstances').textContent = '-';
        document.getElementById('activeInstances').textContent = '-';
        document.getElementById('shutoffInstances').textContent = '-';
        document.getElementById('warningInstances').textContent = '-';
        document.getElementById('expiredInstances').textContent = '-';
        document.getElementById('normalInstances').textContent = '-';
    }

    // åº”ç”¨è¿‡æ»¤å™¨
    function applyFilters() {
        currentPage = 1;
        const select = document.getElementById('clusterSelect');
        if (select.value === '') {
            loadAllClustersInstances();
        } else {
            loadInstances();
        }
    }

    // é˜²æŠ–æœç´¢
    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            applyFilters();
        }, 300);
    }

    // åˆ·æ–°å®ä¾‹åˆ—è¡¨
    function refreshInstances() {
        const select = document.getElementById('clusterSelect');
        if (select.value === '') {
            loadAllClustersInstances(currentPage);
        } else {
            if (!currentClusterId) {
                showAlert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé›†ç¾¤', 'warning');
                return;
            }
            loadInstances(currentPage);
        }
    }

    // æŸ¥çœ‹å®ä¾‹è¯¦æƒ…
    async function viewInstanceDetail(instanceId) {
        try {
            document.getElementById('instanceDetailContent').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('instanceDetailModal')).show();
            
            const response = await fetch(`/api/instances/${instanceId}?cluster_id=${currentClusterId}`);
            const data = await response.json();
            
            if (data.success) {
                renderInstanceDetail(data.data);
            } else {
                document.getElementById('instanceDetailContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        åŠ è½½å¤±è´¥: ${data.error}
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading instance detail:', error);
            document.getElementById('instanceDetailContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•
                </div>
            `;
        }
    }

    // æ¸²æŸ“å®ä¾‹è¯¦æƒ…
    function renderInstanceDetail(instance) {
        document.getElementById('instanceDetailContent').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>åŸºæœ¬ä¿¡æ¯</h6>
                    <table class="table table-sm">
                        <tr><td>åç§°</td><td>${instance.name}</td></tr>
                        <tr><td>ID</td><td><code>${instance.id}</code></td></tr>
                        <tr><td>çŠ¶æ€</td><td><span class="badge ${getStatusClass(instance.status)}">${getStatusText(instance.status)}</span></td></tr>
                        <tr><td>ç”µæºçŠ¶æ€</td><td>${instance.power_state}</td></tr>
                        <tr><td>å¯ç”¨åŒº</td><td>${instance.availability_zone || '-'}</td></tr>
                        <tr><td>ä¸»æœº</td><td>${instance.host || '-'}</td></tr>
                        <tr><td>åˆ›å»ºæ—¶é—´</td><td>${formatTime(instance.created)}</td></tr>
                        <tr><td>æ›´æ–°æ—¶é—´</td><td>${formatTime(instance.updated)}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>è§„æ ¼ä¿¡æ¯</h6>
                    <table class="table table-sm">
                        <tr><td>è§„æ ¼</td><td>${instance.flavor.name}</td></tr>
                        <tr><td>vCPU</td><td>${instance.flavor.vcpus}</td></tr>
                        <tr><td>å†…å­˜</td><td>${instance.flavor.ram} MB</td></tr>
                        <tr><td>ç£ç›˜</td><td>${instance.flavor.disk} GB</td></tr>
                        <tr><td>é•œåƒ</td><td>${instance.image.name}</td></tr>
                        <tr><td>å¯†é’¥å¯¹</td><td>${instance.key_name || '-'}</td></tr>
                        <tr><td>å®‰å…¨ç»„</td><td>${instance.security_groups.join(', ') || '-'}</td></tr>
                    </table>
                </div>
            </div>
            
            <h6 class="mt-3">ç½‘ç»œä¿¡æ¯</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr><th>ç½‘ç»œ</th><th>IPåœ°å€</th><th>ç±»å‹</th></tr>
                    </thead>
                    <tbody>
                        ${Object.entries(instance.addresses).map(([network, ips]) => 
                            ips.map(ip => `<tr><td>${network}</td><td>${ip.addr}</td><td>${ip['OS-EXT-IPS:type']}</td></tr>`).join('')
                        ).join('')}
                    </tbody>
                </table>
            </div>
            
            <h6 class="mt-3">æ§åˆ¶å°æ—¥å¿— (æœ€è¿‘50è¡Œ)</h6>
            <pre class="bg-dark text-light p-3" style="height: 200px; overflow-y: auto; font-size: 0.8rem;">${instance.console_log}</pre>
        `;
    }

    // æ‰§è¡Œå®ä¾‹æ“ä½œ
    function performAction(instanceId, action, instanceName) {
        pendingAction = {
            instanceId: instanceId,
            action: action,
            instanceName: instanceName
        };
        
        const actionMessages = {
            'start': `å¯åŠ¨å®ä¾‹ "${instanceName}"`,
            'stop': `åœæ­¢å®ä¾‹ "${instanceName}"`,
            'restart': `é‡å¯å®ä¾‹ "${instanceName}"`,
            'pause': `æš‚åœå®ä¾‹ "${instanceName}"`,
            'unpause': `æ¢å¤å®ä¾‹ "${instanceName}"`,
            'suspend': `æŒ‚èµ·å®ä¾‹ "${instanceName}"`,
            'resume': `æ¢å¤å®ä¾‹ "${instanceName}"`,
            'delete': `åˆ é™¤å®ä¾‹ "${instanceName}"ï¼Œæ­¤æ“ä½œä¸å¯é€†ï¼`
        };
        
        document.getElementById('actionMessage').textContent = `æ‚¨ç¡®å®šè¦${actionMessages[action]}å—ï¼Ÿ`;
        
        // æ˜¾ç¤ºé‡å¯é€‰é¡¹
        const actionOptions = document.getElementById('actionOptions');
        if (action === 'restart') {
            actionOptions.style.display = 'block';
        } else {
            actionOptions.style.display = 'none';
        }
        
        // è®¾ç½®ç¡®è®¤æŒ‰é’®æ ·å¼
        const confirmBtn = document.getElementById('confirmActionBtn');
        if (action === 'delete') {
            confirmBtn.className = 'btn btn-danger';
            confirmBtn.textContent = 'ç¡®è®¤åˆ é™¤';
        } else {
            confirmBtn.className = 'btn btn-primary';
            confirmBtn.textContent = 'ç¡®è®¤';
        }
        
        new bootstrap.Modal(document.getElementById('actionModal')).show();
    }

    // ç¡®è®¤æ“ä½œ
    async function confirmAction() {
        if (!pendingAction) return;
        
        const { instanceId, action, instanceName } = pendingAction;
        const modal = bootstrap.Modal.getInstance(document.getElementById('actionModal'));
        
        try {
            const requestData = { action: action };
            
            // é‡å¯æ“ä½œéœ€è¦æŒ‡å®šç±»å‹
            if (action === 'restart') {
                const restartType = document.querySelector('input[name="restartType"]:checked').value;
                requestData.restart_type = restartType;
            }
            
            const response = await fetch(`/api/instances/${instanceId}/action?cluster_id=${currentClusterId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert(data.message, 'success');
                modal.hide();
                
                // å»¶è¿Ÿåˆ·æ–°åˆ—è¡¨ä»¥æ˜¾ç¤ºçŠ¶æ€å˜åŒ–
                setTimeout(() => {
                    loadInstances(currentPage);
                }, 2000);
            } else {
                showAlert('æ“ä½œå¤±è´¥: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Error performing action:', error);
            showAlert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
        }
        
        pendingAction = null;
    }

    // æ‰“å¼€æ§åˆ¶å°
    async function openConsole(instanceId) {
        try {
            const response = await fetch(`/api/instances/${instanceId}/console?cluster_id=${currentClusterId}&type=vnc`);
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('consoleFrame').src = data.data.url;
                new bootstrap.Modal(document.getElementById('consoleModal')).show();
            } else {
                showAlert('æ‰“å¼€æ§åˆ¶å°å¤±è´¥: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Error opening console:', error);
            showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'danger');
        }
    }

    // å·¥å…·å‡½æ•°
    function showLoading(show) {
        const indicator = document.getElementById('loadingIndicator');
        const content = document.getElementById('instancesCard');
        
        if (show) {
            indicator.style.display = 'block';
            if (content) content.style.opacity = '0.5';
        } else {
            indicator.style.display = 'none';
            if (content) content.style.opacity = '1';
        }
        isLoading = show;
    }

    function formatTime(isoString) {
        if (!isoString) return '-';
        const date = new Date(isoString);
        return date.toLocaleString('zh-CN');
    }

    function showAlert(message, type) {
        // ç§»é™¤ç°æœ‰çš„alert
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const content = document.querySelector('main');
        content.insertBefore(alertDiv, content.firstChild);
        
        // è‡ªåŠ¨åˆ é™¤
        if (type !== 'info') {
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    }

    // æ¸²æŸ“åˆ†é¡µ
    function renderPagination(pagination) {
        const container = document.getElementById('paginationContainer');
        const ul = document.getElementById('pagination');

        if (pagination.pages <= 1) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'block';
        ul.innerHTML = '';

        // ä¸Šä¸€é¡µ
        if (pagination.has_prev) {
            ul.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadInstances(${pagination.page - 1})">ä¸Šä¸€é¡µ</a></li>`;
        }

        // é¡µç 
        for (let i = 1; i <= pagination.pages; i++) {
            const active = i === pagination.page ? 'active' : '';
            ul.innerHTML += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="loadInstances(${i})">${i}</a></li>`;
        }

        // ä¸‹ä¸€é¡µ
        if (pagination.has_next) {
            ul.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadInstances(${pagination.page + 1})">ä¸‹ä¸€é¡µ</a></li>`;
        }
    }

    // æ˜¾ç¤ºåˆ°æœŸè­¦å‘Š
    function showExpireWarning(expireCounts) {
        const expiredCount = expireCounts.expired || 0;
        const warningCount = expireCounts.warning || 0;
        
        if (expiredCount > 0) {
            showAlert(
                `ğŸ”¥ æ³¨æ„ï¼šæœ‰ ${expiredCount} ä¸ªå®ä¾‹å·²åˆ°æœŸï¼Œè¯·åŠæ—¶å¤„ç†ï¼<a href="#" onclick="document.getElementById('expireFilter').value='expired'; applyFilters();" class="alert-link ms-2">æŸ¥çœ‹å·²åˆ°æœŸå®ä¾‹</a>`,
                'danger'
            );
        } else if (warningCount > 0) {
            showAlert(
                `âš ï¸ æé†’ï¼šæœ‰ ${warningCount} ä¸ªå®ä¾‹å°†åœ¨24å°æ—¶å†…åˆ°æœŸï¼<a href="#" onclick="document.getElementById('expireFilter').value='warning'; applyFilters();" class="alert-link ms-2">æŸ¥çœ‹å³å°†åˆ°æœŸå®ä¾‹</a>`,
                'warning'
            );
        }
    }

    // è·å–åˆ°æœŸçŠ¶æ€æ ·å¼ç±»
    function getExpireStatusClass(expireStatus) {
        const classes = {
            'normal': 'text-muted',
            'warning': 'text-warning',
            'expired': 'text-danger'
        };
        return classes[expireStatus] || 'text-muted';
    }

    // è·å–åˆ°æœŸçŠ¶æ€å¾½ç« 
    function getExpireStatusBadge(expireStatus) {
        const badges = {
            'normal': '',
            'warning': '<span class="badge bg-warning ms-1">å³å°†åˆ°æœŸ</span>',
            'expired': '<span class="badge bg-danger ms-1">å·²åˆ°æœŸ</span>'
        };
        return badges[expireStatus] || '';
    }

    // å¯åŠ¨åˆ°æœŸæ£€æŸ¥
    function startExpireCheck() {
        // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡åˆ°æœŸå®ä¾‹
        expireCheckInterval = setInterval(() => {
            if (currentClusterId) {
                checkExpiredInstances();
            }
        }, 300000); // 5åˆ†é’Ÿ
        
        // é¡µé¢åˆ‡æ¢æ—¶ä¹Ÿæ£€æŸ¥ä¸€æ¬¡
        if (currentClusterId) {
            setTimeout(() => checkExpiredInstances(), 2000);
        }
    }

    // æ£€æŸ¥åˆ°æœŸå®ä¾‹
    async function checkExpiredInstances() {
        if (!currentClusterId) return;
        
        try {
            const response = await fetch(`/api/instances/check-expired?cluster_id=${currentClusterId}`);
            const data = await response.json();
            
            if (data.success) {
                const expiredCount = data.data.expired_count;
                const warningCount = data.data.warning_count;
                
                if (expiredCount > 0) {
                    // æ˜¾ç¤ºä¸¥é‡è­¦å‘Š - å·²åˆ°æœŸå®ä¾‹
                    showAlert(
                        `ğŸ”¥ ç´§æ€¥æé†’ï¼šå‘ç° ${expiredCount} ä¸ªå®ä¾‹å·²ç»åˆ°æœŸï¼è¯·ç«‹å³å¤„ç†ï¼<br>` +
                        `<button class="btn btn-sm btn-outline-light mt-1" onclick="document.getElementById('expireFilter').value='expired'; applyFilters();">` +
                        `<i class="fas fa-search me-1"></i>æŸ¥çœ‹å·²åˆ°æœŸå®ä¾‹</button>`,
                        'danger'
                    );
                    
                    // æ›´æ–°é¡µé¢æ ‡é¢˜æ˜¾ç¤ºè­¦å‘Š
                    document.title = `(${expiredCount}) å®ä¾‹ç®¡ç† - OpenStackè¿ç»´å¹³å°`;
                } else if (warningCount > 0) {
                    // æ˜¾ç¤ºè­¦å‘Š - å³å°†åˆ°æœŸå®ä¾‹
                    showAlert(
                        `âš ï¸ åˆ°æœŸæé†’ï¼šæœ‰ ${warningCount} ä¸ªå®ä¾‹å°†åœ¨24å°æ—¶å†…åˆ°æœŸï¼Œè¯·åŠæ—¶å¤„ç†ï¼<br>` +
                        `<button class="btn btn-sm btn-outline-dark mt-1" onclick="document.getElementById('expireFilter').value='warning'; applyFilters();">` +
                        `<i class="fas fa-search me-1"></i>æŸ¥çœ‹å³å°†åˆ°æœŸå®ä¾‹</button>`,
                        'warning'
                    );
                } else {
                    // é‡ç½®é¡µé¢æ ‡é¢˜
                    document.title = 'å®ä¾‹ç®¡ç† - OpenStackè¿ç»´å¹³å°';
                }
            }
        } catch (error) {
            console.error('æ£€æŸ¥åˆ°æœŸå®ä¾‹å¤±è´¥:', error);
        }
    }

    // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
    window.addEventListener('beforeunload', function() {
        if (expireCheckInterval) {
            clearInterval(expireCheckInterval);
        }
    });

    // ===============================================
    // å¢å¼ºåŠŸèƒ½å‡½æ•° - æ‰¹é‡æ“ä½œã€è§†å›¾åˆ‡æ¢ã€å¯¼å‡ºç­‰
    // ===============================================
    
    // è·å–IPåœ°å€çš„æ–‡æœ¬æ ¼å¼ï¼ˆä¾›è¡¨æ ¼è§†å›¾ä½¿ç”¨ï¼‰
    function getInstanceIPsText(addresses) {
        if (!addresses || Object.keys(addresses).length === 0) {
            return 'æ— ';
        }
        
        let ips = [];
        for (const [network, addrs] of Object.entries(addresses)) {
            addrs.forEach(addr => {
                ips.push(`${network}:${addr.addr}`);
            });
        }
        return ips.join('<br>');
    }

    // åˆ‡æ¢è§†å›¾æ¨¡å¼
    function toggleView() {
        const cardView = document.getElementById('cardView');
        const tableView = document.getElementById('tableView');
        const viewToggle = document.getElementById('viewToggle');
        const batchSelectHeader = document.getElementById('batchSelectHeader');
        
        if (currentView === 'card') {
            // åˆ‡æ¢åˆ°è¡¨æ ¼è§†å›¾
            cardView.style.display = 'none';
            tableView.style.display = 'block';
            viewToggle.innerHTML = '<i class="fas fa-table me-1"></i>è¡¨æ ¼è§†å›¾';
            currentView = 'table';
            
            // åœ¨è¡¨æ ¼è§†å›¾ä¸­æ˜¾ç¤ºæ‰¹é‡é€‰æ‹©
            if (isBatchMode) {
                batchSelectHeader.style.display = 'table-cell';
            }
            
            // é‡æ–°æ¸²æŸ“æ•°æ®ä¸ºè¡¨æ ¼æ ¼å¼
            loadInstances(currentPage);
        } else {
            // åˆ‡æ¢åˆ°å¡ç‰‡è§†å›¾
            cardView.style.display = 'block';
            tableView.style.display = 'none';
            viewToggle.innerHTML = '<i class="fas fa-th me-1"></i>å¡ç‰‡è§†å›¾';
            currentView = 'card';
            
            // é‡æ–°æ¸²æŸ“æ•°æ®ä¸ºå¡ç‰‡æ ¼å¼
            loadInstances(currentPage);
        }
    }

    // æ¸²æŸ“è¡¨æ ¼è§†å›¾
    function renderInstanceTable(instances) {
        const tbody = document.getElementById('instancesTableBody');
        
        if (instances.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${isBatchMode ? '9' : '8'}" class="text-center text-muted">æ²¡æœ‰æ‰¾åˆ°å®ä¾‹</td></tr>`;
            return;
        }
        
        tbody.innerHTML = instances.map(instance => `
            <tr data-instance-id="${instance.id}" ${selectedInstances.has(instance.id) ? 'class="table-active"' : ''}>
                ${isBatchMode ? `
                <td>
                    <input type="checkbox" class="instance-checkbox" value="${instance.id}" 
                           ${selectedInstances.has(instance.id) ? 'checked' : ''} 
                           onchange="toggleInstanceSelection('${instance.id}')">
                </td>
                ` : ''}
                <td>
                    <strong>${instance.name}</strong>
                    ${instance.metadata && instance.metadata.destroy_at ? 
                        `<br><small class="${getExpireStatusClass(instance.expire_status)}">
                            <i class="fas fa-clock"></i> é”€æ¯: ${formatTime(instance.metadata.destroy_at)}
                            ${getExpireStatusBadge(instance.expire_status)}
                        </small>` : ''
                    }
                </td>
                <td>
                    <span class="badge bg-info">
                        ${instance.cluster_name || 'æœªçŸ¥é›†ç¾¤'}
                    </span>
                </td>
                <td>
                    <span class="badge ${getStatusClass(instance.status)}">
                        ${getStatusText(instance.status)}
                    </span>
                </td>
                <td>${instance.flavor.name}</td>
                <td>${instance.image.name}</td>
                <td>${getInstanceIPsText(instance.addresses)}</td>
                <td>${formatTime(instance.created)}</td>
                <td>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="viewInstanceDetail('${instance.id}')">
                                <i class="fas fa-eye me-2"></i>æŸ¥çœ‹è¯¦æƒ…
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="openConsole('${instance.id}')">
                                <i class="fas fa-terminal me-2"></i>æ§åˆ¶å°
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="renameInstance('${instance.id}', '${instance.name}')">
                                <i class="fas fa-edit me-2"></i>é‡å‘½å
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="setDestroyTimer('${instance.id}', '${instance.name}')">
                                <i class="fas fa-clock me-2 text-warning"></i>è®¾ç½®é”€æ¯æ—¶é—´
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            ${getActionMenuItems(instance)}
                        </ul>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // åˆ‡æ¢æ‰¹é‡æ¨¡å¼
    function toggleBatchMode() {
        isBatchMode = !isBatchMode;
        
        const batchToolbar = document.getElementById('batchToolbar');
        const batchOperationBtn = document.getElementById('batchOperationBtn');
        const batchSelectHeader = document.getElementById('batchSelectHeader');
        
        if (isBatchMode) {
            batchToolbar.style.display = 'block';
            batchOperationBtn.innerHTML = '<i class="fas fa-times me-1"></i>é€€å‡ºæ‰¹é‡';
            batchOperationBtn.className = 'btn btn-outline-danger';
            
            if (currentView === 'table') {
                batchSelectHeader.style.display = 'table-cell';
            }
        } else {
            batchToolbar.style.display = 'none';
            batchOperationBtn.innerHTML = '<i class="fas fa-tasks me-1"></i>æ‰¹é‡æ“ä½œ';
            batchOperationBtn.className = 'btn btn-outline-primary';
            
            if (currentView === 'table') {
                batchSelectHeader.style.display = 'none';
            }
            
            // æ¸…é™¤é€‰æ‹©
            clearSelection();
        }
        
        // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        const select = document.getElementById('clusterSelect');
        if (select.value === '') {
            loadAllClustersInstances(currentPage);
        } else {
            loadInstances(currentPage);
        }
    }

    // åˆ‡æ¢å®ä¾‹é€‰æ‹©çŠ¶æ€
    function toggleInstanceSelection(instanceId) {
        if (selectedInstances.has(instanceId)) {
            selectedInstances.delete(instanceId);
        } else {
            selectedInstances.add(instanceId);
        }
        
        updateSelectedCount();
        updateSelectAllCheckbox();
        
        // æ›´æ–°è§†è§‰æ•ˆæœ
        const element = document.querySelector(`[data-instance-id="${instanceId}"]`);
        if (element) {
            if (selectedInstances.has(instanceId)) {
                if (currentView === 'card') {
                    element.classList.add('border-primary');
                } else {
                    element.classList.add('table-active');
                }
            } else {
                if (currentView === 'card') {
                    element.classList.remove('border-primary');
                } else {
                    element.classList.remove('table-active');
                }
            }
        }
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function selectAllInstances() {
        const checkboxes = document.querySelectorAll('.instance-checkbox');
        checkboxes.forEach(checkbox => {
            selectedInstances.add(checkbox.value);
            checkbox.checked = true;
        });
        
        updateSelectedCount();
        updateSelectAllCheckbox();
        
        // æ›´æ–°å¡ç‰‡æ ·å¼
        if (currentView === 'card') {
            document.querySelectorAll('.instance-card').forEach(card => {
                card.classList.add('border-primary');
            });
        } else {
            document.querySelectorAll('#instancesTableBody tr').forEach(row => {
                row.classList.add('table-active');
            });
        }
    }

    // æ¸…é™¤é€‰æ‹©
    function clearSelection() {
        selectedInstances.clear();
        
        // å–æ¶ˆæ‰€æœ‰å¤é€‰æ¡†é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.instance-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // ç§»é™¤å¡ç‰‡é«˜äº®
        document.querySelectorAll('.instance-card').forEach(card => {
            card.classList.remove('border-primary');
        });
        
        // ç§»é™¤è¡¨æ ¼è¡Œé«˜äº®
        document.querySelectorAll('#instancesTableBody tr').forEach(row => {
            row.classList.remove('table-active');
        });
        
        updateSelectedCount();
        updateSelectAllCheckbox();
    }

    // æ›´æ–°é€‰ä¸­æ•°é‡æ˜¾ç¤º
    function updateSelectedCount() {
        document.getElementById('selectedCount').textContent = `å·²é€‰æ‹© ${selectedInstances.size} ä¸ªå®ä¾‹`;
    }

    // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
    function updateSelectAllCheckbox() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (!selectAllCheckbox) return;
        
        const checkboxes = document.querySelectorAll('.instance-checkbox');
        
        if (checkboxes.length === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
            return;
        }
        
        const checkedCount = selectedInstances.size;
        
        if (checkedCount === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (checkedCount === checkboxes.length) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
        }
    }

    // å…¨é€‰å¤é€‰æ¡†åˆ‡æ¢
    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        
        if (selectAllCheckbox.checked) {
            selectAllInstances();
        } else {
            clearSelection();
        }
    }

    // æ‰¹é‡æ“ä½œ
    async function batchAction(action) {
        if (selectedInstances.size === 0) {
            showAlert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„å®ä¾‹', 'warning');
            return;
        }
        
        const instanceIds = Array.from(selectedInstances);
        const actionNames = {
            'start': 'å¯åŠ¨',
            'stop': 'åœæ­¢',
            'restart': 'é‡å¯',
            'delete': 'åˆ é™¤'
        };
        
        if (!confirm(`ç¡®å®šè¦${actionNames[action]} ${instanceIds.length} ä¸ªå®ä¾‹å—ï¼Ÿ`)) {
            return;
        }
        
        try {
            showLoading(true);
            
            // æ£€æŸ¥æ˜¯å¦åœ¨"æ‰€æœ‰é›†ç¾¤"æ¨¡å¼
            const select = document.getElementById('clusterSelect');
            const isAllClusters = (select.value === '');
            
            let response;
            if (isAllClusters) {
                // è·¨é›†ç¾¤æ‰¹é‡æ“ä½œ
                response = await fetch(`/api/instances/batch-action-cross-cluster`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        instance_ids: instanceIds,
                        action: action,
                        restart_type: action === 'restart' ? 'soft' : undefined
                    })
                });
            } else {
                // å•é›†ç¾¤æ‰¹é‡æ“ä½œ
                response = await fetch(`/api/instances/batch-action?cluster_id=${currentClusterId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        instance_ids: instanceIds,
                        action: action,
                        restart_type: action === 'restart' ? 'soft' : undefined
                    })
                });
            }
            
            const data = await response.json();
            
            if (data.success) {
                showBatchResults(data);
                clearSelection();
                
                // å»¶è¿Ÿåˆ·æ–°åˆ—è¡¨
                setTimeout(() => {
                    if (isAllClusters) {
                        loadAllClustersInstances(currentPage);
                    } else {
                        loadInstances(currentPage);
                    }
                }, 2000);
            } else {
                showAlert('æ‰¹é‡æ“ä½œå¤±è´¥: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Batch operation error:', error);
            showAlert('æ‰¹é‡æ“ä½œå‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•', 'danger');
        } finally {
            showLoading(false);
        }
    }

    // æ˜¾ç¤ºæ‰¹é‡æ“ä½œç»“æœ
    function showBatchResults(data) {
        let resultHtml = `
            <div class="alert alert-info">
                <h6>æ“ä½œæ±‡æ€»</h6>
                <p>æˆåŠŸ: ${data.success_count}/${data.total_count}</p>
            </div>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>å®ä¾‹åç§°</th>
                            <th>çŠ¶æ€</th>
                            <th>æ¶ˆæ¯</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        data.results.forEach(result => {
            const statusClass = result.success ? 'text-success' : 'text-danger';
            const statusIcon = result.success ? 'fas fa-check' : 'fas fa-times';
            const clusterInfo = result.cluster_name ? ` (${result.cluster_name})` : '';
            resultHtml += `
                <tr>
                    <td>${result.instance_name}${clusterInfo}</td>
                    <td><i class="${statusIcon} ${statusClass}"></i></td>
                    <td class="${statusClass}">${result.success ? result.message : result.error}</td>
                </tr>
            `;
        });
        
        resultHtml += '</tbody></table></div>';
        
        document.getElementById('batchResultContent').innerHTML = resultHtml;
        new bootstrap.Modal(document.getElementById('batchResultModal')).show();
    }

    // å¯¼å‡ºå®ä¾‹åˆ°Excel
    async function exportInstances() {
        if (!currentClusterId) {
            showAlert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé›†ç¾¤', 'warning');
            return;
        }
        
        try {
            showLoading(true);
            
            const exportData = {
                export_all: selectedInstances.size === 0,
                instance_ids: selectedInstances.size > 0 ? Array.from(selectedInstances) : []
            };
            
            const response = await fetch(`/api/instances/export?cluster_id=${currentClusterId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(exportData)
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                
                // ä»å“åº”å¤´è·å–æ–‡ä»¶å
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'instances_export.xlsx';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert('Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸ', 'success');
            } else {
                const data = await response.json();
                showAlert('å¯¼å‡ºå¤±è´¥: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Export error:', error);
            showAlert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
        } finally {
            showLoading(false);
        }
    }

    // é‡å‘½åå®ä¾‹
    function renameInstance(instanceId, currentName) {
        currentRenameInstance = { id: instanceId, name: currentName };
        
        document.getElementById('currentName').value = currentName;
        document.getElementById('newName').value = '';
        
        new bootstrap.Modal(document.getElementById('renameModal')).show();
    }

    // ç¡®è®¤é‡å‘½å
    async function confirmRename() {
        const newName = document.getElementById('newName').value.trim();
        
        if (!newName) {
            showAlert('è¯·è¾“å…¥æ–°çš„å®ä¾‹åç§°', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/api/instances/${currentRenameInstance.id}/rename?cluster_id=${currentClusterId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: newName
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('renameModal')).hide();
                loadInstances(currentPage);
            } else {
                showAlert('é‡å‘½åå¤±è´¥: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Rename error:', error);
            showAlert('é‡å‘½åå¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
        }
    }

    // è®¾ç½®é”€æ¯æ—¶é—´
    function setDestroyTimer(instanceId, instanceName) {
        currentRenameInstance = { id: instanceId, name: instanceName };
        
        document.getElementById('destroyInstanceName').value = instanceName;
        
        // è®¾ç½®é»˜è®¤æ—¶é—´ä¸º1å°æ—¶å
        const defaultTime = new Date();
        defaultTime.setHours(defaultTime.getHours() + 1);
        document.getElementById('destroyDateTime').value = defaultTime.toISOString().slice(0, 16);
        
        new bootstrap.Modal(document.getElementById('destroyTimerModal')).show();
    }

    // ç¡®è®¤è®¾ç½®é”€æ¯æ—¶é—´
    async function confirmDestroyTimer() {
        const destroyDateTime = document.getElementById('destroyDateTime').value;
        
        if (!destroyDateTime) {
            showAlert('è¯·é€‰æ‹©é”€æ¯æ—¶é—´', 'warning');
            return;
        }
        
        // æ£€æŸ¥æ—¶é—´æ˜¯å¦åœ¨æœªæ¥
        const destroyDate = new Date(destroyDateTime);
        if (destroyDate <= new Date()) {
            showAlert('é”€æ¯æ—¶é—´å¿…é¡»æ˜¯æœªæ¥æ—¶é—´', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/api/instances/${currentRenameInstance.id}/destroy-timer?cluster_id=${currentClusterId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    destroy_at: destroyDate.toISOString()
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('destroyTimerModal')).hide();
                loadInstances(currentPage);
            } else {
                showAlert('è®¾ç½®é”€æ¯æ—¶é—´å¤±è´¥: ' + data.error, 'danger');
            }
        } catch (error) {
            console.error('Destroy timer error:', error);
            showAlert('è®¾ç½®é”€æ¯æ—¶é—´å¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
        }
    }
</script>
{% endblock %}
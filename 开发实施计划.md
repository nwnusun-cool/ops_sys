# OpenStack运维平台 - 分阶段开发实施计划

## 🎯 总体开发策略

### 开发原则
- **渐进式重构**：保持现有功能正常运行，逐步替换
- **最小可用产品**：每个阶段都能独立运行和测试
- **向后兼容**：新版本保持对现有数据的兼容
- **测试优先**：每个功能开发前先写测试用例

### 技术栈选择
```python
# 后端
Flask 2.3.2 + SQLAlchemy + MySQL
Flask-Login (用户认证)
Flask-Migrate (数据库迁移)  
Redis (缓存，可选)

# 前端
Bootstrap 5 + jQuery 3.6
Chart.js (图表)
WebSocket (实时通信)
```

## 📋 Phase 1: 基础框架搭建（第1-2周）

### 🎯 目标
建立项目新的基础架构，实现用户认证和数据库重构

### 📅 第1周任务

#### 1.1 项目结构重构
**任务描述**：重新组织项目目录结构

**具体任务**：
```
ops_sys/
├── backend/
│   ├── app/
│   │   ├── __init__.py          # Flask应用工厂
│   │   ├── models/              # 数据模型
│   │   ├── auth/                # 认证蓝图
│   │   ├── api/                 # API蓝图
│   │   ├── admin/               # 管理界面
│   │   └── utils/               # 工具函数
│   ├── migrations/              # 数据库迁移
│   ├── config.py                # 配置文件
│   ├── requirements.txt         # 依赖
│   └── run.py                   # 启动文件
├── frontend/
│   ├── static/                  # 静态资源
│   └── templates/               # 模板文件
└── docs/                        # 文档
```

**交付物**：
- [ ] 新的目录结构
- [ ] Flask应用工厂模式
- [ ] 配置文件重构（支持多环境）

#### 1.2 数据库设计和迁移
**任务描述**：设计新的数据库结构，从SQLite迁移到MySQL

**数据库模型设计**：
```python
# backend/app/models/user.py
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password_hash = db.Column(db.String(255), nullable=False)
    role = db.Column(db.Enum('super_admin', 'admin', 'operator', 'viewer'))
    is_active = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    last_login = db.Column(db.DateTime)

# backend/app/models/cluster.py  
class OpenstackCluster(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), unique=True, nullable=False)
    description = db.Column(db.Text)
    auth_url = db.Column(db.String(255), nullable=False)
    credentials = db.Column(db.Text)  # JSON加密存储
    is_active = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

# backend/app/models/log.py
class OperationLog(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'))
    cluster_id = db.Column(db.Integer, db.ForeignKey('openstack_cluster.id'))
    operation_type = db.Column(db.String(50))  # create, delete, update
    resource_type = db.Column(db.String(50))   # instance, volume, etc
    resource_id = db.Column(db.String(255))
    details = db.Column(db.JSON)
    result = db.Column(db.Enum('success', 'failed'))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
```

**交付物**：
- [ ] 完整的数据库模型设计
- [ ] 数据库迁移脚本
- [ ] 现有数据迁移工具

### 📅 第2周任务

#### 1.3 用户认证系统
**任务描述**：实现完整的用户认证和权限管理

**具体功能**：
```python
# backend/app/auth/routes.py
@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    # 用户登录逻辑
    pass

@auth_bp.route('/logout')
@login_required  
def logout():
    # 退出登录
    pass

# backend/app/auth/decorators.py
def role_required(role):
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not current_user.has_role(role):
                abort(403)
            return f(*args, **kwargs)
        return decorated_function
    return decorator
```

**前端页面**：
- [ ] 登录页面 (`templates/auth/login.html`)
- [ ] 用户管理页面 (`templates/admin/users.html`)
- [ ] 角色权限配置页面

**交付物**：
- [ ] 用户认证API接口
- [ ] 权限控制装饰器
- [ ] 用户管理前端页面
- [ ] 登录/注册功能测试

#### 1.4 基础页面框架
**任务描述**：创建新的页面布局和导航

**页面结构**：
```html
<!-- templates/base.html -->
<!DOCTYPE html>
<html>
<head>
    <title>OpenStack运维平台</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <!-- 集群切换下拉菜单 -->
        <!-- 用户菜单 -->
    </nav>
    
    <!-- 侧边导航 -->
    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-2 d-md-block bg-light sidebar">
                <!-- 功能菜单 -->
            </nav>
            
            <!-- 主内容区域 -->  
            <main class="col-md-10 ms-sm-auto px-md-4">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
</body>
</html>
```

**交付物**：
- [ ] 响应式页面布局
- [ ] 导航菜单组件
- [ ] 面包屑导航
- [ ] 用户界面组件库

---

## 📋 Phase 2: 核心功能开发（第3-6周）

### 🎯 目标
实现OpenStack集群管理和实例管理的核心功能

### 📅 第3周任务

#### 2.1 集群管理模块
**任务描述**：重构现有的OpenStack连接管理

**后端API开发**：
```python
# backend/app/api/clusters.py
@api_bp.route('/clusters', methods=['GET'])
@login_required
@role_required('admin')
def list_clusters():
    # 获取集群列表
    pass

@api_bp.route('/clusters', methods=['POST']) 
@login_required
@role_required('admin')
def create_cluster():
    # 创建新集群
    pass

@api_bp.route('/clusters/<int:id>/test', methods=['POST'])
@login_required  
@role_required('admin')
def test_cluster_connection(id):
    # 测试集群连接
    pass
```

**前端页面开发**：
- [ ] 集群列表页面 (`templates/clusters/list.html`)
- [ ] 集群添加/编辑表单 (`templates/clusters/form.html`)
- [ ] 集群状态监控页面 (`templates/clusters/monitor.html`)

**交付物**：
- [ ] 集群管理API接口
- [ ] 集群配置加密存储
- [ ] 连接状态检测功能
- [ ] 集群管理前端界面

#### 2.2 重构现有OpenStack管理器
**任务描述**：优化现有的OpenStack客户端管理

**代码重构**：
```python
# backend/app/services/openstack_service.py
class OpenstackService:
    def __init__(self):
        self.clients = {}
        self.cache = {}
    
    def get_client(self, cluster_id, service_type='compute'):
        # 获取指定集群的客户端
        pass
    
    def refresh_cache(self, cluster_id, resource_type):
        # 刷新缓存
        pass
```

**交付物**：
- [ ] 重构后的OpenStack服务类
- [ ] 客户端连接池管理  
- [ ] 缓存策略优化
- [ ] 错误处理改进

### 📅 第4周任务

#### 2.3 实例管理模块重构
**任务描述**：升级现有实例管理功能

**API接口开发**：
```python
# backend/app/api/instances.py
@api_bp.route('/instances')
@login_required
def list_instances():
    cluster_id = request.args.get('cluster_id')
    # 分页、过滤、排序逻辑
    pass

@api_bp.route('/instances/<instance_id>/actions', methods=['POST'])
@login_required
@role_required('operator')  
@log_operation  # 操作日志装饰器
def instance_action(instance_id):
    action = request.json.get('action')
    # start, stop, reboot, delete等操作
    pass
```

**前端界面升级**：
- [ ] 实例列表页面重构 (`templates/instances/list.html`)
- [ ] 实例详情页面 (`templates/instances/detail.html`)
- [ ] 批量操作功能
- [ ] 实例创建向导

**交付物**：
- [ ] 重构实例管理API
- [ ] 批量操作功能
- [ ] 实例详情页面
- [ ] 操作确认对话框

### 📅 第5-6周任务

#### 2.4 卷管理模块
**任务描述**：完善卷管理功能

**功能开发**：
- [ ] 卷列表和详情API
- [ ] 卷创建/删除/扩容功能
- [ ] 卷挂载/卸载管理
- [ ] 卷快照功能

#### 2.5 操作日志系统
**任务描述**：实现完整的操作审计

**功能开发**：
```python
# backend/app/utils/log_decorator.py
def log_operation(operation_type, resource_type):
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            # 记录操作前状态
            result = f(*args, **kwargs)
            # 记录操作结果
            return result
        return decorated_function
    return decorator
```

---

## 📋 Phase 3: 扩展功能（第7-10周）

### 第7-8周：网络和快照管理
- [ ] 网络管理模块开发
- [ ] 安全组管理功能
- [ ] 快照管理重构

### 第9-10周：SSH和监控
- [ ] SSH连接管理升级
- [ ] Web终端功能（WebSocket）
- [ ] 基础监控仪表盘

---

## 📋 Phase 4: 优化完善（第11-14周）

### 第11-12周：高级功能
- [ ] 批量操作优化
- [ ] 数据导出功能
- [ ] 告警通知系统

### 第13-14周：性能和安全
- [ ] 性能优化和缓存策略
- [ ] 安全加固和代码审查
- [ ] 完整测试覆盖

---

## 🚀 开始第一步

根据这个计划，建议我们从**Phase 1 第1周**开始：

### 立即可以开始的任务：
1. **项目结构重构** - 创建新的目录结构
2. **数据库设计** - 设计用户和集群管理的数据模型
3. **基础配置** - 设置Flask应用工厂和配置管理

你希望从哪个具体任务开始？我可以：
1. **帮你重构项目结构** - 创建新的目录和基础文件
2. **设计数据库模型** - 编写SQLAlchemy模型和迁移脚本  
3. **实现用户认证** - 创建登录系统和权限控制
4. **优化现有代码** - 先修复当前版本的问题

你想从哪个开始？